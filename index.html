<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç« èŠ‚è¯¦æƒ…</title>
    <link href="css/style.css" type="text/css" rel="stylesheet" />
</head>

<body>
    <nav id="breadcrumb-nav" class="breadcrumb-nav"></nav>
    <header id="page-header" class="page-header"></header>
    <div id="content" onclick="handleContentClick(event)"></div>
    <footer id="page-footer">
        <button class="search-trigger" id="search-trigger">
            ğŸ”
        </button>
        <button class="index-manage" id="index-manage" onclick="showIndexManagement()" title="æœç´¢ç´¢å¼•ç®¡ç†">
            âš™ï¸
        </button>
        <button class="reading-settings" id="reading-settings" onclick="toggleSettings()" title="é˜…è¯»è®¾ç½®">
            ğŸ“–
        </button>
        <button class="totop" onclick="window.scrollTo({top: 0, behavior: 'smooth'});">
            &#8673;
        </button>
    </footer>

    <div id="floating-search-container" class="floating-search-container">
        <div class="floating-search-box">
            <div class="search-input-wrapper">
                <input type="text" id="search-input" placeholder="æœç´¢å†…å®¹..." />
                <button id="clear-search-button" class="clear-search-button" title="æ¸…é™¤æœç´¢å†…å®¹">âœ•</button>
            </div>
            <div class="floating-search-buttons">
                <button id="search-button">æœç´¢</button>
                <button id="close-search-button">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="floating-results-container" class="floating-results-container">
        <div id="search-results" class="search-results floating"></div>
    </div>

    <!-- è„šæ³¨å¼¹çª— -->
    <dialog id="footnote-dialog" class="footnote-dialog">
        <div class="footnote-dialog-header">
            <h4 id="footnote-title">è„šæ³¨</h4>
            <button class="footnote-close-btn" onclick="closeFootnoteDialog()">Ã—</button>
        </div>
        <div class="footnote-dialog-content" id="footnote-content">
            <!-- è„šæ³¨å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </dialog>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <h3>é˜…è¯»è®¾ç½®</h3>
                <button class="settings-close" onclick="toggleSettings()">Ã—</button>
            </div>

            <div class="settings-section">
                <h4>èƒŒæ™¯é¢œè‰²</h4>
                <div class="color-options">
                    <div class="color-option" data-bg="default" style="background: #ffffff; border: 2px solid #ddd;">
                        <span>é»˜è®¤</span>
                    </div>
                    <div class="color-option" data-bg="warm" style="background: #fdf6e3; border: 2px solid #ddd;">
                        <span>æŠ¤çœ¼</span>
                    </div>
                    <div class="color-option" data-bg="dark"
                        style="background: #2b2b2b; color: white; border: 2px solid #555;">
                        <span>æ·±è‰²</span>
                    </div>
                    <div class="color-option" data-bg="green" style="background: #f0f8f0; border: 2px solid #ddd;">
                        <span>ç»¿è‰²</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h4>å­—ä½“è®¾ç½®</h4>
                <div class="font-options">
                    <label>å­—ä½“å¤§å°ï¼š</label>
                    <input type="range" id="font-size-slider" min="16" max="30" value="20" step="1">
                    <span id="font-size-value">16px</span>
                </div>
                <div class="font-family-options">
                    <label>å­—ä½“ç±»å‹ï¼š</label>
                    <select id="font-family-select">
                        <option value="wenkai">éœé¹œæ–‡æ¥·ï¼ˆé»˜è®¤ï¼‰</option>
                        <option value="fangzhengkaiti">æ–¹æ­£æ¥·ä½“</option>
                        <option value="jinkai">ä»“è€³ä»Šæ¥·</option>
                        <option value="songkai">ä»“è€³å®‹æ¥·</option>
                        <option value="pingxianzhensong">å±æ˜¾è‡»å®‹</option>
                        <option value="huosong">å¯’è‰æ´»å®‹ä½“</option>
                        <option value="xiaobiaosong">æ–¹æ­£å°æ ‡å®‹</option>
                        <option value="huaxin">ä»“è€³åæ–°ä½“</option>
                        <option value="huohei">å¯’è‰æ´»é»‘ä½“</option>
                        <option value="pingyindingkai">æ‹¼éŸ³é¼æ¥·</option>
                    </select>
                </div>
                <div class="line-height-options">
                    <label>è¡Œé—´è·ï¼š</label>
                    <input type="range" id="line-height-slider" min="1.2" max="2.5" value="1.6" step="0.1">
                    <span id="line-height-value">1.6</span>
                </div>
            </div>

            <div class="settings-section page-settings">
                <h4>é¡µé¢è®¾ç½®</h4>
                <div class="width-options">
                    <label>å†…å®¹å®½åº¦ï¼š</label>
                    <input type="range" id="content-width-slider" min="600" max="1200" value="1200" step="50">
                    <span id="content-width-value">800px</span>
                </div>
            </div>

            <div class="settings-actions">
                <button onclick="resetSettings()" class="reset-btn">æ¢å¤é»˜è®¤</button>
                <button onclick="toggleSettings()" class="close-btn">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="js/marked.js"></script>
    <script>
        let currentChapter = "bob";
        const BOOKS_DIR = "./books/";
        let searchIndex = []; // å­˜å‚¨æ‰€æœ‰å¯æœç´¢å†…å®¹çš„ç´¢å¼•
        let bodyScrollDisabled = false; // è·Ÿè¸ªæ»šåŠ¨çŠ¶æ€
        let scrollY; // ä¿å­˜æ»šåŠ¨ä½ç½®
        let indexLoaded = false; // æ ‡è®°ç´¢å¼•æ˜¯å¦å·²åŠ è½½

        // è®¾ç½®ç›¸å…³å˜é‡
        let settingsVisible = false;

        // Safari æµè§ˆå™¨æ£€æµ‹å‡½æ•°
        function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        }
        const defaultSettings = {
            backgroundColor: 'default',
            fontSize: 16,
            fontFamily: 'wenkai',
            lineHeight: 1.6,
            contentWidth: 800
        };
        let currentSettings = { ...defaultSettings };

        const renderer = new marked.Renderer();
        renderer.heading = function ({ text, depth }) {
            if (depth === 1) {
                return ''; // ä¸ç”Ÿæˆä¸€çº§æ ‡é¢˜çš„ HTML
            }
            return `<h${depth} id="${text}">
            <a href="#${text}-${depth}">${text}</a>
        </h${depth}>`;
        };

        renderer.link = function (token) {
            const href = token.href;
            const title = token.title;
            const text = token.text;
            return `<a href="${href}" title="${title || ''}" target="_blank">${text}</a>`;
        };

        marked.use({ renderer });

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        function updatePageHeader(chapterName, subDir = "") {
            const headerDiv = document.getElementById("page-header");
            if (!headerDiv) return;

            // æ ¹æ®é¡µé¢å±‚çº§è®¾ç½®ä¸åŒæ ‡é¢˜
            if (chapterName === "bob") {
                // ç¬¬ä¸€çº§é¡µé¢ - ä¹¦æ¶
                headerDiv.style.display = 'block';
                headerDiv.innerHTML = '<div class="header-title">æˆ‘çš„ä¹¦æ¶</div>';
            } else if (chapterName === "toc") {
                // ç¬¬äºŒçº§é¡µé¢ - ä¹¦ç±ç›®å½•
                // è·å–æœ€åä¸€ä¸ªç›®å½•åä½œä¸ºå½“å‰ç›®å½•å
                const dirParts = subDir.split('/').filter(part => part); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
                const currentDirName = dirParts[dirParts.length - 1] || 'ä¹¦ç±ç›®å½•';
                headerDiv.style.display = 'block';
                headerDiv.innerHTML = `<div class="header-title">${currentDirName}</div>`;
            } else {
                // ç¬¬ä¸‰çº§é¡µé¢ - ç« èŠ‚å†…å®¹
                // ä»å½“å‰ç« èŠ‚å†…å®¹ä¸­è·å–æ ‡é¢˜

                const contentDiv = document.getElementById("content");
                if (contentDiv) {
                    const firstHeading = contentDiv.querySelector('h1, h2, h3, h4, h5, h6');
                    const title = firstHeading ? firstHeading.textContent : 'ç« èŠ‚å†…å®¹';
                    headerDiv.style.display = 'none';
                    headerDiv.innerHTML = `<div class="header-title">${title}</div>`;
                } else {
                    headerDiv.innerHTML = '<div class="header-title">ç« èŠ‚å†…å®¹</div>';
                }
            }
        }

        // è·å–ç« èŠ‚æ˜¾ç¤ºåç§°
        function getChapterDisplayName(chapterName) {
            const chapterNameMap = {
                'gm': 'çº²ç›®',
                'toc': 'ç›®å½•',
                'bob': 'ä¹¦æ¶'
            };
            return chapterNameMap[chapterName] || `ç¬¬${chapterName}ç« `;
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb(chapterName, subDir = "", chapterTitle = "") {
            const breadcrumbNav = document.getElementById("breadcrumb-nav");
            if (!breadcrumbNav) return;

            let breadcrumbHtml = '';

            if (chapterName === "bob") {
                // ä¹¦æ¶é¡µé¢ - ä¸æ˜¾ç¤ºé¢åŒ…å±‘
                breadcrumbNav.classList.remove('show');
                return;
            } else if (chapterName === "toc") {
                // ç›®å½•é¡µé¢
                const dirParts = subDir.split('/').filter(part => part);

                // æ·»åŠ ä¹¦æ¶é“¾æ¥
                breadcrumbHtml += '<a href="#" onclick="loadChapter(\'bob\', \'\')">é¦–é¡µ</a>';

                // æ·»åŠ æ‰€æœ‰å±‚çº§çš„ç›®å½•é“¾æ¥
                for (let i = 0; i < dirParts.length; i++) {
                    const partialPath = dirParts.slice(0, i + 1).join('/');
                    const dirName = dirParts[i];

                    if (i === dirParts.length - 1) {
                        // æœ€åä¸€çº§ï¼Œæ˜¾ç¤ºä¸ºå½“å‰é¡¹
                        breadcrumbHtml += `<span class="separator"> / </span><span class="current" title="${dirName}">${dirName}</span>`;
                    } else {
                        // ä¸­é—´å±‚çº§ï¼Œæ˜¾ç¤ºä¸ºå¯ç‚¹å‡»é“¾æ¥
                        breadcrumbHtml += `<span class="separator"> / </span><a href="#" onclick="loadSubDir('${partialPath}')">${dirName}</a>`;
                    }
                }
            } else {
                // ç« èŠ‚é¡µé¢
                const dirParts = subDir.split('/').filter(part => part);

                // æ·»åŠ ä¹¦æ¶é“¾æ¥
                breadcrumbHtml += '<a href="#" onclick="loadChapter(\'bob\', \'\')">é¦–é¡µ</a>';

                // æ·»åŠ æ‰€æœ‰å±‚çº§çš„ç›®å½•é“¾æ¥
                for (let i = 0; i < dirParts.length; i++) {
                    const partialPath = dirParts.slice(0, i + 1).join('/');
                    const dirName = dirParts[i];

                    // æ‰€æœ‰ç›®å½•å±‚çº§éƒ½æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»é“¾æ¥
                    breadcrumbHtml += `<span class="separator"> / </span><a href="#" onclick="loadSubDir('${partialPath}')">${dirName}</a>`;
                }

                // æ·»åŠ å½“å‰ç« èŠ‚
                const displayTitle = chapterTitle || getChapterDisplayName(chapterName);
                breadcrumbHtml += `<span class="separator"> / </span><span class="current" title="${displayTitle}">${displayTitle}</span>`;
            }

            breadcrumbNav.innerHTML = breadcrumbHtml;
            breadcrumbNav.classList.add('show');

            // ç§»åŠ¨ç«¯é¢åŒ…å±‘ä¼˜åŒ–
            optimizeMobileBreadcrumb();
        }

        async function loadChapter(chapterName, subDir = "", searchTerm = "", anchorId = "", lineNumber = 0, footnoteKey = "", sectionNumber = "") {
            const contentDiv = document.getElementById("content");
            if (!contentDiv) return;

            // é¡µé¢è·³è½¬æ—¶é‡ç½®æ»šåŠ¨ä½ç½®åˆ°é¡¶éƒ¨ï¼ˆé™¤éæœ‰ç‰¹å®šçš„é”šç‚¹å®šä½éœ€æ±‚ï¼‰
            if (!anchorId && !searchTerm) {
                window.scrollTo(0, 0);
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å­ç›®å½•
            currentChapter = chapterName;

            updateURL(chapterName, subDir, searchTerm, anchorId, lineNumber);
            // å…ˆæ›´æ–°åŸºæœ¬æ ‡é¢˜
            updatePageHeader(chapterName, subDir);
            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆªï¼ˆåˆå§‹æ›´æ–°ï¼Œç« èŠ‚æ ‡é¢˜ç¨åè·å–ï¼‰
            updateBreadcrumb(chapterName, subDir);

            try {
                contentDiv.innerHTML = "åŠ è½½ä¸­...";
                // æ ¹æ®é¡µé¢ç±»å‹è®¾ç½®æ ‡é¢˜
                if (chapterName === 'bob') {
                    document.title = 'æˆ‘çš„ä¹¦æ¶';
                } else if (chapterName === 'toc') {
                    // ä» subDir ä¸­æå–ä¹¦ç±åç§°
                    const bookName = subDir.split('/')[0];
                    document.title = bookName || 'ä¹¦ç±ç›®å½•';
                } else {
                    // è·å–å½“å‰ç« èŠ‚çš„æ ‡é¢˜
                    const normalizedSubDir = subDir ? (subDir.endsWith('/') ? subDir : subDir + '/') : '';
                    const url = `${BOOKS_DIR}${normalizedSubDir}${chapterName}.md`;

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const text = await response.text();
                        const tokens = marked.lexer(text);
                        // è·å–ç¬¬ä¸€ä¸ªæ ‡é¢˜ä½œä¸ºç« èŠ‚æ ‡é¢˜
                        const firstHeading = tokens.find(token => token.type === 'heading');
                        document.title = firstHeading ? firstHeading.text : getChapterDisplayName(chapterName);
                    } catch (error) {
                        // å¦‚æœè·å–æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çš„ç« èŠ‚æ˜¾ç¤ºåç§°
                        document.title = getChapterDisplayName(chapterName);
                    }
                }

                // ç¡®ä¿subDirä»¥/ç»“å°¾
                const normalizedSubDir = subDir ? (subDir.endsWith('/') ? subDir : subDir + '/') : '';
                const url = `${BOOKS_DIR}${normalizedSubDir}${chapterName}.md`;
                console.log('è¯·æ±‚çš„ URL:', url);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const markdown = await response.text();

                try {
                    if (!window.marked) {
                        throw new Error('marked.js æœªæ­£ç¡®åŠ è½½');
                    }

                    // æ®µè½çº§åˆ«è„šæ³¨å¤„ç†å‡½æ•°
                    function processFootnotes(markdownText) {
                        // æŒ‰ç©ºè¡Œåˆ†å‰²æˆå—
                        const blocks = markdownText.split(/\n\s*\n/);
                        const processedBlocks = [];
                        const allFootnotes = {}; // æ”¶é›†æ‰€æœ‰è„šæ³¨ä¿¡æ¯
                        let globalFootnoteId = 1;

                        let i = 0;
                        while (i < blocks.length) {
                            const block = blocks[i].trim();

                            if (block === '') {
                                processedBlocks.push('');
                                i++;
                                continue;
                            }

                            // æ£€æŸ¥æ˜¯å¦åŒ…å«è„šæ³¨å¼•ç”¨
                            const footnoteRefs = block.match(/\[\^([^\]]+)\]/g) || [];

                            if (footnoteRefs.length > 0) {
                                console.log(`\n=== å¤„ç†åŒ…å«è„šæ³¨çš„æ®µè½ ${Math.floor(i / 2) + 1} ===`);
                                console.log('æ®µè½å†…å®¹:', block.substring(0, 100) + '...');
                                console.log('è„šæ³¨å¼•ç”¨:', footnoteRefs);

                                // è¿™æ˜¯åŒ…å«è„šæ³¨çš„æ®µè½ï¼Œæ”¶é›†ç´§è·Ÿçš„è„šæ³¨å®šä¹‰
                                let processedParagraph = block;
                                const paragraphFootnotes = {};
                                let j = i + 1;

                                // æ”¶é›†ç´§è·Ÿçš„è„šæ³¨å®šä¹‰
                                while (j < blocks.length) {
                                    const nextBlock = blocks[j].trim();
                                    if (nextBlock === '') {
                                        j++;
                                        continue;
                                    }

                                    // æ£€æŸ¥æ˜¯å¦ä¸ºè„šæ³¨å®šä¹‰å—
                                    const footnoteLines = nextBlock.split('\n');
                                    let isFootnoteBlock = true;

                                    for (const line of footnoteLines) {
                                        if (line.trim() === '') continue;
                                        if (!line.match(/^\[\^([^\]]+)\]:/)) {
                                            isFootnoteBlock = false;
                                            break;
                                        }
                                    }

                                    if (isFootnoteBlock) {
                                        // è§£æè¿™ä¸ªè„šæ³¨å®šä¹‰å—
                                        console.log(`æ”¶é›†è„šæ³¨å®šä¹‰å— ${j}:`, nextBlock.substring(0, 100) + '...');

                                        for (const line of footnoteLines) {
                                            if (line.trim() === '') continue;
                                            const footnoteDefMatch = line.match(/^\[\^([^\]]+)\]:\s*(.*)$/);
                                            if (footnoteDefMatch) {
                                                const key = footnoteDefMatch[1];
                                                const content = footnoteDefMatch[2];
                                                paragraphFootnotes[key] = content;

                                                // æå–èŠ‚å·ä¿¡æ¯
                                                const sectionMatch = processedParagraph.match(/^(\d+[ä¸Šä¸­ä¸‹]?)\s+/);
                                                const sectionNumber = sectionMatch ? sectionMatch[1] : null;

                                                // æ·»åŠ åˆ°å…¨å±€è„šæ³¨é›†åˆ
                                                allFootnotes[key] = {
                                                    content: content,
                                                    sectionNumber: sectionNumber
                                                };

                                                console.log(`  æ”¶é›†åˆ°: [^${key}] = "${content.substring(0, 30)}..." (èŠ‚å·: ${sectionNumber})`);
                                            }
                                        }
                                        j++;
                                    } else {
                                        // é‡åˆ°éè„šæ³¨å®šä¹‰çš„å†…å®¹ï¼Œåœæ­¢æ”¶é›†
                                        break;
                                    }
                                }

                                console.log('è¯¥æ®µè½çš„è„šæ³¨æ˜ å°„:', Object.keys(paragraphFootnotes));

                                // å¤„ç†è¿™ä¸ªæ®µè½çš„è„šæ³¨
                                const footnoteKeys = [...new Set(footnoteRefs.map(ref => ref.match(/\[\^([^\]]+)\]/)[1]))];

                                // åˆ†æè„šæ³¨æ¨¡å¼
                                const isNumericPattern = footnoteKeys.every(key => /^\d+$/.test(key));
                                const isAlphaPattern = footnoteKeys.every(key => /^[a-zA-Z]$/.test(key));

                                // æå–æ®µè½å¼€å¤´çš„æ•°å­—å’Œå¯èƒ½çš„ä¸Šä¸­ä¸‹åç¼€ï¼ˆèŠ‚å·ï¼‰
                                const sectionMatch = processedParagraph.match(/^(\d+[ä¸Šä¸­ä¸‹]?)\s+/);
                                const sectionNumber = sectionMatch ? sectionMatch[1] : null;
                                console.log('èŠ‚å·:', sectionNumber);

                                if (isNumericPattern || isAlphaPattern) {
                                    // è‡ªåŠ¨é‡æ–°ç¼–å·æ¨¡å¼
                                    const sortedKeys = isNumericPattern
                                        ? footnoteKeys.sort((a, b) => parseInt(a) - parseInt(b))
                                        : footnoteKeys.sort();

                                    // ä¸ºæ¯ä¸ªè„šæ³¨åˆ†é…æ–°çš„æ˜¾ç¤ºç¼–å·ï¼ˆæ¯æ®µè½é‡æ–°å¼€å§‹ï¼‰
                                    const keyMapping = {};
                                    sortedKeys.forEach((originalKey, index) => {
                                        if (isNumericPattern) {
                                            keyMapping[originalKey] = (index + 1).toString();
                                        } else {
                                            keyMapping[originalKey] = String.fromCharCode(97 + index); // a, b, c...
                                        }
                                    });

                                    console.log('ç¼–å·æ˜ å°„:', keyMapping);

                                    // æ›¿æ¢è„šæ³¨å¼•ç”¨
                                    Object.entries(keyMapping).forEach(([originalKey, displayKey]) => {
                                        if (paragraphFootnotes[originalKey]) {
                                            const content = paragraphFootnotes[originalKey];
                                            const globalId = globalFootnoteId++;
                                            const regex = new RegExp(`\\[\\^${originalKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');

                                            processedParagraph = processedParagraph.replace(regex,
                                                `<sup><a href="#" id="fnref${globalId}" class="footnote-ref" data-footnote-content="${content.replace(/"/g, '&quot;')}" data-footnote-key="${displayKey}" data-paragraph-index="${Math.floor(i / 2) + 1}" data-section-number="${sectionNumber || ''}" onclick="showFootnoteDialog(event, this)">${displayKey}</a></sup>`
                                            );
                                            console.log(`  æ›¿æ¢ [^${originalKey}] â†’ ${displayKey}`);
                                        } else {
                                            console.log(`  âŒ æœªæ‰¾åˆ°è„šæ³¨å†…å®¹: [^${originalKey}]`);
                                        }
                                    });
                                } else {
                                    // ä¿æŒåŸå§‹å‘½åæ¨¡å¼
                                    footnoteKeys.forEach(originalKey => {
                                        if (paragraphFootnotes[originalKey]) {
                                            const content = paragraphFootnotes[originalKey];
                                            const globalId = globalFootnoteId++;
                                            const regex = new RegExp(`\\[\\^${originalKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');

                                            processedParagraph = processedParagraph.replace(regex,
                                                `<sup><a href="#" id="fnref${globalId}" class="footnote-ref" data-footnote-content="${content.replace(/"/g, '&quot;')}" data-footnote-key="${originalKey}" data-paragraph-index="${Math.floor(i / 2) + 1}" data-section-number="${sectionNumber || ''}" onclick="showFootnoteDialog(event, this)">${originalKey}</a></sup>`
                                            );
                                            console.log(`  æ›¿æ¢ [^${originalKey}] â†’ ${originalKey}`);
                                        } else {
                                            console.log(`  âŒ æœªæ‰¾åˆ°è„šæ³¨å†…å®¹: [^${originalKey}]`);
                                        }
                                    });
                                }

                                processedBlocks.push(processedParagraph);
                                i = j; // è·³è¿‡å·²å¤„ç†çš„è„šæ³¨å®šä¹‰å—
                            } else {
                                // æ™®é€šæ®µè½ï¼Œç›´æ¥æ·»åŠ 
                                processedBlocks.push(block);
                                i++;
                            }
                        }

                        return {
                            markdownText: processedBlocks.join('\n\n'),
                            footnotes: allFootnotes
                        };
                    }



                    // ç”Ÿæˆè„šæ³¨HTMLï¼ˆç°åœ¨é»˜è®¤ä¸æ˜¾ç¤ºï¼Œä¿ç•™å‡½æ•°ä»¥å¤‡å°†æ¥ä½¿ç”¨ï¼‰
                    function generateFootnotesHTML(footnotes, showFootnotes = false) {
                        // ç°åœ¨è„šæ³¨åªåœ¨å¼¹çª—ä¸­æ˜¾ç¤ºï¼Œé¡µé¢åº•éƒ¨é»˜è®¤ä¸æ˜¾ç¤º
                        return '';
                    }

                    // å¤„ç†è„šæ³¨
                    const { markdownText: processedMarkdown, footnotes } = processFootnotes(markdown);
                    console.log(`å¤„ç†äº† ${Object.keys(footnotes).length} ä¸ªè„šæ³¨`);

                    const tokens = marked.lexer(processedMarkdown);
                    const tocHtml = generateTOC(tokens);

                    // ä½¿ç”¨markedçš„æ‰©å±•åŠŸèƒ½æ¥å¤„ç†å›¾ç‰‡è·¯å¾„
                    const imageExtension = {
                        name: 'image',
                        renderer(token) {
                            let href = token.href;
                            const title = token.title;
                            const text = token.text;

                            // // å¤„ç†ç›¸å¯¹è·¯å¾„
                            // if (!href.startsWith('http') && !href.startsWith('/') && !href.startsWith('data:')) {
                            //   // æ„å»ºæ­£ç¡®çš„å›¾ç‰‡è·¯å¾„
                            //   const basePath = subDir ? `./books/${subDir}/` : './books/';
                            //   href = basePath + href;
                            // }

                            // ä¿®å¤å›¾ç‰‡è·¯å¾„å¤„ç†é€»è¾‘
                            const relPrefixes = ['http', 'https', 'data:', '//', '/', '#'];
                            if (!relPrefixes.some(prefix => href.startsWith(prefix))) {
                                const basePath = subDir ? `books/${subDir}` : 'books';
                                if (href.startsWith('./')) {
                                    // ç›¸å¯¹è·¯å¾„ï¼š./img/da1.png -> books/è¯—æ­Œåˆè¾‘/å¤§æœ¬è¯—æ­Œ/img/da1.png
                                    href = `${basePath}${href.substring(1)}`;
                                } else {
                                    // ç›´æ¥è·¯å¾„ï¼šimg/da1.png -> books/è¯—æ­Œåˆè¾‘/å¤§æœ¬è¯—æ­Œ/img/da1.png
                                    href = `${basePath}/${href}`;
                                }
                            }

                            // ç”Ÿæˆå›¾ç‰‡HTMLï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                            let html = `<img src="${href}" alt="${text || ''}"`;

                            if (title) {
                                html += ` title="${title}"`;
                            }

                            // æ·»åŠ æ ·å¼å’Œé”™è¯¯å¤„ç†
                            html += ` style="max-width: 100%; height: auto;" loading="lazy"`;
                            html += ` onerror="this.style.display='none'; console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src);"`;
                            html += `>`;

                            return html;
                        }
                    };

                    // ä¸´æ—¶ä½¿ç”¨æ‰©å±•
                    marked.use({ extensions: [imageExtension] });

                    // è§£æå†…å®¹
                    let contentHtml = marked.parse(processedMarkdown);

                    // è„šæ³¨åªåœ¨å¼¹çª—ä¸­æ˜¾ç¤ºï¼Œä¸åœ¨é¡µé¢åº•éƒ¨æ˜¾ç¤º

                    // é‡ç½®markedé…ç½®ï¼ˆé¿å…å½±å“å…¶ä»–åœ°æ–¹ï¼‰
                    marked.use({ extensions: [] });

                    // æå–ä¸€çº§æ ‡é¢˜å†…å®¹
                    let mainTitle = '';
                    tokens.some((token) => {
                        if (token.type === "heading" && token.depth === 1) {
                            mainTitle = `<h1 id="${token.text}">${token.text}</h1>`;
                            return true;
                        }
                        return false;
                    });

                    // å®šä¹‰å¯¼èˆªæ ï¼Œé¦–é¡µå’ŒäºŒçº§ç›®å½•ä¸æ˜¾ç¤º
                    let navButtons = '';
                    // æ£€æŸ¥æ˜¯å¦æœ‰å­ç›®å½•
                    console.log('chapterName:', chapterName !== "bob");
                    console.log('subDir:', subDir);
                    if (chapterName !== "bob" && chapterName !== "toc") {
                        navButtons = `
            <div class="navigation">
              <a href="#" onclick="prevChapter('${subDir}')">&#11013;å¾€å‰</a><a href="#" onclick="nextChapter('${subDir}')">å¾€å&#10145;</a>
            </div>
          `;
                        // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        console.log('navButtonså·²ç”Ÿæˆ:', navButtons);
                    } else {
                        // ç›®å½•é¡µé¢å’Œä¹¦æ¶é¡µé¢ä¸æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
                        navButtons = '';
                        console.log('ä¸æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®');
                    }

                    // åªåœ¨ébobå’Œétocé¡µé¢æ˜¾ç¤ºç›®å½•
                    const tocDiv = (chapterName !== "bob" && chapterName !== "toc") ? `<div class="toc">${tocHtml}</div>` : '';

                    // æ ¹æ®é¡µé¢ç±»å‹å†³å®šæ˜¯å¦ä½¿ç”¨markdown-contentåŒ…è£…
                    const content = (chapterName === "bob" || chapterName === "toc") ?
                        contentHtml.replace(/<\/?p>/g, '') : // ç§»é™¤pæ ‡ç­¾
                        `<div class="markdown-content">${contentHtml}</div>`;

                    contentDiv.innerHTML = `
          ${mainTitle}
          ${navButtons}
          ${tocDiv}
          ${content}
        `;
                    // æ·»åŠ bobé¡µé¢æ ‡è¯†ç±»
                    if (chapterName === "bob") {
                        contentDiv.classList.add("bob-page");
                    } else {
                        contentDiv.classList.remove("bob-page");
                    }
                    // å†…å®¹åŠ è½½å®Œæˆåï¼Œå†æ¬¡æ›´æ–°æ ‡é¢˜ä»¥æ˜¾ç¤ºå…·ä½“ç« èŠ‚å
                    if (chapterName !== "bob" && chapterName !== "toc") {
                        updatePageHeader(chapterName, subDir);
                        // è·å–å®é™…çš„ç« èŠ‚æ ‡é¢˜å¹¶æ›´æ–°é¢åŒ…å±‘
                        const firstHeading = contentDiv.querySelector('h1, h2, h3, h4, h5, h6');
                        const actualTitle = firstHeading ? firstHeading.textContent : getChapterDisplayName(chapterName);
                        updateBreadcrumb(chapterName, subDir, actualTitle);
                    }

                    // å¦‚æœæ˜¯è„šæ³¨åŒ¹é…ï¼Œç›´æ¥æ‰“å¼€è„šæ³¨å¼¹çª—ï¼Œä¸è¿›è¡Œå†…å®¹é«˜äº®
                    if (footnoteKey && searchTerm) {
                        console.log(`æ£€æµ‹åˆ°è„šæ³¨åŒ¹é…ï¼Œå‡†å¤‡è‡ªåŠ¨æ‰“å¼€è„šæ³¨å¼¹çª—: è„šæ³¨é”®="${footnoteKey}", æœç´¢è¯="${searchTerm}", èŠ‚å·="${sectionNumber}"`);
                        setTimeout(() => {
                            autoOpenFootnotePopup(footnoteKey, searchTerm, sectionNumber);
                        }, 500); // å»¶è¿Ÿ500msç¡®ä¿é¡µé¢æ¸²æŸ“å®Œæˆ
                    } else if (searchTerm) {
                        // åªæœ‰éè„šæ³¨åŒ¹é…æ—¶æ‰è¿›è¡Œå†…å®¹é«˜äº®
                        highlightContentSearchTerm(searchTerm, anchorId, lineNumber);
                    }
                } catch (parseError) {
                    console.error("Markdownè§£æå¤±è´¥:", parseError);
                    contentDiv.innerHTML = "å†…å®¹è§£æå¤±è´¥";
                }
            } catch (error) {
                console.error("åŠ è½½ç« èŠ‚å¤±è´¥:", error);
                contentDiv.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }
        // ç”Ÿæˆç›®å½•HTML
        function generateTOC(tokens) {
            let toc = '';  // ç§»é™¤é‡å¤çš„ç›®å½•æ ‡é¢˜
            let currentDepth = 1;

            tokens.forEach((token) => {
                if (token.type === "heading" && token.depth !== 1) {
                    if (token.depth > currentDepth) {
                        // å¦‚æœå½“å‰æ ‡é¢˜æ·±åº¦å¤§äºä¸Šä¸€ä¸ªæ ‡é¢˜æ·±åº¦ï¼ŒåµŒå¥—è¿›å­åˆ—è¡¨
                        toc += `<ul class="toc-list">`;
                    } else if (token.depth < currentDepth) {
                        // å¦‚æœå½“å‰æ ‡é¢˜æ·±åº¦å°äºä¸Šä¸€ä¸ªæ ‡é¢˜æ·±åº¦ï¼Œå…³é—­å­åˆ—è¡¨
                        for (let i = 0; i < currentDepth - token.depth; i++) {
                            toc += "</ul>";
                        }
                    }
                    // ç”Ÿæˆç›®å½•é¡¹
                    toc += `
                  <li class="toc-item" id="${token.text}-${token.depth}">
                      <a href="#${token.text}">${token.text}</a>
                  </li>
              `;
                    currentDepth = token.depth;
                }
            });

            // å…³é—­æ‰€æœ‰æœªå…³é—­çš„ulæ ‡ç­¾
            for (let i = 1; i < currentDepth; i++) {
                toc += "</ul>";
            }

            toc += "</ul>";
            return toc;
        }

        // æ·»åŠ æ›´æ–°URLå‡½æ•°
        function updateURL(chapterName, subDir = '', searchTerm = '', anchorId = '', lineNumber = 0) {
            // è§„èŒƒåŒ– subDirï¼šç§»é™¤å¼€å¤´å’Œç»“å°¾çš„æ–œæ 
            subDir = subDir.replace(/^\/+|\/+$/g, '');
            const baseUrl = window.location.pathname;
            let newUrl = `${baseUrl}?chapter=${chapterName}${subDir ? `&dir=${subDir}` : ''}`;

            // å¦‚æœæœ‰æœç´¢è¯ï¼Œæ·»åŠ åˆ°URLå‚æ•°ä¸­
            if (searchTerm) {
                newUrl += `&search=${encodeURIComponent(searchTerm)}`;

                // å¦‚æœæœ‰é”šç‚¹IDå’Œè¡Œå·ï¼Œä¹Ÿæ·»åŠ åˆ°URLå‚æ•°ä¸­
                if (anchorId) {
                    newUrl += `&anchor=${encodeURIComponent(anchorId)}`;
                }

                if (lineNumber > 0) {
                    newUrl += `&line=${lineNumber}`;
                }
            }

            window.history.pushState({ chapterName, subDir, searchTerm, anchorId, lineNumber }, '', newUrl);

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log('URLå·²æ›´æ–°:', newUrl);
        }

        // æ·»åŠ popstateäº‹ä»¶ç›‘å¬
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                const { chapterName, subDir, searchTerm, anchorId, lineNumber } = event.state;
                loadChapter(chapterName, subDir, searchTerm, anchorId, lineNumber);
            }
        });

        async function init() {
            // é¢„å…ˆåŠ è½½bob.mdä¸­çš„åˆ†ç±»ä¿¡æ¯
            try {
                window.bobCategories = await getCategoriesFromBob();
                console.log('é¢„åŠ è½½åˆ†ç±»å®Œæˆ:', window.bobCategories);
            } catch (error) {
                console.error('é¢„åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                window.bobCategories = ['åœ£ç»ç ”è¯»', 'ç”Ÿå‘½è¯»ç»', 'å±çµä¹¦æŠ¥', 'å€ªè‘—æ–‡é›†', 'æè‘—æ–‡é›†', 'ç‰¹ä¼šçº²ç›®', 'è¯—æ­Œåˆè¾‘'];
            }

            // ä»URLå‚æ•°ä¸­è·å–åˆå§‹çŠ¶æ€
            const params = new URLSearchParams(window.location.search);
            const chapter = params.get('chapter') || 'bob';  // é»˜è®¤å€¼æ”¹ä¸º 'bob'
            const dir = params.get('dir') || '';
            const search = params.get('search') || '';
            const anchor = params.get('anchor') || '';
            const line = parseInt(params.get('line') || '0', 10);

            console.log('åˆå§‹åŒ–å‚æ•°:', { chapter, dir, search, anchor, line });

            // ä½¿ç”¨URLå‚æ•°åŠ è½½æ­£ç¡®çš„ç« èŠ‚ï¼Œå¹¶ä¼ é€’æœç´¢è¯å‚æ•°
            await loadChapter(chapter, dir, search, anchor, line);

            // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
            initSearch();
        }

        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        function initSearch() {
            console.log('åˆå§‹åŒ–æœç´¢åŠŸèƒ½...');

            // ç»‘å®šæœç´¢è§¦å‘æŒ‰é’®
            const searchTrigger = document.getElementById('search-trigger');
            const floatingSearchContainer = document.getElementById('floating-search-container');
            const floatingResultsContainer = document.getElementById('floating-results-container');
            const searchInput = document.getElementById('search-input');
            const closeSearchButton = document.getElementById('close-search-button');
            const clearSearchButton = document.getElementById('clear-search-button');



            // æ·»åŠ æ»šåŠ¨é˜»æ­¢äº‹ä»¶ç›‘å¬å™¨
            let lastY;
            document.addEventListener('touchstart', function (e) {
                if (document.documentElement.classList.contains('modal-open')) {
                    const target = e.target;
                    // å…è®¸å¼¹çª—å†…å®¹åŒºåŸŸæ»šåŠ¨
                    if (target.closest('.floating-search-box') ||
                        target.closest('.search-results') ||
                        target.closest('.results-content') ||
                        target.closest('.footnote-dialog-content') ||
                        target.closest('.footnote-dialog') ||
                        target.closest('.footnote-popup-content') ||
                        target.closest('.footnote-popup') ||
                        target.closest('.chapter-modal-content') ||
                        target.closest('.modal-chapter-content')) {
                        return;
                    }
                    lastY = e.touches[0].clientY;
                }
            }, { passive: false });

            document.addEventListener('touchmove', function (e) {
                if (document.documentElement.classList.contains('modal-open')) {
                    const target = e.target;
                    // å…è®¸å¼¹çª—å†…å®¹åŒºåŸŸæ»šåŠ¨
                    if (target.closest('.floating-search-box') ||
                        target.closest('.search-results') ||
                        target.closest('.results-content') ||
                        target.closest('.footnote-dialog-content') ||
                        target.closest('.footnote-dialog') ||
                        target.closest('.footnote-popup-content') ||
                        target.closest('.footnote-popup') ||
                        target.closest('.chapter-modal-content') ||
                        target.closest('.modal-chapter-content')) {
                        return;
                    }
                    e.preventDefault();
                }
            }, { passive: false });

            // ä¸ºæ¡Œé¢æµè§ˆå™¨æ·»åŠ æ»šåŠ¨é˜»æ­¢
            window.addEventListener('wheel', function (e) {
                if (document.documentElement.classList.contains('modal-open')) {
                    const target = e.target;
                    // å…è®¸å¼¹çª—å†…å®¹åŒºåŸŸæ»šåŠ¨
                    if (target.closest('.floating-search-box') ||
                        target.closest('.search-results') ||
                        target.closest('.results-content') ||
                        target.closest('.footnote-dialog-content') ||
                        target.closest('.footnote-dialog') ||
                        target.closest('.footnote-popup-content') ||
                        target.closest('.footnote-popup') ||
                        target.closest('.chapter-modal-content') ||
                        target.closest('.modal-chapter-content')) {
                        return;
                    }
                    e.preventDefault();
                }
            }, { passive: false });

            // ç‚¹å‡»æœç´¢æŒ‰é’®æ˜¾ç¤ºæœç´¢æ¡†
            searchTrigger.addEventListener('click', function () {
                floatingSearchContainer.classList.add('active');
                document.documentElement.classList.add('modal-open');
                searchInput.focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†

                // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
                const hasContent = searchInput.value.trim().length > 0;
                if (hasContent) {
                    clearSearchButton.classList.add('visible');
                } else {
                    clearSearchButton.classList.remove('visible');
                }
            });

            // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æœç´¢æ¡†
            closeSearchButton.addEventListener('click', function () {
                floatingSearchContainer.classList.remove('active');
                if (!floatingResultsContainer.classList.contains('active')) {
                    document.documentElement.classList.remove('modal-open');
                }
            });

            // ç‚¹å‡»æœç´¢å®¹å™¨å¤–éƒ¨åŒºåŸŸå…³é—­æœç´¢æ¡†
            floatingSearchContainer.addEventListener('click', function (event) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æœç´¢å®¹å™¨æœ¬èº«ï¼ˆè€Œéå…¶å­å…ƒç´ ï¼‰
                if (event.target === floatingSearchContainer) {
                    floatingSearchContainer.classList.remove('active');
                    if (!floatingResultsContainer.classList.contains('active')) {
                        document.documentElement.classList.remove('modal-open');
                    }
                }
            });

            // ç‚¹å‡»æœç´¢ç»“æœå®¹å™¨å¤–éƒ¨åŒºåŸŸå…³é—­æœç´¢ç»“æœ
            floatingResultsContainer.addEventListener('click', function (event) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯ç»“æœå®¹å™¨æœ¬èº«ï¼ˆè€Œéå…¶å­å…ƒç´ ï¼‰
                if (event.target === floatingResultsContainer) {
                    floatingResultsContainer.classList.remove('active');
                    if (!floatingSearchContainer.classList.contains('active')) {
                        document.documentElement.classList.remove('modal-open');
                    }
                }
            });

            // ç»‘å®šEnteré”®è§¦å‘æœç´¢
            searchInput.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });

            // ç›‘å¬è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼Œæ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º
            searchInput.addEventListener('input', function () {
                const hasContent = searchInput.value.trim().length > 0;
                if (hasContent) {
                    clearSearchButton.classList.add('visible');
                } else {
                    clearSearchButton.classList.remove('visible');
                }
            });

            // ç»‘å®šæ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            clearSearchButton.addEventListener('click', function () {
                searchInput.value = '';
                clearSearchButton.classList.remove('visible');
                searchInput.focus(); // æ¸…é™¤åé‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†

                // æ¸…é™¤æœç´¢ç»“æœ
                const searchResults = document.getElementById('search-results');
                if (searchResults) {
                    searchResults.innerHTML = '';
                }

                // éšè—æœç´¢ç»“æœå®¹å™¨
                floatingResultsContainer.classList.remove('active');
                if (!floatingSearchContainer.classList.contains('active')) {
                    document.documentElement.classList.remove('modal-open');
                }
            });

            // ç»‘å®šæœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('search-button').addEventListener('click', performSearch);

            console.log('æœç´¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }

        async function loadSubDir(subDir) {
            currentChapter = "toc";
            await loadChapter(currentChapter, subDir + "/");
        }

        async function nextChapter(subDir) {
            try {
                const chapters = await getChapterList(subDir);
                console.log("nextChapter - å½“å‰ç« èŠ‚:", currentChapter);
                console.log("nextChapter - ç›®å½•åˆ—è¡¨:", chapters);

                // æŸ¥æ‰¾å½“å‰ç« èŠ‚åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
                let currentIndex = -1;
                for (let i = 0; i < chapters.length; i++) {
                    if (chapters[i].name === currentChapter) {
                        currentIndex = i;
                        break;
                    }
                }
                console.log("nextChapter - å½“å‰ç´¢å¼•:", currentIndex);

                // å¦‚æœä¸æ˜¯æœ€åä¸€ç« ï¼ŒåŠ è½½ä¸‹ä¸€ç« 
                if (currentIndex !== -1 && currentIndex < chapters.length - 1) {
                    const nextChapter = chapters[currentIndex + 1];
                    console.log("nextChapter - ä¸‹ä¸€ç« :", nextChapter);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®å½•é“¾æ¥
                    if (nextChapter.isToc) {
                        // å¦‚æœæ˜¯ç›®å½•ï¼ŒåŠ è½½å­ç›®å½•
                        loadSubDir(nextChapter.path.replace(/^\/?(books\/)?/, ''));
                    } else {
                        // å¦‚æœæ˜¯æ™®é€šç« èŠ‚ï¼Œç›´æ¥åŠ è½½
                        await loadChapter(nextChapter.name, subDir);
                    }
                } else {
                    console.log('å·²ç»æ˜¯æœ€åä¸€ç« ');
                }
            }
            catch (error) {
                console.error('åŠ è½½ä¸‹ä¸€ç« å¤±è´¥:', error);
            }
        }

        async function prevChapter(subDir) {
            try {
                const chapters = await getChapterList(subDir);
                console.log("prevChapter - å½“å‰ç« èŠ‚:", currentChapter);
                console.log("prevChapter - ç›®å½•åˆ—è¡¨:", chapters);

                // æŸ¥æ‰¾å½“å‰ç« èŠ‚åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
                let currentIndex = -1;
                for (let i = 0; i < chapters.length; i++) {
                    if (chapters[i].name === currentChapter) {
                        currentIndex = i;
                        break;
                    }
                }

                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ç« ï¼ŒåŠ è½½ä¸Šä¸€ç« 
                if (currentIndex > 0) {
                    const prevChapter = chapters[currentIndex - 1];
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®å½•é“¾æ¥
                    if (prevChapter.isToc) {
                        // å¦‚æœæ˜¯ç›®å½•ï¼ŒåŠ è½½å­ç›®å½•
                        loadSubDir(prevChapter.path.replace(/^\/?(books\/)?/, ''));
                    } else {
                        // å¦‚æœæ˜¯æ™®é€šç« èŠ‚ï¼Œç›´æ¥åŠ è½½
                        await loadChapter(prevChapter.name, subDir);
                    }
                } else {
                    console.log('å·²ç»æ˜¯ç¬¬ä¸€ç« ');
                }
            }
            catch (error) {
                console.error('åŠ è½½ä¸Šä¸€ç« å¤±è´¥:', error);
            }
        }

        // è·å–ä¹¦ç±åˆ—è¡¨
        async function fetchBooksList() {
            try {
                console.log('å¼€å§‹è·å–ä¹¦ç±åˆ—è¡¨...');
                const response = await fetch(`${BOOKS_DIR}bob.md`);
                if (!response.ok) {
                    throw new Error(`æ— æ³•åŠ è½½ä¹¦ç±åˆ—è¡¨: ${response.status}`);
                }

                const markdown = await response.text();
                console.log('books/bob.mdå†…å®¹:', markdown);

                const lines = markdown.split('\n').filter(line => line.trim());

                const books = [];
                for (const line of lines) {
                    const match = line.match(/- \[(.*?)\]\((.*?)\)/);
                    if (match) {
                        const name = match[1];
                        let path = match[2];

                        // å¤„ç†è·¯å¾„
                        // å¦‚æœè·¯å¾„ä»¥./å¼€å¤´ï¼Œç§»é™¤./
                        if (path.startsWith('./')) {
                            path = path.substring(2);
                        }

                        // å¦‚æœè·¯å¾„ä»¥/ç»“å°¾ï¼Œç§»é™¤ç»“å°¾çš„/
                        if (path.endsWith('/')) {
                            path = path.slice(0, -1);
                        }

                        // æå–ç›®å½•éƒ¨åˆ†ï¼ˆå»æ‰æ–‡ä»¶åï¼‰
                        const pathParts = path.split('/');
                        if (pathParts.length > 0 && pathParts[pathParts.length - 1].includes('.md')) {
                            // å¦‚æœæœ€åä¸€éƒ¨åˆ†æ˜¯æ–‡ä»¶åï¼Œåˆ™ç§»é™¤
                            pathParts.pop();
                        }

                        const dirPath = pathParts.join('/');
                        console.log(`è§£æä¹¦ç±è·¯å¾„: åç§°=${name}, åŸå§‹è·¯å¾„=${path}, å¤„ç†åè·¯å¾„=${dirPath}`);

                        books.push({ name, path: dirPath });
                    }
                }

                console.log('è§£æåˆ°çš„ä¹¦ç±åˆ—è¡¨:', books);
                return books;
            } catch (error) {
                console.error('è·å–ä¹¦ç±åˆ—è¡¨å¤±è´¥:', error);
                return [];
            }
        }

        // è·å–æ–‡ä»¶ååˆ—è¡¨
        async function getChapterList(subDir) {
            try {
                // æ„å»ºtoc.mdçš„è·¯å¾„
                const normalizedSubDir = subDir ? (subDir.endsWith('/') ? subDir : subDir + '/') : '';
                const tocUrl = `${BOOKS_DIR}${normalizedSubDir}toc.md`;
                console.log('æ­£åœ¨è¯»å–ç›®å½•æ–‡ä»¶:', tocUrl);

                // è¯»å–toc.mdå†…å®¹
                const response = await fetch(tocUrl);
                if (!response.ok) {
                    console.error(`æ— æ³•åŠ è½½ç›®å½•æ–‡ä»¶ ${tocUrl}: ${response.status}`);
                    throw new Error(`æ— æ³•åŠ è½½ç›®å½•æ–‡ä»¶: ${response.status}`);
                }

                const res = await response.text();
                console.log(`${tocUrl} æ–‡ä»¶å†…å®¹:`, res);

                // æ›¿æ¢é“¾æ¥ä¸­çš„ "- " å‰ç¼€
                const markdown = res.replace(/- /g, '');

                // ä½¿ç”¨markedè§£æmarkdown
                const tokens = marked.lexer(markdown);
                console.log('è§£æçš„markdown tokens:', tokens);

                // æå–æ‰€æœ‰é“¾æ¥
                const chapters = [];
                tokens.forEach(token => {
                    if (token.type === 'paragraph') {
                        token.tokens.forEach(token => {
                            if (token.type === 'link') {
                                // ä»é“¾æ¥ä¸­æå–å®Œæ•´è·¯å¾„ä¿¡æ¯
                                const href = token.href;
                                const text = token.text;
                                console.log('å¤„ç†é“¾æ¥:', href, 'æ–‡æœ¬:', text);

                                // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®å½•é“¾æ¥ï¼ˆä»¥toc.mdç»“å°¾ï¼‰
                                const isToc = href.endsWith('toc.md');
                                // æå–æ–‡ä»¶åæˆ–å­ç›®å½•å
                                let path, name;

                                if (isToc) {
                                    // å¦‚æœæ˜¯toc.mdé“¾æ¥ï¼Œæå–å­ç›®å½•å
                                    console.log('å¤„ç†ç›®å½•é“¾æ¥:', href);

                                    // å°è¯•ä»hrefä¸­æå–ç›®å½•å
                                    let dirName = '';

                                    if (href.startsWith('./')) {
                                        // ç›¸å¯¹è·¯å¾„
                                        const cleanPath = href.replace('./', '');
                                        const parts = cleanPath.split('/');
                                        if (parts.length > 0) {
                                            dirName = parts[0];
                                        }

                                        // å¤„ç†ç›¸å¯¹è·¯å¾„
                                        if (normalizedSubDir) {
                                            // å¦‚æœå·²ç»åœ¨å­ç›®å½•ä¸­ï¼Œå°†å½“å‰ç›®å½•æ·»åŠ åˆ°è·¯å¾„å‰é¢
                                            path = normalizedSubDir;
                                        } else {
                                            path = '';
                                        }

                                        // æ·»åŠ ç›®å½•å
                                        if (dirName) {
                                            path += dirName;
                                        }
                                    } else {
                                        // ç»å¯¹è·¯å¾„
                                        const match = href.match(/\/([^\/]+)\/toc\.md$/);
                                        if (match) {
                                            dirName = match[1];
                                            // ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œä½†å»æ‰books/å‰ç¼€å’Œæœ€åçš„toc.md
                                            path = href.substring(0, href.lastIndexOf('/') + 1).replace(/^books\//, '');
                                        } else {
                                            // å¤„ç†ç®€å•çš„toc.mdé“¾æ¥
                                            path = normalizedSubDir;
                                        }
                                    }

                                    name = dirName || text; // å¦‚æœæ— æ³•ä»è·¯å¾„ä¸­æå–ï¼Œåˆ™ä½¿ç”¨é“¾æ¥æ–‡æœ¬
                                    console.log('ç›®å½•åç§°:', name, 'è·¯å¾„:', path);
                                } else {
                                    // å¦‚æœæ˜¯æ™®é€šç« èŠ‚ï¼Œæå–æ–‡ä»¶å
                                    console.log('å¤„ç†ç« èŠ‚é“¾æ¥:', href);

                                    if (href.startsWith('./')) {
                                        // ç›¸å¯¹è·¯å¾„
                                        name = href.replace('./', '').replace('.md', '');
                                        path = normalizedSubDir;
                                    } else if (href.indexOf('/') === -1) {
                                        // ç®€å•æ–‡ä»¶åï¼Œæ— è·¯å¾„
                                        name = href.replace('.md', '');
                                        path = normalizedSubDir;
                                    } else {
                                        // ç»å¯¹è·¯å¾„
                                        const match = href.match(/\/([^\/]+)\.md$/);
                                        if (match) {
                                            name = match[1];
                                            path = href.substring(0, href.lastIndexOf('/') + 1).replace(/^books\//, '');
                                        } else {
                                            // ç®€å•æ–‡ä»¶å
                                            name = href.replace('.md', '');
                                            path = normalizedSubDir;
                                        }
                                    }
                                    console.log('ç« èŠ‚åç§°:', name, 'è·¯å¾„:', path);
                                }

                                if (name) {
                                    chapters.push({
                                        name: name,
                                        path: path,
                                        href: href,
                                        isToc: isToc
                                    });
                                    console.log('æ·»åŠ ç« èŠ‚:', name, path, isToc);
                                } else {
                                    console.log('æ— æ³•è§£æç« èŠ‚åç§°ï¼Œè·³è¿‡');
                                }
                            }
                        });
                    }
                });
                console.log('è§£æåçš„ç›®å½•ç»“æ„:', chapters);
                return chapters;
            } catch (error) {
                console.error('è·å–æ–‡ä»¶ååˆ—è¡¨å¤±è´¥:', error);
                return [];
            }
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°ä¼˜åŒ–é¢åŒ…å±‘
        window.addEventListener('resize', function () {
            optimizeMobileBreadcrumb();
        });

        document.addEventListener("DOMContentLoaded", init);

        // åˆå§‹åŒ– dialog äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener("DOMContentLoaded", function () {
            const dialog = document.getElementById('footnote-dialog');
            if (dialog) {
                // ç›‘å¬ dialog å…³é—­äº‹ä»¶
                dialog.addEventListener('close', function () {
                    // ç¡®ä¿åœ¨ä»»ä½•å…³é—­æ–¹å¼ä¸‹éƒ½æ¢å¤èƒŒæ™¯æ»šåŠ¨
                    document.body.classList.remove('dialog-open');

                    // æ£€æŸ¥æœç´¢ç»“æœæ˜¯å¦è¿˜åœ¨æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯ï¼Œä¿æŒæœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€
                    const floatingResultsContainer = document.getElementById('floating-results-container');
                    const floatingSearchContainer = document.getElementById('floating-search-container');

                    if (floatingResultsContainer && floatingResultsContainer.classList.contains('active')) {
                        // æœç´¢ç»“æœè¿˜åœ¨æ˜¾ç¤ºï¼Œä¿æŒæ¨¡æ€çŠ¶æ€
                        document.documentElement.classList.add('modal-open');
                        console.log('ğŸ”„ Dialogå…³é—­äº‹ä»¶ï¼šä¿æŒæœç´¢ç»“æœå¼¹çª—çŠ¶æ€');
                    } else if (floatingSearchContainer && floatingSearchContainer.classList.contains('active')) {
                        // æœç´¢æ¡†è¿˜åœ¨æ˜¾ç¤ºï¼Œä¿æŒæ¨¡æ€çŠ¶æ€
                        document.documentElement.classList.add('modal-open');
                        console.log('ğŸ”„ Dialogå…³é—­äº‹ä»¶ï¼šä¿æŒæœç´¢æ¡†å¼¹çª—çŠ¶æ€');
                    }
                });

                // ç›‘å¬ç‚¹å‡» backdrop å…³é—­ - ä¿®å¤ç‰ˆæœ¬
                dialog.addEventListener('click', function (event) {
                    // è·å– dialog çš„è¾¹ç•ŒçŸ©å½¢
                    const rect = dialog.getBoundingClientRect();
                    const isInDialog = (
                        event.clientX >= rect.left &&
                        event.clientX <= rect.right &&
                        event.clientY >= rect.top &&
                        event.clientY <= rect.bottom
                    );

                    // å¦‚æœç‚¹å‡»åœ¨ dialog å¤–éƒ¨ï¼ˆbackdrop åŒºåŸŸï¼‰ï¼Œå…³é—­å¼¹çª—
                    if (!isInDialog) {
                        closeFootnoteDialog();
                    }
                });

                // ç›‘å¬ ESC é”®å…³é—­
                document.addEventListener('keydown', function (event) {
                    if (event.key === 'Escape' && dialog.open) {
                        closeFootnoteDialog();
                    }
                });
            }
        });

        // å¤„ç†å†…å®¹ç‚¹å‡»äº‹ä»¶
        function handleContentClick(event) {
            const target = event.target;
            if (target.tagName === "A") {
                if (target.getAttribute("href") && target.getAttribute("href").startsWith('#')) {
                    return; // è®©é”šç‚¹é“¾æ¥æ­£å¸¸å·¥ä½œ
                }
                event.preventDefault(); // åªé˜»æ­¢.mdæ–‡ä»¶é“¾æ¥çš„é»˜è®¤è¡Œä¸º

                const href = target.getAttribute("href");
                if (href && href.includes(".md")) {
                    // ä»hrefä¸­æå–è·¯å¾„ä¿¡æ¯
                    const pathParts = href.split('/');
                    const fileName = pathParts[pathParts.length - 1];

                    // è·å–å½“å‰é¡µé¢çš„ subDir
                    const params = new URLSearchParams(window.location.search);
                    const currentSubDir = params.get('dir') || '';

                    let relativePath = '';

                    // å¤„ç†ç›¸å¯¹è·¯å¾„ï¼ˆä»¥ ./ æˆ– ../ å¼€å¤´ï¼‰
                    if (href.startsWith('./')) {
                        // ç§»é™¤å¼€å¤´çš„ ./
                        const cleanPath = href.replace('./', '');
                        const cleanPathParts = cleanPath.split('/');

                        if (fileName === 'toc.md') {
                            // å¦‚æœæ˜¯ç›®å½•é“¾æ¥ï¼Œéœ€è¦æ­£ç¡®å¤„ç†è·¯å¾„
                            if (cleanPathParts.length > 1) {
                                // å¦‚æœè·¯å¾„ä¸­åŒ…å«å­ç›®å½•ï¼ˆå¦‚ ./å­ç›®å½•/toc.mdï¼‰
                                const subDirParts = cleanPathParts.slice(0, -1); // ç§»é™¤æ–‡ä»¶åï¼Œä¿ç•™ç›®å½•éƒ¨åˆ†
                                if (currentSubDir) {
                                    relativePath = currentSubDir + '/' + subDirParts.join('/');
                                } else {
                                    relativePath = subDirParts.join('/');
                                }
                            } else {
                                // å¦‚æœåªæ˜¯æ–‡ä»¶åï¼ˆå¦‚ ./toc.mdï¼‰ï¼Œä½¿ç”¨å½“å‰ç›®å½•
                                relativePath = currentSubDir;
                            }
                        } else {
                            // å¦‚æœæ˜¯ç« èŠ‚é“¾æ¥ï¼Œéœ€è¦æ„å»ºå®Œæ•´çš„ç›®å½•è·¯å¾„
                            if (cleanPathParts.length > 1) {
                                // å¦‚æœè·¯å¾„ä¸­åŒ…å«å­ç›®å½•ï¼ˆå¦‚ ./èµæ/3.mdï¼‰
                                const subDirParts = cleanPathParts.slice(0, -1); // ç§»é™¤æ–‡ä»¶åï¼Œä¿ç•™ç›®å½•éƒ¨åˆ†
                                if (currentSubDir) {
                                    relativePath = currentSubDir + '/' + subDirParts.join('/');
                                } else {
                                    relativePath = subDirParts.join('/');
                                }
                            } else {
                                // å¦‚æœåªæ˜¯æ–‡ä»¶åï¼ˆå¦‚ ./3.mdï¼‰ï¼Œä½¿ç”¨å½“å‰ç›®å½•
                                relativePath = currentSubDir;
                            }
                        }
                    } else if (href.startsWith('../')) {
                        // å¤„ç†ä¸Šçº§ç›®å½•è·¯å¾„ï¼ˆä»¥ ../ å¼€å¤´ï¼‰
                        console.log('å¤„ç†ä¸Šçº§ç›®å½•è·¯å¾„:', href, 'å½“å‰ç›®å½•:', currentSubDir);

                        // è§£æ ../ è·¯å¾„
                        const pathParts = href.split('/');
                        const currentDirParts = currentSubDir ? currentSubDir.split('/').filter(part => part) : [];

                        // è®¡ç®—éœ€è¦å›é€€çš„å±‚çº§æ•°
                        let backLevels = 0;
                        let remainingPath = [];

                        for (let i = 0; i < pathParts.length; i++) {
                            if (pathParts[i] === '..') {
                                backLevels++;
                            } else if (pathParts[i] !== '') {
                                remainingPath = pathParts.slice(i);
                                break;
                            }
                        }

                        // æ„å»ºæ–°çš„è·¯å¾„
                        const newDirParts = currentDirParts.slice(0, -backLevels);

                        if (fileName === 'toc.md') {
                            // å¦‚æœæ˜¯ç›®å½•é“¾æ¥ï¼Œåªéœ€è¦ç›®å½•éƒ¨åˆ†ï¼Œä¸åŒ…å«æ–‡ä»¶å
                            if (remainingPath.length > 1) {
                                // ç§»é™¤æ–‡ä»¶å toc.mdï¼Œä¿ç•™ç›®å½•éƒ¨åˆ†
                                const targetDir = remainingPath.slice(0, -1).join('/');
                                relativePath = newDirParts.length > 0 ?
                                    newDirParts.join('/') + '/' + targetDir :
                                    targetDir;
                            } else {
                                // å¦‚æœåªæœ‰æ–‡ä»¶å toc.mdï¼Œä½¿ç”¨å›é€€åçš„ç›®å½•
                                relativePath = newDirParts.join('/');
                            }
                        } else {
                            // å¦‚æœæ˜¯ç« èŠ‚é“¾æ¥ï¼Œéœ€è¦åŒ…å«ç›®å½•éƒ¨åˆ†
                            if (remainingPath.length > 1) {
                                const targetDir = remainingPath.slice(0, -1).join('/');
                                relativePath = newDirParts.length > 0 ?
                                    newDirParts.join('/') + '/' + targetDir :
                                    targetDir;
                            } else {
                                relativePath = newDirParts.join('/');
                            }
                        }

                        console.log('è§£æåçš„è·¯å¾„:', relativePath);
                    } else {
                        // å¤„ç†ç»å¯¹è·¯å¾„
                        if (pathParts.length > 1) {
                            relativePath = pathParts.slice(0, -1)
                                .join('/')
                                .replace(/^books\//, '')  // ç§»é™¤å¼€å¤´çš„ books/
                                .replace(/^\/+|\/+$/g, ''); // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„æ–œæ 
                        } else {
                            relativePath = currentSubDir;
                        }
                    }

                    // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                    relativePath = relativePath.replace(/^\/+|\/+$/g, '');

                    // åˆ¤æ–­æ˜¯å¦æ˜¯ç›®å½•é“¾æ¥
                    if (fileName === "toc.md") {
                        console.log('åŠ è½½å­ç›®å½•:', relativePath);
                        loadSubDir(relativePath);
                    } else {
                        const chapterName = fileName.replace(".md", "");
                        console.log('å³å°†åŠ è½½ç« èŠ‚:', chapterName, 'è·¯å¾„:', relativePath);
                        loadChapter(chapterName, relativePath);
                    }
                }
            }
        }

        // æœç´¢å‡½æ•°
        async function performSearch() {
            console.log('å¼€å§‹æ‰§è¡Œæœç´¢...');

            // æ¸…é™¤ä¹‹å‰ä¿å­˜çš„åŸå§‹æœç´¢ç»“æœå’Œæ’åºçŠ¶æ€
            window.originalSearchResults = null;
            window.sortState = 'original';
            window.allExpanded = false; // é‡ç½®å±•å¼€/æŠ˜å çŠ¶æ€

            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            const searchResults = document.getElementById('search-results');
            const floatingSearchContainer = document.getElementById('floating-search-container');
            const floatingResultsContainer = document.getElementById('floating-results-container');

            if (!searchTerm) {
                floatingResultsContainer.classList.remove('active');
                if (!floatingSearchContainer.classList.contains('active')) {
                    document.documentElement.classList.remove('modal-open');
                }
                return;
            }

            console.log(`æœç´¢è¯: "${searchTerm}"`);

            // ä½¿ç”¨åŸæœ‰æœç´¢é€»è¾‘
            console.log('ä½¿ç”¨åŸæœ‰æœç´¢é€»è¾‘');

            // éšè—æœç´¢æ¡†
            floatingSearchContainer.classList.remove('active');

            searchResults.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
            searchResults.classList.add('loading-state'); // æ·»åŠ åŠ è½½çŠ¶æ€æ ·å¼
            floatingResultsContainer.classList.add('active');
            document.documentElement.classList.add('modal-open');

            // é‡ç½®æœç´¢ç»“æœåˆ—è¡¨çš„æ»šåŠ¨ä½ç½®åˆ°é¡¶éƒ¨
            searchResults.scrollTop = 0;

            try {
                console.log('æœç´¢è¯:', searchTerm);
                // å¦‚æœæœç´¢ç´¢å¼•ä¸ºç©ºï¼Œå…ˆå°è¯•åŠ è½½æˆ–æ„å»ºç´¢å¼•
                if (searchIndex.length === 0) {
                    console.log('æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œå°è¯•åŠ è½½ç°æœ‰ç´¢å¼•...');

                    // æ˜¾ç¤ºåŠ è½½è¿›åº¦
                    showLoadingProgress('æ­£åœ¨åŠ è½½æœç´¢ç´¢å¼•...');

                    const loaded = await loadSearchIndex();
                    if (!loaded) {
                        updateLoadingProgress('æœªæ‰¾åˆ°ç°æœ‰ç´¢å¼•ï¼Œå¼€å§‹æ„å»ºæ–°ç´¢å¼•...');
                        await buildSearchIndex();
                        console.log('æœç´¢ç´¢å¼•æ„å»ºå®Œæˆï¼Œç´¢å¼•å¤§å°:', searchIndex.length);
                        hideLoadingProgress();
                        // æç¤ºç”¨æˆ·å¯ä»¥ä¸‹è½½ç´¢å¼•æ–‡ä»¶
                        showIndexDownloadPrompt();
                    } else {
                        console.log('æˆåŠŸåŠ è½½ç°æœ‰æœç´¢ç´¢å¼•ï¼Œç´¢å¼•å¤§å°:', searchIndex.length);
                        hideLoadingProgress();
                    }
                }

                // æ‰§è¡Œæœç´¢
                console.log('å¼€å§‹æœç´¢...');
                const results = originalSearchInIndex(searchTerm);
                console.log('æœç´¢ç»“æœæ•°é‡:', results.length);

                // æ˜¾ç¤ºæœç´¢ç»“æœ
                displaySearchResults(results, searchTerm);
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                searchResults.classList.remove('loading-state'); // ç§»é™¤åŠ è½½çŠ¶æ€
                searchResults.innerHTML = `<div class="search-error">æœç´¢å‡ºé”™: ${error.message}</div>`;
            }
        }

        // åŠ è½½ç°æœ‰æœç´¢ç´¢å¼•
        async function loadSearchIndex() {
            try {
                console.log('å°è¯•åŠ è½½æœç´¢ç´¢å¼•æ–‡ä»¶...');

                // å…ˆæ£€æŸ¥å…ƒæ•°æ®æ–‡ä»¶
                const metaResponse = await fetch('./search-meta.json');
                if (!metaResponse.ok) {
                    console.log('æœç´¢ç´¢å¼•å…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
                    return false;
                }

                const meta = await metaResponse.json();
                console.log('æœç´¢ç´¢å¼•å…ƒæ•°æ®:', meta);

                // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆï¼ˆè¿™é‡Œç®€å•æ£€æŸ¥æ—¶é—´ï¼Œåç»­å¯ä»¥åŠ å¼ºï¼‰
                if (!isIndexValid(meta)) {
                    console.log('æœç´¢ç´¢å¼•å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°æ„å»º');
                    return false;
                }

                // åŠ è½½å•ä¸ªç´¢å¼•æ•°æ®æ–‡ä»¶
                const indexResponse = await fetch('./search-index.json');
                if (!indexResponse.ok) {
                    console.log('æœç´¢ç´¢å¼•æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
                    return false;
                }
                const indexData = await indexResponse.json();

                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                if (!Array.isArray(indexData) || indexData.length === 0) {
                    console.log('æœç´¢ç´¢å¼•æ•°æ®æ ¼å¼æ— æ•ˆ');
                    return false;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºä¼˜åŒ–æ ¼å¼ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦è¿˜åŸ
                if (meta.optimized && meta.version === '1.1') {
                    console.log('æ£€æµ‹åˆ°ä¼˜åŒ–æ ¼å¼ç´¢å¼•ï¼Œæ­£åœ¨è¿˜åŸ...');
                    searchIndex = restoreOptimizedIndex(indexData);
                    console.log('ä¼˜åŒ–æ ¼å¼ç´¢å¼•è¿˜åŸå®Œæˆ');
                } else {
                    searchIndex = indexData;
                }

                indexLoaded = true;
                console.log(`æˆåŠŸåŠ è½½æœç´¢ç´¢å¼•ï¼ŒåŒ…å« ${searchIndex.length} ä¸ªç« èŠ‚`);
                return true;

            } catch (error) {
                console.log('åŠ è½½æœç´¢ç´¢å¼•å¤±è´¥:', error.message);
                return false;
            }
        }





        // è¿˜åŸä¼˜åŒ–çš„ç´¢å¼•æ•°æ®
        function restoreOptimizedIndex(optimizedData) {
            return optimizedData.map(item => {
                const restored = {
                    title: item.t,           // t -> title
                    content: item.c || '',   // c -> content
                    bookName: item.bn,       // bn -> bookName
                    bookPath: item.bp,       // bp -> bookPath
                    chapterName: item.cn,    // cn -> chapterName
                    chapterPath: item.cp     // cp -> chapterPath
                };

                // è¿˜åŸè„šæ³¨ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (item.f && Object.keys(item.f).length > 0) {
                    restored.footnotes = item.f;  // f -> footnotes
                }

                return restored;
            });
        }

        // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
        function isIndexValid(meta) {
            if (!meta.timestamp) return false;

            // ç´¢å¼•æ°¸ä¸è¿‡æœŸ - å·²ç¦ç”¨è¿‡æœŸæ£€æŸ¥
            // const indexAge = Date.now() - meta.timestamp;
            // const maxAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©
            // if (indexAge > maxAge) {
            //     console.log(`ç´¢å¼•å·²è¿‡æœŸï¼Œå¹´é¾„: ${Math.round(indexAge / (24 * 60 * 60 * 1000))} å¤©`);
            //     return false;
            // }

            return true;
        }

        // ä¸“é—¨ç”¨äºç´¢å¼•çš„è„šæ³¨å¤„ç†å‡½æ•°
        function processFootnotesForIndex(markdownText) {
            const footnotes = {};
            let cleanContent = markdownText;

            // æŒ‰ç©ºè¡Œåˆ†å‰²æˆå—
            const blocks = markdownText.split(/\n\s*\n/);
            const processedBlocks = [];

            let i = 0;
            while (i < blocks.length) {
                const block = blocks[i].trim();

                if (block === '') {
                    processedBlocks.push('');
                    i++;
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦åŒ…å«è„šæ³¨å¼•ç”¨
                const footnoteRefs = block.match(/\[\^([^\]]+)\]/g) || [];

                if (footnoteRefs.length > 0) {
                    // è¿™æ˜¯åŒ…å«è„šæ³¨çš„æ®µè½ï¼Œæ”¶é›†ç´§è·Ÿçš„è„šæ³¨å®šä¹‰
                    let processedParagraph = block;
                    const paragraphFootnotes = {};

                    // æå–æ®µè½å¼€å¤´çš„æ•°å­—å’Œå¯èƒ½çš„ä¸Šä¸­ä¸‹åç¼€ï¼ˆèŠ‚å·ï¼‰
                    const sectionMatch = processedParagraph.match(/^(\d+[ä¸Šä¸­ä¸‹]?)\s+/);
                    const sectionNumber = sectionMatch ? sectionMatch[1] : null;

                    let j = i + 1;

                    // æ”¶é›†ç´§è·Ÿçš„è„šæ³¨å®šä¹‰
                    while (j < blocks.length) {
                        const nextBlock = blocks[j].trim();

                        if (nextBlock === '') {
                            j++;
                            continue;
                        }

                        // æ£€æŸ¥æ˜¯å¦ä¸ºè„šæ³¨å®šä¹‰å—
                        const footnoteLines = nextBlock.split('\n');
                        let isFootnoteBlock = true;

                        for (const line of footnoteLines) {
                            if (line.trim() === '') continue;
                            if (!line.match(/^\[\^([^\]]+)\]:/)) {
                                isFootnoteBlock = false;
                                break;
                            }
                        }

                        if (isFootnoteBlock) {
                            // è§£æè¿™ä¸ªè„šæ³¨å®šä¹‰å—
                            for (const line of footnoteLines) {
                                if (line.trim() === '') continue;
                                const footnoteDefMatch = line.match(/^\[\^([^\]]+)\]:\s*(.*)$/);
                                if (footnoteDefMatch) {
                                    const key = footnoteDefMatch[1];
                                    const content = footnoteDefMatch[2];
                                    paragraphFootnotes[key] = content;

                                    // ä¸ºé‡å¤çš„è„šæ³¨é”®åˆ›å»ºå”¯ä¸€æ ‡è¯†
                                    let uniqueKey = key;
                                    let counter = 1;
                                    while (footnotes[uniqueKey]) {
                                        uniqueKey = `${key}_${counter}`;
                                        counter++;
                                    }

                                    // æ·»åŠ åˆ°å…¨å±€è„šæ³¨é›†åˆï¼ŒåŒ…å«èŠ‚å·ä¿¡æ¯
                                    footnotes[uniqueKey] = {
                                        content: content,
                                        sectionNumber: sectionNumber,
                                        originalKey: key  // ä¿å­˜åŸå§‹é”®å
                                    };
                                }
                            }
                            j++;
                        } else {
                            break;
                        }
                    }

                    // ä»æ®µè½ä¸­å»é™¤è„šæ³¨æ ‡è®°
                    const footnoteKeys = [...new Set(footnoteRefs.map(ref => ref.match(/\[\^([^\]]+)\]/)[1]))];
                    footnoteKeys.forEach(key => {
                        const regex = new RegExp(`\\[\\^${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');
                        processedParagraph = processedParagraph.replace(regex, '');
                    });

                    processedBlocks.push(processedParagraph);
                    i = j; // è·³è¿‡å·²å¤„ç†çš„è„šæ³¨å®šä¹‰å—
                } else {
                    // æ™®é€šæ®µè½ï¼Œç›´æ¥æ·»åŠ 
                    processedBlocks.push(block);
                    i++;
                }
            }

            return {
                cleanContent: processedBlocks.join('\n\n'),
                footnotes: footnotes
            };
        }

        // æ„å»ºæœç´¢ç´¢å¼•
        async function buildSearchIndex() {
            searchIndex = [];

            try {
                // è·å–ä¹¦ç±åˆ—è¡¨
                console.log('å¼€å§‹è·å–ä¹¦ç±åˆ—è¡¨...');
                const booksList = await fetchBooksList();
                console.log(`è·å–åˆ° ${booksList.length} æœ¬ä¹¦`);

                // éå†æ¯æœ¬ä¹¦ï¼Œé€’å½’ç´¢å¼•æ‰€æœ‰å†…å®¹
                for (const book of booksList) {
                    await indexBookContent(book.name, book.path, 0);
                }

                console.log(`æœç´¢ç´¢å¼•æ„å»ºå®Œæˆï¼Œå…±ç´¢å¼• ${searchIndex.length} ä¸ªç« èŠ‚`);
            } catch (error) {
                console.error('æ„å»ºæœç´¢ç´¢å¼•å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºç´¢å¼•ä¸‹è½½æç¤º
        function showIndexDownloadPrompt() {
            // åˆ›å»ºæç¤ºæ¡†
            const promptDiv = document.createElement('div');
            promptDiv.id = 'index-download-prompt';
            promptDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ddeadc;
        border: 2px solid #006400;
        border-radius: 8px;
        padding: 15px;
        max-width: 300px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 0.9rem;
      `;

            promptDiv.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold; color: #006400;">
          ğŸš€ æœç´¢ç´¢å¼•å·²æ„å»ºå®Œæˆï¼
        </div>
        <div style="margin-bottom: 15px; color: #333;">
          ä¸ºäº†æå‡ä¸‹æ¬¡æœç´¢é€Ÿåº¦ï¼Œå»ºè®®ä¸‹è½½ç´¢å¼•æ–‡ä»¶åˆ°ç½‘ç«™æ ¹ç›®å½•ã€‚
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="downloadSearchIndex()" style="
            background: #006400;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
          ">ä¸‹è½½ç´¢å¼•</button>
          <button onclick="closeIndexPrompt()" style="
            background: #ccc;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
          ">ç¨å</button>
        </div>
      `;

            document.body.appendChild(promptDiv);

            // 10ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                closeIndexPrompt();
            }, 10000);
        }

        // å…³é—­ç´¢å¼•ä¸‹è½½æç¤º
        function closeIndexPrompt() {
            const promptDiv = document.getElementById('index-download-prompt');
            if (promptDiv) {
                promptDiv.remove();
            }
        }

        // ä¼˜åŒ–ç´¢å¼•æ•°æ®ä»¥å‡å°‘æ–‡ä»¶å¤§å°
        function optimizeIndexData(indexData) {
            console.log(`å¼€å§‹ä¼˜åŒ– ${indexData.length} ä¸ªç« èŠ‚çš„ç´¢å¼•æ•°æ®...`);

            let totalOriginalContent = 0;
            let totalOptimizedContent = 0;

            const optimized = indexData.map(item => {
                // å‹ç¼©å­—æ®µå
                const optimizedItem = {
                    t: item.title,                    // title -> t
                    bn: item.bookName,               // bookName -> bn
                    bp: item.bookPath,               // bookPath -> bp
                    cn: item.chapterName,            // chapterName -> cn
                    cp: item.chapterPath             // chapterPath -> cp
                };

                // å†…å®¹ä¼˜åŒ–ï¼šå¤§å¹…å‡å°‘å†…å®¹é•¿åº¦ï¼Œåªä¿ç•™å‰800å­—ç¬¦ç”¨äºæœç´¢
                if (item.content) {
                    const originalLength = item.content.length;
                    totalOriginalContent += originalLength;

                    const content = item.content
                        .replace(/\s+/g, ' ')          // å¤šä¸ªç©ºç™½å­—ç¬¦åˆå¹¶ä¸ºä¸€ä¸ªç©ºæ ¼
                        .replace(/\n\s*\n/g, '\n')     // å¤šä¸ªæ¢è¡Œåˆå¹¶ä¸ºä¸€ä¸ª
                        .replace(/^#+\s+/g, '')        // ç§»é™¤å¼€å¤´çš„'#'æ ‡è®°
                        .replace(/<.*?>/g, '')         // ç§»é™¤HTMLæ ‡ç­¾
                        .replace(/\[.*?\]/g, '')       // ç§»é™¤æ–¹æ‹¬å·å†…å®¹
                        .replace(/\(.*?\)/g, '')       // ç§»é™¤åœ†æ‹¬å·å†…å®¹
                        .trim();                       // ç§»é™¤é¦–å°¾ç©ºç™½

                    // è¿›ä¸€æ­¥å‡å°‘åˆ°800å­—ç¬¦ï¼Œå¯¹äºæœç´¢æ¥è¯´å·²ç»è¶³å¤Ÿ
                    optimizedItem.c = content.substring(0, 800); // content -> cï¼Œé™åˆ¶800å­—ç¬¦
                    totalOptimizedContent += optimizedItem.c.length;
                }

                // è„šæ³¨ä¿¡æ¯ä¹Ÿè¿›è¡Œä¼˜åŒ–ï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯
                if (item.footnotes && Object.keys(item.footnotes).length > 0) {
                    const optimizedFootnotes = {};
                    Object.keys(item.footnotes).forEach(key => {
                        // è„šæ³¨å†…å®¹ä¹Ÿé™åˆ¶é•¿åº¦
                        const footnoteContent = item.footnotes[key];
                        if (typeof footnoteContent === 'string') {
                            optimizedFootnotes[key] = footnoteContent.substring(0, 300);
                        } else {
                            optimizedFootnotes[key] = footnoteContent;
                        }
                    });
                    optimizedItem.f = optimizedFootnotes;     // footnotes -> f
                }

                return optimizedItem;
            });

            console.log(`å†…å®¹ä¼˜åŒ–ç»Ÿè®¡ï¼šåŸå§‹å†…å®¹æ€»é•¿åº¦ ${(totalOriginalContent / 1024 / 1024).toFixed(1)}MBï¼Œä¼˜åŒ–å ${(totalOptimizedContent / 1024 / 1024).toFixed(1)}MB`);

            return optimized;
        }

        // ä¸‹è½½æœç´¢ç´¢å¼•æ–‡ä»¶ï¼ˆå¸¦é…ç½®ï¼‰
        function downloadSearchIndexWithConfig() {
            if (searchIndex.length === 0) {
                alert('æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œè¯·å…ˆè¿›è¡Œæœç´¢ä»¥æ„å»ºç´¢å¼•');
                return;
            }

            downloadSearchIndex();
        }

        // ä¸‹è½½æœç´¢ç´¢å¼•æ–‡ä»¶
        function downloadSearchIndex() {
            if (searchIndex.length === 0) {
                alert('æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œè¯·å…ˆè¿›è¡Œæœç´¢ä»¥æ„å»ºç´¢å¼•');
                return;
            }

            console.log('å¼€å§‹ç”Ÿæˆä¼˜åŒ–çš„æœç´¢ç´¢å¼•æ–‡ä»¶...');

            // ä¼˜åŒ–ç´¢å¼•æ•°æ®
            const optimizedIndex = optimizeIndexData(searchIndex);

            // è®¡ç®—å‹ç¼©ç‡
            const originalSize = JSON.stringify(searchIndex).length;
            const optimizedSize = JSON.stringify(optimizedIndex).length;
            const compressionRatio = ((originalSize - optimizedSize) / originalSize * 100).toFixed(1);

            console.log(`ç´¢å¼•ä¼˜åŒ–å®Œæˆï¼šåŸå§‹å¤§å° ${(originalSize / 1024).toFixed(1)}KBï¼Œä¼˜åŒ–å ${(optimizedSize / 1024).toFixed(1)}KBï¼Œå‹ç¼©ç‡ ${compressionRatio}%`);
            console.log(`ä¼˜åŒ–åå¤§å°ï¼ˆMBï¼‰ï¼š${(optimizedSize / 1024 / 1024).toFixed(1)}MB`);

            // ç”Ÿæˆä¼˜åŒ–çš„ç´¢å¼•æ•°æ®ï¼ˆä¸ä½¿ç”¨æ ¼å¼åŒ–ï¼Œå‡å°‘æ–‡ä»¶å¤§å°ï¼‰
            const indexData = JSON.stringify(optimizedIndex);

            // éªŒè¯æœ€ç»ˆæ•°æ®å¤§å°
            const finalSize = indexData.length;
            console.log(`æœ€ç»ˆJSONå­—ç¬¦ä¸²å¤§å°ï¼š${(finalSize / 1024 / 1024).toFixed(1)}MB`);

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´
            if (finalSize > 50 * 1024 * 1024) { // å¦‚æœè¶…è¿‡50MB
                console.warn(`è­¦å‘Šï¼šæ–‡ä»¶ä»ç„¶è¾ƒå¤§ (${(finalSize / 1024 / 1024).toFixed(1)}MB)ï¼Œå»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–`);
            }

            // ç”Ÿæˆå…ƒæ•°æ®
            const metaData = JSON.stringify({
                version: '1.1',                    // æ›´æ–°ç‰ˆæœ¬å·è¡¨ç¤ºä¼˜åŒ–æ ¼å¼
                timestamp: Date.now(),
                totalChapters: searchIndex.length,
                generatedAt: new Date().toISOString(),
                description: 'ä¼˜åŒ–çš„æœç´¢ç´¢å¼•æ–‡ä»¶',
                optimized: true,
                originalSize: originalSize,
                optimizedSize: optimizedSize,
                compressionRatio: compressionRatio + '%'
            });

            // ç›´æ¥ä¸‹è½½å•ä¸ªç´¢å¼•æ–‡ä»¶ï¼ˆå·²ç§»é™¤æ™ºèƒ½åˆ†å—åŠŸèƒ½ï¼‰
            downloadFile('search-index.json', indexData);

            // ç¨å¾®å»¶è¿Ÿä¸‹è½½å…ƒæ•°æ®æ–‡ä»¶ï¼Œé¿å…åŒæ—¶ä¸‹è½½
            setTimeout(() => {
                downloadFile('search-meta.json', metaData);
            }, 500);

            // å…³é—­æç¤ºæ¡†
            closeIndexPrompt();

            // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
            setTimeout(() => {
                alert(`ä¼˜åŒ–ç´¢å¼•æ–‡ä»¶ä¸‹è½½å®Œæˆï¼\n\nä¼˜åŒ–æ•ˆæœï¼š\nâ€¢ æ–‡ä»¶å¤§å°å‡å°‘ ${compressionRatio}%\nâ€¢ åŸå§‹å¤§å°ï¼š${(originalSize / 1024).toFixed(1)}KB\nâ€¢ ä¼˜åŒ–åï¼š${(optimizedSize / 1024).toFixed(1)}KB\n\nä½¿ç”¨è¯´æ˜ï¼š\n1. å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åˆ°ç½‘ç«™æ ¹ç›®å½•\n2. ä¸‹æ¬¡æœç´¢æ—¶å°†è‡ªåŠ¨åŠ è½½ï¼Œå¤§å¤§æå‡é€Ÿåº¦\n3. ç´¢å¼•æ–‡ä»¶å°†æŒç»­æœ‰æ•ˆï¼Œæ— éœ€é‡æ–°ä¸‹è½½`);
            }, 1000);
        }

        // ä¸‹è½½æ–‡ä»¶çš„é€šç”¨å‡½æ•°
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log(`æ–‡ä»¶ ${filename} ä¸‹è½½å®Œæˆ`);
        }





        // æ˜¾ç¤ºåŠ è½½è¿›åº¦
        function showLoadingProgress(message) {
            // ç§»é™¤å·²å­˜åœ¨çš„è¿›åº¦æç¤º
            hideLoadingProgress();

            const progressDiv = document.createElement('div');
            progressDiv.id = 'loading-progress';
            progressDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 8px;
        z-index: 10002;
        text-align: center;
        font-size: 0.9rem;
        min-width: 200px;
      `;

            progressDiv.innerHTML = `
        <div style="margin-bottom: 10px;">${message}</div>
        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
          <div style="width: 100%; height: 100%; background: #006400; animation: pulse 1.5s ease-in-out infinite;"></div>
        </div>
        <style>
          @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
          }
        </style>
      `;

            document.body.appendChild(progressDiv);
        }

        // æ›´æ–°åŠ è½½è¿›åº¦æ¶ˆæ¯
        function updateLoadingProgress(message) {
            const progressDiv = document.getElementById('loading-progress');
            if (progressDiv) {
                const messageDiv = progressDiv.querySelector('div');
                if (messageDiv) {
                    messageDiv.textContent = message;
                }
            }
        }

        // éšè—åŠ è½½è¿›åº¦
        function hideLoadingProgress() {
            const progressDiv = document.getElementById('loading-progress');
            if (progressDiv) {
                progressDiv.remove();
            }
        }

        // æ˜¾ç¤ºç´¢å¼•ç®¡ç†ç•Œé¢
        function showIndexManagement() {
            // åˆ›å»ºç®¡ç†ç•Œé¢
            const managementDiv = document.createElement('div');
            managementDiv.id = 'index-management';
            managementDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #006400;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        z-index: 10001;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        font-size: 0.9rem;
      `;

            const indexStatus = searchIndex.length > 0 ?
                `âœ… å·²åŠ è½½ ${searchIndex.length} ä¸ªç« èŠ‚` :
                'âŒ ç´¢å¼•æœªæ„å»º';

            const loadedFrom = indexLoaded ? 'ğŸ“ ä»æ–‡ä»¶åŠ è½½' : 'ğŸ”¨ å®æ—¶æ„å»º';

            managementDiv.innerHTML = `
        <div style="margin-bottom: 15px; font-weight: bold; color: #006400; text-align: center;">
          ğŸ”§ æœç´¢ç´¢å¼•ç®¡ç†
        </div>

        <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
          <div style="margin-bottom: 5px;"><strong>å½“å‰çŠ¶æ€ï¼š</strong> ${indexStatus}</div>
          <div style="margin-bottom: 5px;"><strong>åŠ è½½æ–¹å¼ï¼š</strong> ${loadedFrom}</div>
          <div><strong>ç´¢å¼•å¤§å°ï¼š</strong> ${(JSON.stringify(searchIndex).length / 1024).toFixed(1)} KB</div>
        </div>



        <div style="margin-bottom: 15px; font-size: 0.8rem; color: #666; line-height: 1.4;">
          <strong>è¯´æ˜ï¼š</strong><br>
          â€¢ ä¸‹è½½ç´¢å¼•æ–‡ä»¶å¯ä»¥å¤§å¤§æå‡æœç´¢é€Ÿåº¦<br>
          â€¢ å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åˆ°ç½‘ç«™æ ¹ç›®å½•å³å¯<br>
          â€¢ ç´¢å¼•æ–‡ä»¶å°†æŒç»­æœ‰æ•ˆï¼Œæ— éœ€é‡æ–°ä¸‹è½½<br>

        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
          <button onclick="downloadSearchIndexWithConfig()" style="
            background: #006400;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
          ">ğŸ“¥ ä¸‹è½½ç´¢å¼•</button>

          <button onclick="rebuildSearchIndex()" style="
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
          ">ğŸ”„ é‡å»ºç´¢å¼•</button>

          <button onclick="closeIndexManagement()" style="
            background: #ccc;
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
          ">âŒ å…³é—­</button>
        </div>
      `;

            // æ·»åŠ èƒŒæ™¯é®ç½©
            const overlay = document.createElement('div');
            overlay.id = 'index-management-overlay';
            overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
      `;

            overlay.addEventListener('click', closeIndexManagement);

            // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            document.documentElement.classList.add('modal-open');
            document.body.style.overflow = 'hidden';

            document.body.appendChild(overlay);
            document.body.appendChild(managementDiv);
        }

        // å…³é—­ç´¢å¼•ç®¡ç†ç•Œé¢
        function closeIndexManagement() {
            const managementDiv = document.getElementById('index-management');
            const overlay = document.getElementById('index-management-overlay');

            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.documentElement.classList.remove('modal-open');
            document.body.style.overflow = '';

            if (managementDiv) managementDiv.remove();
            if (overlay) overlay.remove();
        }

        // é‡å»ºæœç´¢ç´¢å¼•
        async function rebuildSearchIndex() {
            if (!confirm('ç¡®å®šè¦é‡å»ºæœç´¢ç´¢å¼•å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ã€‚')) {
                return;
            }

            try {
                // æ¸…ç©ºç°æœ‰ç´¢å¼•
                searchIndex = [];
                indexLoaded = false;

                console.log('å¼€å§‹é‡å»ºæœç´¢ç´¢å¼•...');

                // æ˜¾ç¤ºè¿›åº¦
                const managementDiv = document.getElementById('index-management');
                if (managementDiv) {
                    managementDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="margin-bottom: 15px; font-weight: bold; color: #006400;">
                ğŸ”„ æ­£åœ¨é‡å»ºç´¢å¼•...
              </div>
              <div style="margin-bottom: 10px;">è¯·ç¨å€™ï¼Œæ­£åœ¨æ‰«ææ‰€æœ‰ç« èŠ‚</div>
              <div style="width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden;">
                <div style="width: 100%; height: 100%; background: #006400; animation: pulse 1.5s ease-in-out infinite;"></div>
              </div>
            </div>
            <style>
              @keyframes pulse {
                0%, 100% { opacity: 0.6; }
                50% { opacity: 1; }
              }
            </style>
          `;
                }

                // é‡å»ºç´¢å¼•
                await buildSearchIndex();

                console.log('æœç´¢ç´¢å¼•é‡å»ºå®Œæˆ');

                // å…³é—­ç®¡ç†ç•Œé¢
                closeIndexManagement();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert(`æœç´¢ç´¢å¼•é‡å»ºå®Œæˆï¼\n\nå…±ç´¢å¼• ${searchIndex.length} ä¸ªç« èŠ‚\nå»ºè®®ä¸‹è½½ç´¢å¼•æ–‡ä»¶ä»¥æå‡ä¸‹æ¬¡æœç´¢é€Ÿåº¦`);

                // æ˜¾ç¤ºä¸‹è½½æç¤º
                showIndexDownloadPrompt();

            } catch (error) {
                console.error('é‡å»ºæœç´¢ç´¢å¼•å¤±è´¥:', error);
                alert('é‡å»ºæœç´¢ç´¢å¼•å¤±è´¥: ' + error.message);
                closeIndexManagement();
            }
        }

        // æ˜¾ç¤ºè„šæ³¨å¼¹çª— - ä½¿ç”¨ dialog å…ƒç´ 
        function showFootnoteDialog(event, element) {
            event.preventDefault();
            event.stopPropagation();

            const content = element.getAttribute('data-footnote-content');
            const footnoteId = element.getAttribute('data-footnote-key') || element.textContent;
            const paragraphIndex = element.getAttribute('data-paragraph-index');
            const sectionNumber = element.getAttribute('data-section-number');

            // è·å–å½“å‰é¡µé¢çš„ä¹¦ç±å’Œç« èŠ‚ä¿¡æ¯
            const params = new URLSearchParams(window.location.search);
            const currentDir = params.get('dir') || '';
            let bookName = '';
            let chapterName = currentChapter || '';

            // ä»ç›®å½•è·¯å¾„ä¸­æå–ä¹¦ç±å
            if (currentDir) {
                const dirParts = currentDir.split('/').filter(part => part.trim() !== '');
                if (dirParts.length > 0) {
                    bookName = dirParts[dirParts.length - 1]; // å–æœ€åä¸€ä¸ªéƒ¨åˆ†ä½œä¸ºä¹¦ç±å
                }
            }

            // è§£æè„šæ³¨å†…å®¹ä¸­çš„Markdownï¼ˆæ”¯æŒåˆ†æ®µï¼‰
            let processedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // ç²—ä½“
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // æ–œä½“
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>'); // é“¾æ¥

            // å¤„ç†åˆ†æ®µï¼šå°†è¿ç»­çš„æ¢è¡Œè½¬æ¢ä¸ºæ®µè½
            processedContent = processedContent
                .split('\n\n')  // æŒ‰åŒæ¢è¡Œåˆ†å‰²æ®µè½
                .map(paragraph => {
                    const trimmed = paragraph.trim();
                    if (trimmed === '') return '';
                    // å°†å•ä¸ªæ®µè½åŒ…è£…åœ¨<p>æ ‡ç­¾ä¸­ï¼Œä¿ç•™æ®µè½å†…çš„å•æ¢è¡Œä¸º<br>
                    return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`;
                })
                .filter(p => p !== '')  // è¿‡æ»¤ç©ºæ®µè½
                .join('');  // è¿æ¥æ‰€æœ‰æ®µè½

            // ä½¿ç”¨æ–°çš„æ ‡é¢˜ç”Ÿæˆå‡½æ•°
            const titleText = generateFootnoteTitle(bookName, chapterName, sectionNumber, footnoteId);

            // è·å– dialog å…ƒç´ 
            const dialog = document.getElementById('footnote-dialog');
            const titleElement = document.getElementById('footnote-title');
            const contentElement = document.getElementById('footnote-content');

            // è®¾ç½®å†…å®¹
            titleElement.textContent = titleText;
            contentElement.innerHTML = processedContent;

            // ç¦ç”¨èƒŒæ™¯æ»šåŠ¨
            document.body.classList.add('dialog-open');

            // æ£€æŸ¥æ˜¯å¦æœ‰æœç´¢ç»“æœåœ¨æ˜¾ç¤ºï¼Œå¦‚æœæœ‰ï¼Œä¿æŒæœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€
            const floatingResultsContainer = document.getElementById('floating-results-container');
            const floatingSearchContainer = document.getElementById('floating-search-container');

            if ((floatingResultsContainer && floatingResultsContainer.classList.contains('active')) ||
                (floatingSearchContainer && floatingSearchContainer.classList.contains('active'))) {
                // æœç´¢ç›¸å…³å¼¹çª—è¿˜åœ¨æ˜¾ç¤ºï¼Œä¿æŒæ¨¡æ€çŠ¶æ€
                document.documentElement.classList.add('modal-open');
            }

            // æ˜¾ç¤ºå¼¹çª—
            dialog.showModal();

            // æ³¨æ„ï¼šä½¿ç”¨ dialog.showModal() ä¸ä¼šå½±å“é¡µé¢æ»šåŠ¨ä½ç½®
            return false;
        }

        // å¤„ç†ç‚¹å‡»å¤–éƒ¨å…³é—­è„šæ³¨å¼¹çª—
        function handleOutsideClick(event) {
            const dialog = document.getElementById('footnote-dialog');
            if (!dialog || !dialog.open) return;

            const rect = dialog.getBoundingClientRect();
            const isInDialog = (
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom
            );

            // å¦‚æœç‚¹å‡»åœ¨ dialog å¤–éƒ¨ï¼ˆbackdrop åŒºåŸŸï¼‰ï¼Œå…³é—­å¼¹çª—
            if (!isInDialog) {
                closeFootnoteDialog();
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        // æ·»åŠ è§¦æ‘¸æ»šåŠ¨è°ƒè¯•åŠŸèƒ½
        function addTouchScrollDebug(contentElement) {
            // ä½¿ç”¨ç®€å•çš„CSSæ–¹æ¡ˆï¼Œä¾èµ–æµè§ˆå™¨åŸç”Ÿè§¦æ‘¸æ»šåŠ¨
            console.log('è„šæ³¨å¼¹çª—å·²åˆ›å»ºï¼Œä½¿ç”¨åŸç”Ÿè§¦æ‘¸æ»šåŠ¨');
        }

        // å…³é—­è„šæ³¨å¼¹çª—
        function closeFootnoteDialog() {
            const dialog = document.getElementById('footnote-dialog');
            dialog.close();

            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨å…³é—­çš„äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('click', handleOutsideClick);

            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.classList.remove('dialog-open');

            // æ£€æŸ¥æœç´¢ç»“æœæ˜¯å¦è¿˜åœ¨æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯ï¼Œä¿æŒæœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€
            const floatingResultsContainer = document.getElementById('floating-results-container');
            const floatingSearchContainer = document.getElementById('floating-search-container');

            if (floatingResultsContainer && floatingResultsContainer.classList.contains('active')) {
                // æœç´¢ç»“æœè¿˜åœ¨æ˜¾ç¤ºï¼Œä¿æŒæ¨¡æ€çŠ¶æ€
                document.documentElement.classList.add('modal-open');
                console.log('ğŸ”„ è„šæ³¨å¼¹çª—å·²å…³é—­ï¼Œä¿æŒæœç´¢ç»“æœå¼¹çª—çŠ¶æ€');
            } else if (floatingSearchContainer && floatingSearchContainer.classList.contains('active')) {
                // æœç´¢æ¡†è¿˜åœ¨æ˜¾ç¤ºï¼Œä¿æŒæ¨¡æ€çŠ¶æ€
                document.documentElement.classList.add('modal-open');
                console.log('ğŸ”„ è„šæ³¨å¼¹çª—å·²å…³é—­ï¼Œä¿æŒæœç´¢æ¡†å¼¹çª—çŠ¶æ€');
            }
        }

        // å…¼å®¹æ—§çš„å‡½æ•°å - ç»Ÿä¸€ä½¿ç”¨ dialog ç‰ˆæœ¬
        function hideFootnotePopup() {
            closeFootnoteDialog();
        }

        // ç›´æ¥æ˜¾ç¤ºè„šæ³¨å¼¹çª—ï¼ˆç”¨äºæœç´¢ç»“æœï¼‰- ä½¿ç”¨ dialog å…ƒç´ 
        function showDirectFootnotePopup(footnoteKey, footnoteContent, searchTerm = '', bookName = '', chapterName = '', sectionNumber = '') {
            console.log(`ğŸ†• Dialogç‰ˆæœ¬è„šæ³¨å¼¹çª—: é”®="${footnoteKey}", æœç´¢è¯="${searchTerm}", ä½ç½®="${bookName} ${chapterName}:${sectionNumber}"`);

            // é«˜äº®æœç´¢è¯çš„å‡½æ•°
            function highlightSearchTerm(text, term) {
                if (!term) return text;
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark style="background-color: yellow; font-weight: bold;">$1</mark>');
            }

            // è®¾ç½®å¼¹çª—å†…å®¹
            const highlightedContent = highlightSearchTerm(footnoteContent, searchTerm);
            const footnoteTitle = generateFootnoteTitle(bookName, chapterName, sectionNumber, footnoteKey);

            // å¤„ç†å†…å®¹ä¸­çš„Markdownï¼ˆä¸åŸæœ‰è„šæ³¨å¼¹çª—ä¿æŒä¸€è‡´ï¼‰
            let processedContent = highlightedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // ç²—ä½“
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // æ–œä½“
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>') // é“¾æ¥
                .split('\n\n')  // æŒ‰åŒæ¢è¡Œåˆ†å‰²æ®µè½
                .map(paragraph => {
                    const trimmed = paragraph.trim();
                    if (trimmed === '') return '';
                    // å°†å•ä¸ªæ®µè½åŒ…è£…åœ¨<p>æ ‡ç­¾ä¸­ï¼Œä¿ç•™æ®µè½å†…çš„å•æ¢è¡Œä¸º<br>
                    return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`;
                })
                .filter(p => p !== '')  // è¿‡æ»¤ç©ºæ®µè½
                .join('');  // è¿æ¥æ‰€æœ‰æ®µè½

            // è·å– dialog å…ƒç´ 
            const dialog = document.getElementById('footnote-dialog');
            const titleElement = document.getElementById('footnote-title');
            const contentElement = document.getElementById('footnote-content');

            // è®¾ç½®å†…å®¹
            titleElement.textContent = footnoteTitle;
            contentElement.innerHTML = processedContent;

            // ç¦ç”¨èƒŒæ™¯æ»šåŠ¨ï¼ˆä¿æŒæœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€ï¼‰
            document.body.classList.add('dialog-open');
            // ç¡®ä¿æœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€ä¹Ÿä¿æŒ
            document.documentElement.classList.add('modal-open');

            // æ˜¾ç¤ºå¼¹çª—
            dialog.showModal();

            // æ³¨æ„ï¼šä½¿ç”¨ dialog.showModal() ä¸ä¼šå½±å“é¡µé¢æ»šåŠ¨ä½ç½®

            // æ·»åŠ è§¦æ‘¸æ»šåŠ¨è°ƒè¯•
            addTouchScrollDebug(contentElement);

            // å»¶è¿Ÿæ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);

            console.log('âœ… æ–°ç‰ˆæœ¬è„šæ³¨å¼¹çª—å·²æ˜¾ç¤º - çº¯CSSæ ·å¼');
        }

        // æ˜¾ç¤ºç»æ–‡å¼¹çª—ï¼ˆç”¨äºæœç´¢ç»“æœï¼‰- ä½¿ç”¨ dialog å…ƒç´ 
        function showVersePopup(verseData, searchTerm = '') {
            console.log(`ğŸ“– æ˜¾ç¤ºç»æ–‡å¼¹çª—: ${verseData.title}, æœç´¢è¯="${searchTerm}"`);

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            hideFootnotePopup();

            // é«˜äº®æœç´¢è¯çš„å‡½æ•°
            function highlightSearchTerm(text, term) {
                if (!term) return text;
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark style="background-color: yellow; font-weight: bold;">$1</mark>');
            }

            // å¤„ç†ç»æ–‡å†…å®¹
            const highlightedContent = highlightSearchTerm(verseData.content, searchTerm);

            // æ„å»ºæ­£ç¡®çš„æ ‡é¢˜
            let displayTitle = verseData.title;
            if (verseData.actualBookName && verseData.chapterName && verseData.verseNumber) {
                displayTitle = `${verseData.actualBookName}${verseData.chapterName}:${verseData.verseNumber}`;
            }

            // å¤„ç†å†…å®¹æ ¼å¼ï¼ˆä¸è„šæ³¨å¼¹çª—ä¿æŒä¸€è‡´ï¼‰
            const processedContent = highlightedContent
                .split(/\n\s*\n/)  // æŒ‰åŒæ¢è¡Œåˆ†å‰²æ®µè½
                .map(paragraph => {
                    const trimmed = paragraph.trim();
                    if (trimmed === '') return '';
                    // å°†å•ä¸ªæ®µè½åŒ…è£…åœ¨<p>æ ‡ç­¾ä¸­ï¼Œä¿ç•™æ®µè½å†…çš„å•æ¢è¡Œä¸º<br>
                    return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`;
                })
                .filter(p => p !== '')  // è¿‡æ»¤ç©ºæ®µè½
                .join('');  // è¿æ¥æ‰€æœ‰æ®µè½

            // è·å– dialog å…ƒç´ 
            const dialog = document.getElementById('footnote-dialog');
            const titleElement = document.getElementById('footnote-title');
            const contentElement = document.getElementById('footnote-content');

            // è®¾ç½®å†…å®¹
            titleElement.textContent = `ğŸ“– ${displayTitle}`;
            contentElement.innerHTML = processedContent;

            // ç¦ç”¨èƒŒæ™¯æ»šåŠ¨ï¼ˆä¿æŒæœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€ï¼‰
            document.body.classList.add('dialog-open');
            // ç¡®ä¿æœç´¢ç»“æœçš„æ¨¡æ€çŠ¶æ€ä¹Ÿä¿æŒ
            document.documentElement.classList.add('modal-open');

            // æ˜¾ç¤ºå¼¹çª—
            dialog.showModal();

            // å»¶è¿Ÿæ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);

            console.log('âœ… ç»æ–‡å¼¹çª—å·²æ˜¾ç¤º - ä½¿ç”¨ dialog å…ƒç´ ');

            // å»¶è¿Ÿæ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);

            console.log('âœ… ç»æ–‡å¼¹çª—å·²æ˜¾ç¤º - ä½¿ç”¨ dialog å…ƒç´ ');
        }

        // ç‰ˆæœ¬æ£€æŸ¥å‡½æ•°
        function checkFootnoteVersion() {
            console.log('=== è„šæ³¨å¼¹çª—ç‰ˆæœ¬æ£€æŸ¥ ===');
            console.log('å½“å‰æ—¶é—´:', new Date().toLocaleString());
            console.log('showDirectFootnotePopupå‡½æ•°å­˜åœ¨:', typeof showDirectFootnotePopup === 'function');
            console.log('ç‰ˆæœ¬: 2025-07-12 æ–°ç‰ˆæœ¬ - çº¯CSSæ ·å¼');

            // æµ‹è¯•å¼¹çª—
            showDirectFootnotePopup('test', 'è¿™æ˜¯ç‰ˆæœ¬æ£€æŸ¥æµ‹è¯•å¼¹çª—ï¼Œåº”è¯¥ä½¿ç”¨çº¯CSSæ ·å¼', '', 'æµ‹è¯•', 'ç‰ˆæœ¬', 'æ£€æŸ¥');
        }

        // å…¨å±ç« èŠ‚å¼¹çª—åŠŸèƒ½
        function loadChapterInModal(bookPath, chapterName, searchTerm = '', customTitle = '', clickedElement = null, matchPosition = 1) {
            console.log(`ğŸ“– åœ¨å¼¹çª—ä¸­åŠ è½½ç« èŠ‚: ${bookPath}/${chapterName}, æœç´¢è¯="${searchTerm}", åŒ¹é…ä½ç½®=${matchPosition}`);

            // åˆ›å»ºå…¨å±å¼¹çª—
            const dialog = document.createElement('dialog');
            dialog.id = 'chapter-modal-dialog';
            dialog.className = 'chapter-modal-dialog';

            // ç”Ÿæˆå¼¹çª—æ ‡é¢˜
            const modalTitle = customTitle || generateModalTitle(bookPath, chapterName, clickedElement);

            dialog.innerHTML = `
                <div class="chapter-modal-content">
                    <div class="chapter-modal-header">
                        <h2 class="chapter-modal-title">${modalTitle}</h2>
                        <div class="chapter-modal-controls">
                            <button id="close-chapter-modal-btn" class="modal-close-btn" title="å…³é—­">âœ•</button>
                        </div>
                    </div>
                    <div class="chapter-modal-body">
                        <div id="chapter-modal-loading" class="modal-loading">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</p>
                        </div>
                        <div id="chapter-modal-content" class="modal-chapter-content" style="display: none;"></div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialog);

            // æ˜¾ç¤ºå¼¹çª—
            dialog.showModal();

            // Safari å…¼å®¹æ€§ä¿®å¤
            if (isSafari()) {
                setTimeout(() => {
                    dialog.style.position = 'fixed';
                    dialog.style.top = '0';
                    dialog.style.left = '0';
                    dialog.style.width = '100vw';
                    dialog.style.height = '100vh';
                    dialog.style.margin = '0';
                    dialog.style.padding = '0';
                    dialog.style.border = 'none';
                    dialog.style.outline = 'none';
                    dialog.style.zIndex = '10001';
                }, 10);
            }

            // ç»‘å®šå…³é—­äº‹ä»¶
            const closeBtn = dialog.querySelector('#close-chapter-modal-btn');
            closeBtn.addEventListener('click', () => {
                closeChapterModal();
            });

            // ç»‘å®šESCé”®å…³é—­
            dialog.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeChapterModal();
                }
            });

            // ç»‘å®šç‚¹å‡»èƒŒæ™¯å…³é—­
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    closeChapterModal();
                }
            });

            // å¼‚æ­¥åŠ è½½ç« èŠ‚å†…å®¹
            loadChapterContentInModal(bookPath, chapterName, searchTerm, matchPosition);

            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºå¯¼èˆª
            window.currentModalChapter = {
                bookPath: bookPath,
                chapterName: chapterName,
                searchTerm: searchTerm,
                matchPosition: matchPosition
            };
        }

        // å…³é—­å…¨å±ç« èŠ‚å¼¹çª—
        function closeChapterModal() {
            const dialog = document.getElementById('chapter-modal-dialog');
            if (dialog) {
                dialog.close();
                dialog.remove();
            }
            window.currentModalChapter = null;
        }

        // å¤„ç†å…¨å±å¼¹çª—ä¸­çš„é“¾æ¥ç‚¹å‡» - åœ¨å½“å‰å¼¹çª—ä¸­åŠ è½½æ–°å†…å®¹
        function handleModalLinkClick(event, href, currentBookPath) {
            event.preventDefault();

            console.log('å¼¹çª—é“¾æ¥ç‚¹å‡»:', href, 'å½“å‰è·¯å¾„:', currentBookPath);

            if (href && href.includes(".md")) {
                // ä»hrefä¸­æå–è·¯å¾„ä¿¡æ¯
                const pathParts = href.split('/');
                const fileName = pathParts[pathParts.length - 1];

                let relativePath = '';

                // å¤„ç†ç›¸å¯¹è·¯å¾„ï¼ˆä»¥ ./ å¼€å¤´ï¼‰
                if (href.startsWith('./')) {
                    // ç§»é™¤å¼€å¤´çš„ ./
                    const cleanPath = href.replace('./', '');
                    const cleanPathParts = cleanPath.split('/');

                    if (fileName === 'toc.md') {
                        // å¦‚æœæ˜¯ç›®å½•é“¾æ¥ï¼Œä¿ç•™çˆ¶ç›®å½•è·¯å¾„
                        if (currentBookPath) {
                            relativePath = currentBookPath + cleanPathParts[0];
                        } else {
                            relativePath = cleanPathParts[0];
                        }
                    } else {
                        // å¦‚æœæ˜¯ç« èŠ‚é“¾æ¥ï¼Œéœ€è¦æ„å»ºå®Œæ•´çš„ç›®å½•è·¯å¾„
                        if (cleanPathParts.length > 1) {
                            // å¦‚æœè·¯å¾„ä¸­åŒ…å«å­ç›®å½•ï¼ˆå¦‚ ./èµæ/3.mdï¼‰
                            const subDirParts = cleanPathParts.slice(0, -1); // ç§»é™¤æ–‡ä»¶åï¼Œä¿ç•™ç›®å½•éƒ¨åˆ†
                            if (currentBookPath) {
                                relativePath = currentBookPath + subDirParts.join('/');
                            } else {
                                relativePath = subDirParts.join('/');
                            }
                        } else {
                            // å¦‚æœåªæ˜¯æ–‡ä»¶åï¼ˆå¦‚ ./3.mdï¼‰ï¼Œä½¿ç”¨å½“å‰ç›®å½•
                            relativePath = currentBookPath;
                        }
                    }
                } else {
                    // å¤„ç†ç»å¯¹è·¯å¾„
                    if (pathParts.length > 1) {
                        relativePath = pathParts.slice(0, -1)
                            .join('/')
                            .replace(/^books\//, '')  // ç§»é™¤å¼€å¤´çš„ books/
                            .replace(/^\/+|\/+$/g, ''); // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„æ–œæ 
                    } else {
                        relativePath = currentBookPath;
                    }
                }

                // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                relativePath = relativePath.replace(/^\/+|\/+$/g, '');

                // ä¸å…³é—­å¼¹çª—ï¼Œè€Œæ˜¯åœ¨å½“å‰å¼¹çª—ä¸­åŠ è½½æ–°å†…å®¹
                const chapterName = fileName.replace(".md", "");
                console.log('åœ¨å¼¹çª—ä¸­åŠ è½½æ–°ç« èŠ‚:', chapterName, 'è·¯å¾„:', relativePath);

                // æ›´æ–°å¼¹çª—æ ‡é¢˜
                const titleElement = document.querySelector('.chapter-modal-title');
                if (titleElement) {
                    titleElement.textContent = `æ­£åœ¨åŠ è½½ ${chapterName}...`;
                }

                // åœ¨å½“å‰å¼¹çª—ä¸­åŠ è½½æ–°å†…å®¹
                loadChapterContentInModal(relativePath, chapterName, '', 1);

                // æ›´æ–°å½“å‰å¼¹çª—çŠ¶æ€
                if (window.currentModalChapter) {
                    window.currentModalChapter.bookPath = relativePath;
                    window.currentModalChapter.chapterName = chapterName;
                }
            }
        }

        // åœ¨å¼¹çª—ä¸­åŠ è½½ç« èŠ‚å†…å®¹
        async function loadChapterContentInModal(bookPath, chapterName, searchTerm = '', matchPosition = 1) {
            const loadingDiv = document.getElementById('chapter-modal-loading');
            const contentDiv = document.getElementById('chapter-modal-content');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';

                // æ„å»ºæ–‡ä»¶è·¯å¾„ - ä¿®å¤åŒæ–œæ é—®é¢˜
                let normalizedBookPath = bookPath;
                if (!normalizedBookPath.endsWith('/')) {
                    normalizedBookPath += '/';
                }

                // æ„å»ºå®Œæ•´è·¯å¾„ï¼Œæ·»åŠ bookså‰ç¼€
                const filePath = `books/${normalizedBookPath}${chapterName}.md`;
                console.log(`åŠ è½½ç« èŠ‚æ–‡ä»¶: ${filePath}`);

                // åŠ è½½æ–‡ä»¶å†…å®¹
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();

                // å¤„ç†å†…å®¹ï¼ˆè½¬æ¢Markdownç­‰ï¼‰
                const processedContent = await processChapterContent(content, bookPath, chapterName);

                // æ˜¾ç¤ºå†…å®¹
                contentDiv.innerHTML = processedContent;

                // æ›´æ–°å¼¹çª—æ ‡é¢˜ - åªåœ¨æ²¡æœ‰ä»æœç´¢ç»“æœæå–æ ‡é¢˜æ—¶æ‰æ›´æ–°
                const titleElement = document.querySelector('.chapter-modal-title');
                if (titleElement) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä»æœç´¢ç»“æœæå–çš„æ ‡é¢˜ï¼ˆåŒ…å« " > " æˆ– " - "ï¼‰
                    const currentTitle = titleElement.textContent;
                    const hasExtractedTitle = currentTitle.includes(' > ') ||
                        (currentTitle.includes(' - ') && currentTitle.split(' - ').length > 2);

                    // åªæœ‰åœ¨æ²¡æœ‰æå–æ ‡é¢˜çš„æƒ…å†µä¸‹æ‰æ›´æ–°
                    if (!hasExtractedTitle) {
                        // å°è¯•ä»å¤„ç†åçš„å†…å®¹ä¸­æå–ç¬¬ä¸€ä¸ªh1æ ‡é¢˜
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = processedContent;
                        const h1Element = tempDiv.querySelector('h1');

                        if (h1Element) {
                            titleElement.textContent = h1Element.textContent;
                        } else {
                            // å¦‚æœæ²¡æœ‰h1æ ‡é¢˜ï¼Œä½¿ç”¨ç« èŠ‚åç§°
                            titleElement.textContent = `${bookPath.replace(/\/$/, '').split('/').pop()} - ${chapterName}`;
                        }
                    }
                }

                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

                // å¦‚æœæœ‰æœç´¢è¯ï¼Œè¿›è¡Œé«˜äº®
                if (searchTerm) {
                    highlightModalSearchTerm(searchTerm, matchPosition);
                }

                console.log('âœ… ç« èŠ‚å†…å®¹åŠ è½½å®Œæˆ');

            } catch (error) {
                console.error('âŒ åŠ è½½ç« èŠ‚å†…å®¹å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                contentDiv.innerHTML = `
                    <div class="error-message">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•åŠ è½½ç« èŠ‚å†…å®¹: ${error.message}</p>
                        <button onclick="closeChapterModal()" class="retry-btn">å…³é—­</button>
                    </div>
                `;

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            }
        }

        // ç”Ÿæˆå¼¹çª—æ ‡é¢˜ - ä»æœç´¢ç»“æœæ ‡é¢˜ä¸­æå–
        function generateModalTitle(bookPath, chapterName, clickedElement = null) {
            console.log(`ç”Ÿæˆå¼¹çª—æ ‡é¢˜: bookPath="${bookPath}", chapterName="${chapterName}"`);

            // å°è¯•ä»ç‚¹å‡»çš„å…ƒç´ ä¸­è·å–æœç´¢ç»“æœæ ‡é¢˜
            if (clickedElement) {
                try {
                    // å‘ä¸ŠæŸ¥æ‰¾æœç´¢ç»“æœå®¹å™¨
                    let resultContainer = clickedElement.closest('.search-result-item');
                    if (resultContainer) {
                        // æŸ¥æ‰¾æ ‡é¢˜å…ƒç´ 
                        const titleElement = resultContainer.querySelector('.search-result-title');
                        if (titleElement) {
                            // æå–æ ‡é¢˜æ–‡æœ¬ï¼Œå»æ‰åŒ¹é…è®¡æ•°å’Œå±•å¼€å›¾æ ‡
                            let titleText = titleElement.textContent || titleElement.innerText;

                            // æ¸…ç†æ ‡é¢˜æ–‡æœ¬
                            titleText = titleText
                                .replace(/\(\d+å¤„åŒ¹é…\)/g, '') // ç§»é™¤åŒ¹é…è®¡æ•°
                                .replace(/[â–¼â–¶]/g, '') // ç§»é™¤å±•å¼€å›¾æ ‡
                                .replace(/\s+/g, ' ') // è§„èŒƒåŒ–ç©ºç™½å­—ç¬¦
                                .trim(); // å»æ‰é¦–å°¾ç©ºç™½

                            if (titleText) {
                                console.log(`ä»æœç´¢ç»“æœæ ‡é¢˜æå–: "${titleText}"`);
                                return titleText;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('ä»æœç´¢ç»“æœæ ‡é¢˜æå–å¤±è´¥:', error);
                }
            }

            // å›é€€åˆ°åŸæ¥çš„é€»è¾‘
            if (bookPath.includes('åœ£ç»ç ”è¯»')) {
                // åœ£ç»ç ”è¯»æ ¼å¼ï¼šåˆ›ä¸–è®° 1:1
                const pathParts = bookPath.split('/');
                const bookName = pathParts.length >= 2 ? pathParts[pathParts.length - 2] : '';
                return `${bookName} ${chapterName}`;
            } else {
                // å…¶ä»–åˆ†ç±»æ ¼å¼ï¼šå®Œæ•´è·¯å¾„ > ç« èŠ‚å
                const pathParts = bookPath.split('/').filter(part => part);
                const displayPath = pathParts.slice(0, -1).join(' > '); // å»æ‰æœ€åçš„ç©ºå­—ç¬¦ä¸²
                return `${displayPath} > ${chapterName}`;
            }
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šçš„åŒ¹é…ä½ç½®
        function scrollToTargetMatch(element, matchNumber, totalMatches) {
            if (!element) return;

            console.log(`ğŸ¯ æ»šåŠ¨åˆ°ç¬¬ ${matchNumber} ä¸ªåŒ¹é…ä½ç½®ï¼ˆå…± ${totalMatches} ä¸ªï¼‰`);

            // è·å–å¼¹çª—å†…å®¹å®¹å™¨
            const modalContent = document.getElementById('chapter-modal-content');
            if (!modalContent) return;

            // è®¡ç®—å…ƒç´ ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
            const elementRect = element.getBoundingClientRect();
            const containerRect = modalContent.getBoundingClientRect();

            // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼ˆå°†åŒ¹é…å…ƒç´ æ»šåŠ¨åˆ°å®¹å™¨ä¸­å¤®åä¸Šçš„ä½ç½®ï¼‰
            const scrollTop = modalContent.scrollTop + elementRect.top - containerRect.top - 100;

            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
            modalContent.scrollTo({
                top: Math.max(0, scrollTop),
                behavior: 'smooth'
            });

            // æ·»åŠ ä¸´æ—¶çš„é—ªçƒæ•ˆæœæ¥çªå‡ºæ˜¾ç¤ºç›®æ ‡åŒ¹é…
            element.style.transition = 'background-color 0.3s ease';
            element.style.backgroundColor = '#ff6b6b';

            setTimeout(() => {
                element.style.backgroundColor = '#ffeb3b'; // æ¢å¤åŸæ¥çš„é«˜äº®é¢œè‰²
            }, 600);

            console.log(`âœ… å·²æ»šåŠ¨åˆ°ç¬¬ ${matchNumber} ä¸ªåŒ¹é…ä½ç½®`);
        }

        // å¤„ç†ç« èŠ‚å†…å®¹ï¼ˆè½¬æ¢Markdownç­‰ï¼‰
        async function processChapterContent(content, bookPath, chapterName) {
            try {
                // ä½¿ç”¨ç°æœ‰çš„Markdownå¤„ç†é€»è¾‘
                if (typeof marked !== 'undefined') {
                    // å¤„ç†è„šæ³¨ - æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
                    let processedMarkdown = content;
                    let footnotes = {};

                    if (typeof processFootnotes === 'function') {
                        const result = processFootnotes(content);
                        processedMarkdown = result.markdownText;
                        footnotes = result.footnotes;
                    }

                    // é…ç½®markedæ¸²æŸ“å™¨
                    const renderer = new marked.Renderer();

                    // å¤„ç†é“¾æ¥ - å‚è€ƒé¡µé¢ä¸»è¦å†…å®¹çš„é“¾æ¥å¤„ç†é€»è¾‘
                    renderer.link = function (token) {
                        const href = token.href;
                        const title = token.title;
                        const text = token.text;

                        if (href && href.includes('.md')) {
                            // ä¸º.mdæ–‡ä»¶åˆ›å»ºå¯è·³è½¬çš„é“¾æ¥
                            return `<a href="#" onclick="handleModalLinkClick(event, '${href}', '${bookPath}')" title="${title || ''}">${text}</a>`;
                        }
                        return `<a href="${href}" title="${title || ''}" target="_blank">${text}</a>`;
                    };

                    // ä½¿ç”¨ä¸é¡µé¢ä¸»è¦å†…å®¹ç›¸åŒçš„å›¾ç‰‡æ‰©å±•
                    const imageExtension = {
                        name: 'image',
                        renderer(token) {
                            let href = token.href;
                            const title = token.title;
                            const text = token.text;

                            // ä¿®å¤å›¾ç‰‡è·¯å¾„å¤„ç†é€»è¾‘
                            const relPrefixes = ['http', 'https', 'data:', '//', '/', '#'];
                            if (!relPrefixes.some(prefix => href.startsWith(prefix))) {
                                const basePath = bookPath ? `books/${bookPath}` : 'books';
                                if (href.startsWith('./')) {
                                    // ç›¸å¯¹è·¯å¾„ï¼š./img/da1.png -> books/è¯—æ­Œåˆè¾‘/å¤§æœ¬è¯—æ­Œ/img/da1.png
                                    href = `${basePath}${href.substring(1)}`;
                                } else {
                                    // ç›´æ¥è·¯å¾„ï¼šimg/da1.png -> books/è¯—æ­Œåˆè¾‘/å¤§æœ¬è¯—æ­Œ/img/da1.png
                                    href = `${basePath}/${href}`;
                                }
                            }

                            // ç”Ÿæˆå›¾ç‰‡HTMLï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                            let html = `<img src="${href}" alt="${text || ''}"`;

                            if (title) {
                                html += ` title="${title}"`;
                            }

                            // æ·»åŠ æ ·å¼å’Œé”™è¯¯å¤„ç†
                            html += ` style="max-width: 100%; height: auto;" loading="lazy"`;
                            html += ` onerror="this.style.display='none'; console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src);"`;
                            html += `>`;

                            return html;
                        }
                    };

                    // ä½¿ç”¨æ‰©å±•å’Œrenderer
                    marked.use({
                        extensions: [imageExtension],
                        renderer: renderer,
                        breaks: true,
                        gfm: true
                    });

                    // è½¬æ¢Markdownä¸ºHTML
                    const htmlContent = marked.parse(processedMarkdown);

                    // é‡ç½®markedé…ç½®ï¼ˆé¿å…å½±å“å…¶ä»–åœ°æ–¹ï¼‰
                    marked.use({ extensions: [] });

                    // å¤„ç†è„šæ³¨å¼•ç”¨
                    return htmlContent.replace(/\[\^([^\]]+)\]/g,
                        '<sup class="footnote-ref" data-footnote="$1" onclick="showFootnoteFromModal(\'$1\', arguments[0])">$1</sup>');
                } else {
                    // å¦‚æœmarkedä¸å¯ç”¨ï¼Œä½¿ç”¨ç®€å•å¤„ç†
                    let processedContent = content
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>');

                    if (processedContent && !processedContent.startsWith('<')) {
                        processedContent = `<p>${processedContent}</p>`;
                    }

                    return processedContent.replace(/\[\^([^\]]+)\]/g,
                        '<sup class="footnote-ref" data-footnote="$1">$1</sup>');
                }
            } catch (error) {
                console.error('å¤„ç†ç« èŠ‚å†…å®¹å¤±è´¥:', error);
                // è¿”å›ç®€å•å¤„ç†çš„å†…å®¹
                return content.replace(/\n/g, '<br>');
            }
        }

        // åœ¨å¼¹çª—ä¸­é«˜äº®æœç´¢è¯
        function highlightModalSearchTerm(searchTerm, targetMatchPosition = 1) {
            const contentDiv = document.getElementById('chapter-modal-content');
            if (!contentDiv || !searchTerm) return;

            console.log(`åœ¨å¼¹çª—ä¸­é«˜äº®æœç´¢è¯: "${searchTerm}", ç›®æ ‡åŒ¹é…ä½ç½®: ${targetMatchPosition}`);

            // åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');

            // éå†æ–‡æœ¬èŠ‚ç‚¹å¹¶é«˜äº®
            const walker = document.createTreeWalker(
                contentDiv,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function (node) {
                        return node.parentNode.tagName !== 'SCRIPT' ?
                            NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                    }
                }
            );

            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                if (regex.test(node.textContent)) {
                    textNodes.push(node);
                }
            }

            // é«˜äº®åŒ¹é…çš„æ–‡æœ¬å¹¶æ”¶é›†æ‰€æœ‰é«˜äº®å…ƒç´ 
            const allHighlights = [];
            textNodes.forEach((textNode) => {
                const highlightedText = textNode.textContent.replace(regex,
                    '<mark class="search-highlight">$1</mark>');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = highlightedText;

                const parent = textNode.parentNode;
                while (tempDiv.firstChild) {
                    parent.insertBefore(tempDiv.firstChild, textNode);
                }
                parent.removeChild(textNode);

                // æ”¶é›†è¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰é«˜äº®å…ƒç´ 
                const highlights = parent.querySelectorAll('mark.search-highlight');
                highlights.forEach(highlight => allHighlights.push(highlight));
            });

            console.log(`âœ… æœç´¢è¯é«˜äº®å®Œæˆï¼Œå¤„ç†äº† ${textNodes.length} ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œå…±æ‰¾åˆ° ${allHighlights.length} ä¸ªåŒ¹é…`);

            // æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®çš„åŒ¹é…
            if (allHighlights.length > 0) {
                // ç¡®ä¿ç›®æ ‡ä½ç½®åœ¨æœ‰æ•ˆèŒƒå›´å†…
                const targetIndex = Math.min(Math.max(targetMatchPosition - 1, 0), allHighlights.length - 1);
                const targetHighlight = allHighlights[targetIndex];

                console.log(`ğŸ¯ æ»šåŠ¨åˆ°ç¬¬ ${targetIndex + 1} ä¸ªåŒ¹é…ä½ç½®ï¼ˆå…± ${allHighlights.length} ä¸ªåŒ¹é…ï¼‰`);

                setTimeout(() => {
                    scrollToTargetMatch(targetHighlight, targetIndex + 1, allHighlights.length);
                }, 100); // ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿DOMæ›´æ–°å®Œæˆ
            }
        }

        // ä»å¼¹çª—ä¸­æ˜¾ç¤ºè„šæ³¨
        function showFootnoteFromModal(footnoteKey, event) {
            console.log(`ä»å¼¹çª—ä¸­æ˜¾ç¤ºè„šæ³¨: ${footnoteKey}`);

            // è¿™é‡Œå¯ä»¥å®ç°å¼¹çª—ä¸­çš„è„šæ³¨æ˜¾ç¤ºé€»è¾‘
            // æš‚æ—¶ä½¿ç”¨ç®€å•çš„alertï¼Œåç»­å¯ä»¥æ”¹ä¸ºå¼¹çª—å†…çš„è„šæ³¨æ˜¾ç¤º
            alert(`è„šæ³¨ ${footnoteKey}: è¿™é‡Œå°†æ˜¾ç¤ºè„šæ³¨å†…å®¹`);

            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
        }

        // è§£æåœ£ç»ç»æ–‡èŠ‚çš„å‡½æ•°
        function parseVerses(chapterContent, bookName, chapterName, chapterPath) {
            const verses = [];
            const lines = chapterContent.split('\n');

            console.log(`ğŸ“– å¼€å§‹è§£æç»æ–‡èŠ‚: ${bookName}${chapterName}`);

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;

                // åŒ¹é…èŠ‚å·æ ¼å¼ï¼š1ã€€ã€2ä¸Šã€€ã€15ä¸‹ã€€ç­‰
                const verseMatch = trimmedLine.match(/^(\d+[ä¸Šä¸­ä¸‹]?)\s+(.+)$/);
                if (verseMatch) {
                    const verseNumber = verseMatch[1];
                    let verseText = verseMatch[2];

                    // å»é™¤è„šæ³¨æ ‡è®°ï¼Œåªä¿ç•™ç»æ–‡æ­£æ–‡
                    const cleanText = verseText.replace(/\[\^[^\]]+\]/g, '');

                    if (cleanText.trim()) {
                        verses.push({
                            title: `${bookName}${chapterName}:${verseNumber}`,
                            content: cleanText.trim(),
                            verseNumber: verseNumber,
                            bookName: "åœ£ç»ç ”è¯»", // è®¾ç½®ä¸º"åœ£ç»"ä»¥ä¾¿æ­£ç¡®åˆ†ç±»
                            actualBookName: bookName, // ä¿å­˜å®é™…çš„ä¹¦å·å
                            chapterName: chapterName,
                            bookPath: chapterPath, // ä½¿ç”¨ä¼ å…¥çš„æ­£ç¡®è·¯å¾„
                            chapterPath: chapterPath,
                            type: "verse"
                        });

                        console.log(`  ğŸ“ è§£æèŠ‚: ${verseNumber} - "${cleanText.substring(0, 30)}..."`);
                    }
                }
            }

            console.log(`ğŸ“Š ${bookName}${chapterName} å…±è§£æå‡º ${verses.length} èŠ‚ç»æ–‡`);
            return verses;
        }

        // ä¸ºç»æ–‡èŠ‚åˆ†é…å±äºè¯¥èŠ‚çš„è„šæ³¨
        function getFootnotesForVerse(allFootnotes, verseNumber) {
            const verseFootnotes = {};

            for (const [key, data] of Object.entries(allFootnotes)) {
                let sectionNumber = '';

                // è·å–è„šæ³¨çš„èŠ‚å·
                if (typeof data === 'object' && data.sectionNumber) {
                    sectionNumber = data.sectionNumber;
                }

                // åªæœ‰å½“è„šæ³¨å±äºè¯¥èŠ‚æ—¶æ‰æ·»åŠ 
                if (sectionNumber === verseNumber) {
                    verseFootnotes[key] = data;
                }
            }

            return verseFootnotes;
        }

        // ç”Ÿæˆè„šæ³¨æ ‡é¢˜çš„é€šç”¨å‡½æ•°
        function generateFootnoteTitle(bookName, chapterName, sectionNumber, footnoteKey) {
            let title = '';

            // æ·»åŠ ä¹¦ç±å’Œç« èŠ‚ä¿¡æ¯
            if (bookName && chapterName) {
                title += `${bookName}${chapterName}`;
                if (sectionNumber) {
                    title += `:${sectionNumber}`;
                }
            }

            // æ ¹æ®è„šæ³¨é”®ç±»å‹æ·»åŠ å‰ç¼€
            let footnoteDisplay = '';
            if (/^\d+$/.test(footnoteKey)) {
                // æ•°å­—è„šæ³¨ï¼šæ˜¾ç¤ºä¸º"æ³¨1", "æ³¨2"ç­‰
                footnoteDisplay = `æ³¨${footnoteKey}`;
            } else if (/^[a-zA-Z]$/.test(footnoteKey)) {
                // å­—æ¯è„šæ³¨ï¼šæ˜¾ç¤ºä¸º"ä¸²a", "ä¸²b"ç­‰
                footnoteDisplay = `ä¸²${footnoteKey}`;
            } else {
                // å…¶ä»–æ ¼å¼ï¼šç›´æ¥æ˜¾ç¤º
                footnoteDisplay = `[^${footnoteKey}]`;
            }

            if (title) {
                return `${title} ${footnoteDisplay}`;
            } else {
                return `è„šæ³¨ ${footnoteDisplay}`;
            }
        }

        // æ£€æŸ¥æœç´¢ç´¢å¼•ä¸­çš„è„šæ³¨æ•°æ®
        function checkFootnoteIndex() {
            console.log('=== æœç´¢ç´¢å¼•è„šæ³¨æ£€æŸ¥ ===');
            console.log('æœç´¢ç´¢å¼•å¤§å°:', searchIndex.length);

            if (searchIndex.length === 0) {
                console.log('âŒ æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œè¯·å…ˆè¿›è¡Œæœç´¢ä»¥æ„å»ºç´¢å¼•');
                return;
            }

            let totalFootnotes = 0;
            let itemsWithFootnotes = 0;
            let newFormatCount = 0;
            let oldFormatCount = 0;

            // æ£€æŸ¥å‰5ä¸ªç´¢å¼•é¡¹
            console.log('\nå‰5ä¸ªç´¢å¼•é¡¹çš„è„šæ³¨æƒ…å†µ:');
            for (let i = 0; i < Math.min(5, searchIndex.length); i++) {
                const item = searchIndex[i];
                const bookName = item.bookName || item.bn || '';
                const title = item.title || item.t || '';
                const footnotes = item.footnotes || item.f || {};

                console.log(`\n${i + 1}. ${bookName} - ${title}`);
                console.log(`   è„šæ³¨å¯¹è±¡:`, footnotes);
                console.log(`   è„šæ³¨æ•°é‡:`, footnotes ? Object.keys(footnotes).length : 0);

                if (footnotes && Object.keys(footnotes).length > 0) {
                    itemsWithFootnotes++;
                    for (const [key, data] of Object.entries(footnotes)) {
                        totalFootnotes++;
                        if (typeof data === 'string') {
                            oldFormatCount++;
                            console.log(`   [^${key}] (æ—§æ ¼å¼): ${data.substring(0, 50)}...`);
                        } else if (typeof data === 'object' && data.content) {
                            newFormatCount++;
                            console.log(`   [^${key}] (æ–°æ ¼å¼): èŠ‚å·="${data.sectionNumber}", å†…å®¹="${data.content.substring(0, 50)}..."`);
                        } else {
                            console.log(`   [^${key}] (æœªçŸ¥æ ¼å¼):`, data);
                        }
                    }
                }
            }

            console.log(`\n=== ç»Ÿè®¡ç»“æœ ===`);
            console.log(`åŒ…å«è„šæ³¨çš„ç´¢å¼•é¡¹: ${itemsWithFootnotes}/${searchIndex.length}`);
            console.log(`æ€»è„šæ³¨æ•°: ${totalFootnotes}`);
            console.log(`æ–°æ ¼å¼è„šæ³¨: ${newFormatCount}`);
            console.log(`æ—§æ ¼å¼è„šæ³¨: ${oldFormatCount}`);

            // æµ‹è¯•è„šæ³¨æœç´¢
            console.log(`\n=== æµ‹è¯•è„šæ³¨æœç´¢ ===`);
            const testTerm = 'ç‹ä¸‹';
            let matchCount = 0;

            for (const item of searchIndex) {
                if (item.footnotes) {
                    for (const [key, data] of Object.entries(item.footnotes)) {
                        let content = '';
                        if (typeof data === 'string') {
                            content = data;
                        } else if (typeof data === 'object' && data.content) {
                            content = data.content;
                        }

                        if (content.toLowerCase().includes(testTerm.toLowerCase())) {
                            matchCount++;
                            console.log(`åŒ¹é… ${matchCount}: [^${key}] åœ¨ ${bookName}/${title} - ${content.substring(0, 30)}...`);
                        }
                    }
                }
            }

            console.log(`æœç´¢"${testTerm}"æ‰¾åˆ° ${matchCount} ä¸ªè„šæ³¨åŒ¹é…`);
        }

        // æµ‹è¯•è„šæ³¨æå–åŠŸèƒ½
        function testFootnoteExtraction() {
            console.log('=== æµ‹è¯•è„šæ³¨æå–åŠŸèƒ½ ===');

            // æµ‹è¯•ç”¨çš„Markdownå†…å®¹ï¼ˆæ¥è‡ªå®é™…æ–‡æ¡£ï¼‰
            const testContent = `1ã€€å½“çŠ¹å¤§ç‹[^a]ä¹Œè¥¿é›…ï¼Œä»¥è‰²åˆ—ç‹çº¦é˜¿æ–½çš„å„¿å­[^b]è€¶ç½—æ³¢å®‰åœ¨ä½çš„æ—¥å­ï¼Œå¤§[^c]åœ°éœ‡å‰äºŒå¹´ï¼Œæå“¥äºšç‰§ç¾Šäººä¸­çš„[^1]é˜¿æ‘©å¸[^2]å¾—äº†è®ºä»¥è‰²åˆ—çš„è¯ã€‚

[^1]:æ„ï¼Œè´Ÿé‡æ‹…è€…ã€‚é˜¿æ‘©å¸é¢„è¨€çš„ä¸­å¿ƒæ€æƒ³ï¼Œä¸ä½•è¥¿é˜¿å’Œçº¦ç¥é¢„è¨€çš„ä¸­å¿ƒæ€æƒ³æä¸ºç›¸ä¼¼ï¼Œå°±æ˜¯è€¶å’Œåæƒ©ç½šåˆ—å›½å¹¶æƒ©æ²»ä»¥è‰²åˆ—ï¼Œå¥½ä¸ºç€å¤§å«çš„å›½(ä¹11ï½12ï¼Œå¾’åäº”15ï½16)ï¼Œå³åŸºç£çš„å›½(å¯åä¸€15)ï¼Œå¸¦è¿›å¤å…´æ—¶ä»£(å¤ªåä¹28)ã€‚

[^2]:ç›´è¯‘ï¼Œçœ‹è§ã€‚

[^a]:ã€€ç‹ä¸‹åå››21ï¼›ä»£ä¸‹äºŒå…­1ï¼›èµ›ä¸€1ï¼›ä½•ä¸€1

[^b]:ã€€ç‹ä¸‹åå››23ï¼›æ‘©ä¸ƒ9ï½11

[^c]:ã€€äºšåå››5

2ã€€ä»–è¯´ï¼Œ[^a]è€¶å’Œåå¿…ä»é”¡å®‰å¼å«ï¼Œä»è€¶è·¯æ’’å†·å‘å£°ï¼›ç‰§äººçš„è‰åœºè¦æ‚²å“€ï¼Œè¿¦å¯†çš„å±±é¡¶è¦æ¯å¹²ã€‚

[^a]:ã€€è€¶äºŒäº”30ï¼›ç¥ä¸‰16`;

            console.log('åŸå§‹å†…å®¹:');
            console.log(testContent);
            console.log('\n=== ä½¿ç”¨ processFootnotesForIndex å¤„ç† ===');

            try {
                const result = processFootnotesForIndex(testContent);
                console.log('æå–çš„è„šæ³¨æ•°é‡:', Object.keys(result.footnotes).length);
                console.log('è„šæ³¨è¯¦æƒ…:');
                for (const [key, data] of Object.entries(result.footnotes)) {
                    console.log(`[^${key}]:`, data);
                }
                console.log('\næ¸…ç†åçš„å†…å®¹:');
                console.log(result.cleanContent);

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è„šæ³¨æ ‡è®°
                const remainingMarks = result.cleanContent.match(/\[\^[^\]]+\]/g);
                if (remainingMarks) {
                    console.log('âŒ è­¦å‘Šï¼šæ¸…ç†åçš„å†…å®¹ä»åŒ…å«è„šæ³¨æ ‡è®°:', remainingMarks);
                } else {
                    console.log('âœ… æ¸…ç†åçš„å†…å®¹å·²å»é™¤æ‰€æœ‰è„šæ³¨æ ‡è®°');
                }

                return result;
            } catch (error) {
                console.error('è„šæ³¨å¤„ç†å‡ºé”™:', error);
                return null;
            }
        }

        // æµ‹è¯•é‡å¤è„šæ³¨é”®çš„å¤„ç†
        function testDuplicateFootnotes() {
            console.log('=== æµ‹è¯•é‡å¤è„šæ³¨é”®å¤„ç† ===');

            // æ¨¡æ‹Ÿæœ‰é‡å¤è„šæ³¨é”®çš„å†…å®¹
            const testContent = `1ã€€ç¬¬ä¸€æ®µå†…å®¹[^1]å’Œ[^a]è„šæ³¨ã€‚

[^1]:ç¬¬ä¸€ä¸ªè„šæ³¨1çš„å†…å®¹ã€‚
[^a]:ç¬¬ä¸€ä¸ªè„šæ³¨açš„å†…å®¹ã€‚

2ã€€ç¬¬äºŒæ®µå†…å®¹[^1]å’Œ[^a]è„šæ³¨ã€‚

[^1]:ç¬¬äºŒä¸ªè„šæ³¨1çš„å†…å®¹ï¼ˆä¸åŒäºç¬¬ä¸€ä¸ªï¼‰ã€‚
[^a]:ç¬¬äºŒä¸ªè„šæ³¨açš„å†…å®¹ï¼ˆä¸åŒäºç¬¬ä¸€ä¸ªï¼‰ã€‚

3ã€€ç¬¬ä¸‰æ®µå†…å®¹[^1]è„šæ³¨ã€‚

[^1]:ç¬¬ä¸‰ä¸ªè„šæ³¨1çš„å†…å®¹ï¼ˆåˆä¸åŒï¼‰ã€‚`;

            console.log('æµ‹è¯•å†…å®¹:');
            console.log(testContent);
            console.log('\n=== å¤„ç†ç»“æœ ===');

            const result = processFootnotesForIndex(testContent);
            console.log('\n=== åˆ†æç»“æœ ===');
            console.log('æå–çš„è„šæ³¨æ€»æ•°:', Object.keys(result.footnotes).length);
            console.log('é¢„æœŸåº”è¯¥æœ‰6ä¸ªä¸åŒçš„è„šæ³¨ï¼ˆ3ä¸ª[^1] + 3ä¸ª[^a]ï¼‰');

            // æŒ‰åŸå§‹é”®åˆ†ç»„
            const groupedByOriginal = {};
            for (const [uniqueKey, data] of Object.entries(result.footnotes)) {
                const originalKey = data.originalKey || uniqueKey;
                if (!groupedByOriginal[originalKey]) {
                    groupedByOriginal[originalKey] = [];
                }
                groupedByOriginal[originalKey].push({ uniqueKey, content: data.content });
            }

            console.log('\næŒ‰åŸå§‹é”®åˆ†ç»„:');
            for (const [originalKey, variants] of Object.entries(groupedByOriginal)) {
                console.log(`[^${originalKey}] æœ‰ ${variants.length} ä¸ªå˜ä½“:`);
                variants.forEach((variant, index) => {
                    console.log(`  ${index + 1}. [^${variant.uniqueKey}]: ${variant.content}`);
                });
            }

            return result;
        }

        // æ£€æŸ¥ç»æ–‡èŠ‚ç´¢å¼•åŠŸèƒ½
        function checkVerseIndex() {
            console.log('=== ç»æ–‡èŠ‚ç´¢å¼•æ£€æŸ¥ ===');
            console.log('æœç´¢ç´¢å¼•å¤§å°:', searchIndex.length);

            if (searchIndex.length === 0) {
                console.log('âŒ æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œè¯·å…ˆè¿›è¡Œæœç´¢ä»¥æ„å»ºç´¢å¼•');
                return;
            }

            // ç»Ÿè®¡ä¸åŒç±»å‹çš„ç´¢å¼•é¡¹
            let verseCount = 0;
            let chapterCount = 0;
            let otherCount = 0;

            const verseExamples = [];
            const chapterExamples = [];

            for (const item of searchIndex) {
                const title = item.title || item.t || '';
                const content = item.content || item.c || '';
                const bookName = item.bookName || item.bn || '';
                const bookPath = item.bookPath || item.bp || '';

                if (item.type === 'verse') {
                    verseCount++;
                    if (verseExamples.length < 5) {
                        verseExamples.push(`${title}: "${content.substring(0, 30)}..."`);
                    }
                } else if (bookPath && bookPath.includes('åœ£ç»ç ”è¯»')) {
                    chapterCount++;
                    if (chapterExamples.length < 3) {
                        chapterExamples.push(`${bookName} - ${title}`);
                    }
                } else {
                    otherCount++;
                }
            }

            console.log(`\n=== ç´¢å¼•ç»Ÿè®¡ ===`);
            console.log(`ç»æ–‡èŠ‚ç´¢å¼•: ${verseCount} ä¸ª`);
            console.log(`åœ£ç»ç« èŠ‚ç´¢å¼•: ${chapterCount} ä¸ª`);
            console.log(`å…¶ä»–ç´¢å¼•: ${otherCount} ä¸ª`);

            console.log(`\n=== ç»æ–‡èŠ‚ç¤ºä¾‹ ===`);
            verseExamples.forEach((example, index) => {
                console.log(`${index + 1}. ${example}`);
            });

            console.log(`\n=== åœ£ç»ç« èŠ‚ç¤ºä¾‹ ===`);
            chapterExamples.forEach((example, index) => {
                console.log(`${index + 1}. ${example}`);
            });

            // æ£€æŸ¥åˆ†ç±»è®¾ç½®
            console.log(`\n=== åˆ†ç±»æ£€æŸ¥ ===`);
            const bibleItems = searchIndex.filter(item => {
                const bookName = item.bookName || item.bn || '';
                return bookName === 'åœ£ç»ç ”è¯»';
            });
            console.log(`bookNameä¸º"åœ£ç»"çš„ç´¢å¼•é¡¹: ${bibleItems.length} ä¸ª`);

            if (bibleItems.length > 0) {
                console.log('å‰3ä¸ªåœ£ç»ç´¢å¼•é¡¹:');
                bibleItems.slice(0, 3).forEach((item, index) => {
                    const title = item.title || item.t || '';
                    console.log(`${index + 1}. ${title} (ç±»å‹: ${item.type || 'ç« èŠ‚'})`);
                });
            }

            // æ£€æŸ¥æ˜¯å¦æ­£ç¡®åº”ç”¨äº†ä¿®æ”¹
            if (verseCount > 0) {
                console.log('âœ… ç»æ–‡èŠ‚ç´¢å¼•åŠŸèƒ½å·²æ­£ç¡®åº”ç”¨');
                if (bibleItems.length === verseCount) {
                    console.log('âœ… åˆ†ç±»è®¾ç½®æ­£ç¡®ï¼Œæ‰€æœ‰ç»æ–‡èŠ‚éƒ½å½’ç±»ä¸º"åœ£ç»"');
                } else {
                    console.log('âš ï¸ åˆ†ç±»å¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥');
                }
            } else {
                console.log('âŒ ç»æ–‡èŠ‚ç´¢å¼•åŠŸèƒ½æœªç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥ä»£ç ');
            }

            // æ£€æŸ¥è„šæ³¨åˆ†é…
            console.log(`\n=== è„šæ³¨åˆ†é…æ£€æŸ¥ ===`);
            let versesWithFootnotes = 0;
            let versesWithoutFootnotes = 0;
            let totalFootnotesInVerses = 0;

            const verseItems = searchIndex.filter(item => item.type === 'verse');
            verseItems.forEach(verse => {
                const footnoteCount = verse.footnotes ? Object.keys(verse.footnotes).length : 0;
                if (footnoteCount > 0) {
                    versesWithFootnotes++;
                    totalFootnotesInVerses += footnoteCount;
                } else {
                    versesWithoutFootnotes++;
                }
            });

            console.log(`æœ‰è„šæ³¨çš„ç»æ–‡èŠ‚: ${versesWithFootnotes} ä¸ª`);
            console.log(`æ— è„šæ³¨çš„ç»æ–‡èŠ‚: ${versesWithoutFootnotes} ä¸ª`);
            console.log(`ç»æ–‡èŠ‚ä¸­çš„è„šæ³¨æ€»æ•°: ${totalFootnotesInVerses} ä¸ª`);

            // æ˜¾ç¤ºå‰å‡ ä¸ªæœ‰è„šæ³¨çš„ç»æ–‡èŠ‚
            console.log(`\nå‰5ä¸ªæœ‰è„šæ³¨çš„ç»æ–‡èŠ‚:`);
            verseItems.filter(v => v.footnotes && Object.keys(v.footnotes).length > 0)
                .slice(0, 5)
                .forEach((verse, index) => {
                    const footnoteKeys = Object.keys(verse.footnotes);
                    console.log(`${index + 1}. ${verse.title}: ${footnoteKeys.length}ä¸ªè„šæ³¨ [${footnoteKeys.join(', ')}]`);
                });

            return { verseCount, chapterCount, otherCount, bibleItems: bibleItems.length, versesWithFootnotes, versesWithoutFootnotes };
        }

        // è°ƒè¯•è„šæ³¨åŒ¹é…é—®é¢˜
        function debugFootnoteMatching(searchTerm = 'ç‹ä¸‹') {
            console.log('=== è°ƒè¯•è„šæ³¨åŒ¹é…é—®é¢˜ ===');
            console.log('æœç´¢è¯:', searchTerm);

            if (searchIndex.length === 0) {
                console.log('âŒ æœç´¢ç´¢å¼•ä¸ºç©ºï¼Œè¯·å…ˆè¿›è¡Œæœç´¢');
                return;
            }

            // æŸ¥æ‰¾åŒ…å«æœç´¢è¯çš„è„šæ³¨
            let footnoteMatches = [];

            for (const item of searchIndex) {
                const footnotes = item.footnotes || item.f || {};
                if (footnotes && Object.keys(footnotes).length > 0) {
                    for (const [key, data] of Object.entries(footnotes)) {
                        let content = '';
                        let sectionNumber = '';
                        let originalKey = key;

                        if (typeof data === 'string') {
                            content = data;
                        } else if (typeof data === 'object' && data.content) {
                            content = data.content;
                            sectionNumber = data.sectionNumber || '';
                            originalKey = data.originalKey || key;
                        }

                        if (content.toLowerCase().includes(searchTerm.toLowerCase())) {
                            footnoteMatches.push({
                                item: item,
                                footnoteKey: key,
                                originalKey: originalKey,
                                content: content,
                                sectionNumber: sectionNumber,
                                bookPath: item.bookPath || item.bp || '',
                                chapterName: item.chapterName || item.cn || '',
                                itemType: item.type || 'chapter',
                                itemTitle: item.title || item.t || ''
                            });
                        }
                    }
                }
            }

            console.log(`æ‰¾åˆ° ${footnoteMatches.length} ä¸ªè„šæ³¨åŒ¹é…:`);
            footnoteMatches.slice(0, 10).forEach((match, index) => {
                console.log(`${index + 1}. é”®="${match.originalKey}" (å”¯ä¸€é”®: ${match.footnoteKey})`);
                console.log(`   ç´¢å¼•é¡¹: ${match.itemTitle} (ç±»å‹: ${match.itemType})`);
                console.log(`   è·¯å¾„: ${match.bookPath}/${match.chapterName}`);
                console.log(`   èŠ‚å·: ${match.sectionNumber}`);
                console.log(`   å†…å®¹: "${match.content.substring(0, 80)}..."`);
                console.log('');
            });

            // æ£€æŸ¥é‡å¤çš„è„šæ³¨é”®
            const keyGroups = {};
            footnoteMatches.forEach(match => {
                const key = match.originalKey;
                if (!keyGroups[key]) keyGroups[key] = [];
                keyGroups[key].push(match);
            });

            console.log('=== é‡å¤è„šæ³¨é”®åˆ†æ ===');
            for (const [key, matches] of Object.entries(keyGroups)) {
                if (matches.length > 1) {
                    console.log(`è„šæ³¨é”® "${key}" æœ‰ ${matches.length} ä¸ªä¸åŒçš„å†…å®¹:`);
                    matches.forEach((match, index) => {
                        console.log(`  ${index + 1}. èŠ‚å·="${match.sectionNumber}" - "${match.content.substring(0, 40)}..."`);
                    });
                }
            }

            return footnoteMatches;
        }

        // åœ¨æ§åˆ¶å°æš´éœ²æ£€æŸ¥å‡½æ•°
        window.checkFootnoteVersion = checkFootnoteVersion;
        window.checkFootnoteIndex = checkFootnoteIndex;
        window.testFootnoteExtraction = testFootnoteExtraction;
        window.testDuplicateFootnotes = testDuplicateFootnotes;
        window.checkVerseIndex = checkVerseIndex;
        window.debugFootnoteMatching = debugFootnoteMatching;

        // æ£€æµ‹å¹¶è‡ªåŠ¨æ‰“å¼€è„šæ³¨å¼¹çª—ï¼ˆç”¨äºåŸå§‹æœç´¢ç»“æœï¼‰
        function detectAndOpenFootnotePopup(searchTerm) {
            console.log(`æ£€æµ‹è„šæ³¨å†…å®¹åŒ¹é…: æœç´¢è¯="${searchTerm}"`);

            // æŸ¥æ‰¾æ‰€æœ‰è„šæ³¨é“¾æ¥
            const footnoteLinks = document.querySelectorAll('.footnote-ref');
            console.log(`é¡µé¢ä¸­å…±æ‰¾åˆ° ${footnoteLinks.length} ä¸ªè„šæ³¨é“¾æ¥`);

            // æ£€æŸ¥æ˜¯å¦æœ‰è„šæ³¨å†…å®¹åŒ…å«æœç´¢è¯
            let matchingFootnotes = [];

            for (const link of footnoteLinks) {
                const footnoteContent = link.getAttribute('data-footnote-content') || '';
                if (footnoteContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                    matchingFootnotes.push({
                        link: link,
                        content: footnoteContent,
                        key: link.getAttribute('data-footnote-key'),
                        sectionNumber: link.getAttribute('data-section-number')
                    });
                }
            }

            console.log(`æ‰¾åˆ° ${matchingFootnotes.length} ä¸ªåŒ¹é…çš„è„šæ³¨`);

            if (matchingFootnotes.length > 0) {
                // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„è„šæ³¨ï¼Œè‡ªåŠ¨æ‰“å¼€ç¬¬ä¸€ä¸ª
                const firstMatch = matchingFootnotes[0];
                console.log(`è‡ªåŠ¨æ‰“å¼€ç¬¬ä¸€ä¸ªåŒ¹é…çš„è„šæ³¨: é”®="${firstMatch.key}", èŠ‚å·="${firstMatch.sectionNumber}"`);

                // é«˜äº®æ˜¾ç¤ºæ‰¾åˆ°çš„è„šæ³¨é“¾æ¥
                firstMatch.link.style.backgroundColor = 'yellow';
                firstMatch.link.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´åè§¦å‘è„šæ³¨å¼¹çª—
                setTimeout(() => {
                    firstMatch.link.style.backgroundColor = '';
                    firstMatch.link.click();
                    console.log(`å·²è‡ªåŠ¨æ‰“å¼€è„šæ³¨å¼¹çª—`);
                }, 800);

                return true; // è¡¨ç¤ºæ‰¾åˆ°å¹¶æ‰“å¼€äº†è„šæ³¨
            } else {
                console.log(`æœªæ‰¾åˆ°åŒ…å«æœç´¢è¯"${searchTerm}"çš„è„šæ³¨å†…å®¹`);
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è„šæ³¨åŒ¹é…ï¼Œè¿›è¡Œæ­£å¸¸çš„å†…å®¹é«˜äº®
                setTimeout(() => {
                    highlightContentSearchTerm(searchTerm, '', 0);
                }, 100);
                return false;
            }
        }

        // è‡ªåŠ¨æ‰“å¼€è„šæ³¨å¼¹çª—ï¼ˆç”¨äºæœç´¢ç»“æœè·³è½¬ï¼‰
        function autoOpenFootnotePopup(footnoteKey, searchTerm, sectionNumber = null) {
            console.log(`å°è¯•è‡ªåŠ¨æ‰“å¼€è„šæ³¨å¼¹çª—: è„šæ³¨é”®="${footnoteKey}", æœç´¢è¯="${searchTerm}", èŠ‚å·="${sectionNumber}"`);

            // æŸ¥æ‰¾æ‰€æœ‰è„šæ³¨é“¾æ¥
            const footnoteLinks = document.querySelectorAll('.footnote-ref');
            console.log(`é¡µé¢ä¸­å…±æ‰¾åˆ° ${footnoteLinks.length} ä¸ªè„šæ³¨é“¾æ¥`);

            let targetFootnoteLink = null;
            let matchedLinks = [];

            // å¦‚æœæœ‰è„šæ³¨é”®ï¼Œä¼˜å…ˆé€šè¿‡è„šæ³¨é”®åŒ¹é…
            if (footnoteKey && footnoteKey.trim() !== '') {
                // æ–¹æ³•1: ç›´æ¥é€šè¿‡è„šæ³¨é”®åŒ¹é…
                for (const link of footnoteLinks) {
                    const linkFootnoteKey = link.getAttribute('data-footnote-key');
                    if (linkFootnoteKey === footnoteKey) {
                        matchedLinks.push(link);
                    }
                }

                // å¦‚æœæœ‰å¤šä¸ªåŒ¹é…çš„è„šæ³¨é”®ï¼Œå°è¯•é€šè¿‡èŠ‚å·è¿›ä¸€æ­¥ç­›é€‰
                if (matchedLinks.length > 1 && sectionNumber) {
                    console.log(`æ‰¾åˆ° ${matchedLinks.length} ä¸ªåŒ¹é…çš„è„šæ³¨é”®ï¼Œå°è¯•é€šè¿‡èŠ‚å·ç­›é€‰: "${sectionNumber}"`);
                    for (const link of matchedLinks) {
                        const linkSectionNumber = link.getAttribute('data-section-number');
                        if (linkSectionNumber === sectionNumber) {
                            targetFootnoteLink = link;
                            console.log(`é€šè¿‡è„šæ³¨é”®å’ŒèŠ‚å·åŒ¹é…æ‰¾åˆ°ç›®æ ‡è„šæ³¨: ${footnoteKey} (èŠ‚å·: ${sectionNumber})`);
                            break;
                        }
                    }
                } else if (matchedLinks.length === 1) {
                    targetFootnoteLink = matchedLinks[0];
                    console.log(`é€šè¿‡è„šæ³¨é”®ç›´æ¥åŒ¹é…æ‰¾åˆ°ç›®æ ‡è„šæ³¨: ${footnoteKey}`);
                } else if (matchedLinks.length > 1) {
                    // å¦‚æœæœ‰å¤šä¸ªåŒ¹é…ä½†æ²¡æœ‰èŠ‚å·ä¿¡æ¯ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                    targetFootnoteLink = matchedLinks[0];
                    console.log(`æ‰¾åˆ°å¤šä¸ªåŒ¹é…çš„è„šæ³¨é”®ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª: ${footnoteKey}`);
                }
            }

            // æ–¹æ³•2: å¦‚æœè„šæ³¨é”®åŒ¹é…å¤±è´¥æˆ–æ²¡æœ‰è„šæ³¨é”®ï¼Œé€šè¿‡è„šæ³¨å†…å®¹åŒ¹é…
            if (!targetFootnoteLink) {
                console.log(`è„šæ³¨é”®åŒ¹é…å¤±è´¥ï¼Œå°è¯•é€šè¿‡å†…å®¹åŒ¹é…æœç´¢è¯: "${searchTerm}"`);
                for (const link of footnoteLinks) {
                    const footnoteContent = link.getAttribute('data-footnote-content') || '';
                    if (footnoteContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                        targetFootnoteLink = link;
                        console.log(`é€šè¿‡å†…å®¹åŒ¹é…æ‰¾åˆ°ç›®æ ‡è„šæ³¨: é”®="${link.getAttribute('data-footnote-key')}", å†…å®¹="${footnoteContent.substring(0, 30)}..."`);
                        break;
                    }
                }
            }

            // å¦‚æœæ‰¾åˆ°ç›®æ ‡è„šæ³¨é“¾æ¥ï¼Œè‡ªåŠ¨æ‰“å¼€å¼¹çª—
            if (targetFootnoteLink) {
                console.log(`æ‰¾åˆ°ç›®æ ‡è„šæ³¨é“¾æ¥ï¼Œå‡†å¤‡è‡ªåŠ¨æ‰“å¼€å¼¹çª—`);
                console.log(`ç›®æ ‡è„šæ³¨é“¾æ¥ä¿¡æ¯: é”®="${targetFootnoteLink.getAttribute('data-footnote-key')}", èŠ‚å·="${targetFootnoteLink.getAttribute('data-section-number')}"`);

                // é«˜äº®æ˜¾ç¤ºæ‰¾åˆ°çš„è„šæ³¨é“¾æ¥
                targetFootnoteLink.style.backgroundColor = 'yellow';
                targetFootnoteLink.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´åè§¦å‘è„šæ³¨å¼¹çª—
                setTimeout(() => {
                    targetFootnoteLink.style.backgroundColor = '';
                    console.log(`æ­£åœ¨è§¦å‘è„šæ³¨é“¾æ¥ç‚¹å‡»äº‹ä»¶...`);
                    targetFootnoteLink.click();
                    console.log(`å·²è§¦å‘è„šæ³¨é“¾æ¥ç‚¹å‡»äº‹ä»¶`);
                }, 800);
            } else {
                console.log(`âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è„šæ³¨é“¾æ¥ï¼Œæœç´¢è¯: "${searchTerm}", è„šæ³¨é”®: "${footnoteKey}", èŠ‚å·: "${sectionNumber}"`);
                console.log('å¯ç”¨çš„è„šæ³¨é“¾æ¥:');
                footnoteLinks.forEach((link, index) => {
                    const key = link.getAttribute('data-footnote-key');
                    const linkSectionNumber = link.getAttribute('data-section-number');
                    const content = link.getAttribute('data-footnote-content') || '';
                    console.log(`  ${index + 1}. é”®="${key}", èŠ‚å·="${linkSectionNumber}", å†…å®¹="${content.substring(0, 30)}..."`);
                });
            }
        }



        // é€’å½’ç´¢å¼•ä¹¦ç±å†…å®¹
        async function indexBookContent(bookName, bookPath, depth) {
            console.log(`[æ·±åº¦${depth}] ç´¢å¼•å†…å®¹: ${bookName}, è·¯å¾„: ${bookPath}`);

            // è·å–ç« èŠ‚åˆ—è¡¨
            const chapters = await getChapterList(bookPath);
            console.log(`[æ·±åº¦${depth}] ${bookName} æœ‰ ${chapters.length} ä¸ªæ¡ç›®`);

            // éå†æ¯ä¸ªç« èŠ‚æˆ–å­ç›®å½•
            for (const chapter of chapters) {
                if (chapter.isToc) {
                    // å¦‚æœæ˜¯ç›®å½•ï¼Œé€’å½’å¤„ç†
                    console.log(`[æ·±åº¦${depth}] å‘ç°å­ç›®å½•: ${chapter.name}, è·¯å¾„: ${chapter.path}`);

                    // æå–å­ç›®å½•è·¯å¾„
                    let subDirPath = chapter.path;
                    if (chapter.path.endsWith('/')) {
                        subDirPath = chapter.path.slice(0, -1);
                    }

                    // æ„å»ºå­ç›®å½•çš„å®Œæ•´è·¯å¾„
                    let fullSubDirPath;
                    if (chapter.href.startsWith('./')) {
                        // ç›¸å¯¹è·¯å¾„
                        if (bookPath) {
                            fullSubDirPath = `${bookPath}/${chapter.name}`;
                        } else {
                            fullSubDirPath = chapter.name;
                        }
                    } else {
                        // ç»å¯¹è·¯å¾„
                        fullSubDirPath = subDirPath.replace(/^\/+|\/+$/g, '');
                    }

                    console.log(`[æ·±åº¦${depth}] é€’å½’å¤„ç†å­ç›®å½•: ${fullSubDirPath}`);

                    // é€’å½’å¤„ç†å­ç›®å½•
                    await indexBookContent(`${bookName} > ${chapter.name}`, fullSubDirPath, depth + 1);
                } else {
                    // å¦‚æœæ˜¯æ™®é€šç« èŠ‚ï¼Œæ·»åŠ åˆ°ç´¢å¼•
                    try {
                        // è¯»å–ç« èŠ‚å†…å®¹
                        const normalizedPath = chapter.path ? (chapter.path.endsWith('/') ? chapter.path : chapter.path + '/') : '';
                        const chapterPath = `${BOOKS_DIR}${normalizedPath}${chapter.name}.md`;
                        console.log(`[æ·±åº¦${depth}] è¯»å–ç« èŠ‚å†…å®¹: ${chapterPath}`);

                        const response = await fetch(chapterPath);
                        if (!response.ok) {
                            console.error(`[æ·±åº¦${depth}] æ— æ³•åŠ è½½ç« èŠ‚ ${chapterPath}: ${response.status}`);
                            continue;
                        }

                        const content = await response.text();
                        console.log(`[æ·±åº¦${depth}] ç« èŠ‚ ${chapter.name} å†…å®¹é•¿åº¦: ${content.length}`);

                        // æå–æ ‡é¢˜
                        let title = chapter.name;
                        const titleMatch = content.match(/^#\s+(.+)$/m);
                        if (titleMatch) {
                            title = titleMatch[1];
                        }

                        // å¤„ç†è„šæ³¨ï¼Œæå–è„šæ³¨ä¿¡æ¯å¹¶å»é™¤è„šæ³¨æ ‡è®°
                        let footnotes = {};
                        let cleanContent = content; // é»˜è®¤ä½¿ç”¨åŸå§‹å†…å®¹

                        // åªå¯¹åœ£ç»ç›®å½•è¿›è¡Œè„šæ³¨å¤„ç†
                        const isBibleDirectory = bookPath.includes('åœ£ç»ç ”è¯»/') || bookPath.includes('åœ£ç»ç ”è¯»\\');

                        if (isBibleDirectory) {
                            try {
                                const result = processFootnotesForIndex(content);
                                footnotes = result.footnotes;
                                cleanContent = result.cleanContent; // ä½¿ç”¨å»é™¤è„šæ³¨æ ‡è®°çš„å†…å®¹
                                console.log(`[æ·±åº¦${depth}] ğŸ“– åœ£ç»ç›®å½•ï¼Œæå–äº† ${Object.keys(footnotes).length} ä¸ªè„šæ³¨`);
                                console.log(`[æ·±åº¦${depth}] åŸå§‹å†…å®¹é•¿åº¦: ${content.length}, æ¸…ç†åé•¿åº¦: ${cleanContent.length}`);

                                // è§£æç»æ–‡èŠ‚å¹¶æ·»åŠ åˆ°ç´¢å¼•
                                const verses = parseVerses(cleanContent, bookName.split(' > ').pop(), chapter.name, chapter.path);
                                for (const verse of verses) {
                                    // ä¸ºæ¯ä¸ªç»æ–‡èŠ‚åˆ†é…å±äºè¯¥èŠ‚çš„è„šæ³¨
                                    verse.footnotes = getFootnotesForVerse(footnotes, verse.verseNumber);
                                    searchIndex.push(verse);
                                }
                                console.log(`[æ·±åº¦${depth}] ğŸ“ æ·»åŠ äº† ${verses.length} ä¸ªç»æ–‡èŠ‚åˆ°ç´¢å¼•`);

                                // å¯¹äºåœ£ç»ç›®å½•ï¼Œåªæ·»åŠ ç»æ–‡èŠ‚ï¼Œä¸æ·»åŠ æ•´ç« 
                                console.log(`[æ·±åº¦${depth}] ğŸ“– åœ£ç»ç›®å½•ä½¿ç”¨èŠ‚çº§åˆ«ç´¢å¼•ï¼Œè·³è¿‡ç« çº§åˆ«ç´¢å¼•`);

                            } catch (error) {
                                console.warn(`[æ·±åº¦${depth}] è„šæ³¨å¤„ç†å¤±è´¥:`, error);
                                // å¦‚æœè„šæ³¨å¤„ç†å¤±è´¥ï¼Œä»ç„¶æ·»åŠ æ•´ç« åˆ°ç´¢å¼•
                                searchIndex.push({
                                    title,
                                    content: cleanContent,
                                    footnotes,
                                    bookName,
                                    bookPath: chapter.path,
                                    chapterName: chapter.name,
                                    chapterPath: chapter.path
                                });
                                console.log(`[æ·±åº¦${depth}] è„šæ³¨å¤„ç†å¤±è´¥ï¼Œæ·»åŠ æ•´ç« åˆ°ç´¢å¼•: ${bookName} - ${title}`);
                            }
                        } else {
                            console.log(`[æ·±åº¦${depth}] ğŸ“š éåœ£ç»ç›®å½•ï¼Œè·³è¿‡è„šæ³¨å¤„ç†`);

                            // éåœ£ç»ç›®å½•ï¼Œæ·»åŠ æ•´ç« åˆ°ç´¢å¼•
                            searchIndex.push({
                                title,
                                content: cleanContent,
                                footnotes,
                                bookName,
                                bookPath: chapter.path,
                                chapterName: chapter.name,
                                chapterPath: chapter.path
                            });
                            console.log(`[æ·±åº¦${depth}] æ·»åŠ åˆ°ç´¢å¼•: ${bookName} - ${title}`);
                        }
                    } catch (err) {
                        console.error(`[æ·±åº¦${depth}] æ— æ³•ç´¢å¼•ç« èŠ‚ ${chapter.name}:`, err);
                    }
                }
            }
        }



        // åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
        function findMatchesInText(text, searchTerm) {
            const matches = [];
            const textLower = text.toLowerCase();
            const searchLower = searchTerm.toLowerCase();
            let index = textLower.indexOf(searchLower);

            while (index !== -1) {
                matches.push({ index: index });
                index = textLower.indexOf(searchLower, index + searchTerm.length);
            }

            return matches;
        }

        // ç”Ÿæˆä¸Šä¸‹æ–‡
        function generateContext(text, matchIndex, matchLength) {
            let contextStart = Math.max(0, matchIndex - 50);
            let contextEnd = Math.min(text.length, matchIndex + matchLength + 50);

            // ç¡®ä¿ä¸Šä¸‹æ–‡ä¸ä¼šæˆªæ–­å•è¯
            while (contextStart > 0 && !/\s/.test(text[contextStart])) {
                contextStart--;
            }
            while (contextEnd < text.length && !/\s/.test(text[contextEnd])) {
                contextEnd++;
            }

            let context = text.substring(contextStart, contextEnd);

            // æ·»åŠ çœç•¥å·
            if (contextStart > 0) {
                context = '...' + context;
            }
            if (contextEnd < text.length) {
                context += '...';
            }

            return context;
        }

        // ç§»åŠ¨ç«¯é¢åŒ…å±‘ä¼˜åŒ–
        function optimizeMobileBreadcrumb() {
            // åªåœ¨ç§»åŠ¨ç«¯æ‰§è¡Œ
            if (window.innerWidth > 768) return;

            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            if (!breadcrumbNav || !breadcrumbNav.classList.contains('show')) return;

            // ç§»åŠ¨ç«¯ä¸éšè—ä»»ä½•é¡¹ç›®ï¼Œåªæ˜¯è°ƒæ•´æ ·å¼ä»¥é€‚åº”å°å±å¹•
            // å¯ä»¥é€‰æ‹©æ¢è¡Œæ˜¾ç¤ºæˆ–æ°´å¹³æ»šåŠ¨
            breadcrumbNav.style.whiteSpace = 'nowrap';
            breadcrumbNav.style.overflowX = 'auto';
            breadcrumbNav.style.overflowY = 'hidden';
        }

        // æœç´¢æ–¹æ³•
        function originalSearchInIndex(searchTerm) {
            const results = [];
            const searchTermLower = searchTerm.toLowerCase();
            console.log(`åœ¨ ${searchIndex.length} æ¡ç´¢å¼•ä¸­æœç´¢: "${searchTermLower}"`);

            // è®°å½•å·²æ·»åŠ çš„ç« èŠ‚ï¼Œé¿å…é‡å¤ï¼ˆä½†ç»æ–‡èŠ‚ä¸å»é‡ï¼‰
            const addedChapters = new Set();

            for (const item of searchIndex) {
                // å…¼å®¹ä¼˜åŒ–åçš„å­—æ®µå
                const content = item.content || item.c || '';
                const title = item.title || item.t || '';
                const footnotes = item.footnotes || item.f || {};

                const contentLower = content.toLowerCase();
                const titleLower = title.toLowerCase();

                // å…¼å®¹ä¼˜åŒ–åçš„å­—æ®µå
                const bookPath = item.bookPath || item.bp || '';
                const chapterName = item.chapterName || item.cn || '';
                const bookName = item.bookName || item.bn || '';

                // å¯¹äºç»æ–‡ç±»å‹ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„æ ‡è¯†ç¬¦
                let itemKey;
                if (item.type === 'verse') {
                    itemKey = `${bookPath}/${chapterName}:${item.verseNumber}`;
                } else {
                    itemKey = `${bookPath}/${chapterName}`;
                }

                // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ è¿‡è¿™ä¸ªé¡¹ç›®
                if (addedChapters.has(itemKey)) {
                    continue;
                }

                // æ”¶é›†æ‰€æœ‰åŒ¹é…ä½ç½®
                let allMatches = [];

                // æ£€æŸ¥æ ‡é¢˜åŒ¹é…
                if (titleLower.includes(searchTermLower)) {
                    allMatches.push({
                        type: 'title',
                        index: titleLower.indexOf(searchTermLower),
                        position: 0
                    });
                }

                // æ£€æŸ¥å†…å®¹ä¸­çš„æ‰€æœ‰åŒ¹é…
                let contentMatchIndex = contentLower.indexOf(searchTermLower);
                let matchCount = 0;
                while (contentMatchIndex !== -1) {
                    const contentBeforeMatch = content.substring(0, contentMatchIndex);
                    const lineNumber = (contentBeforeMatch.match(/\n/g) || []).length + 1;

                    // å¯¹äºç»æ–‡ç±»å‹ï¼Œä½¿ç”¨ç‰¹æ®Šçš„åŒ¹é…ç±»å‹
                    const matchType = item.type === 'verse' ? 'verse' : 'content';

                    allMatches.push({
                        type: matchType,
                        index: contentMatchIndex,
                        position: matchCount + 1,
                        lineNumber: lineNumber,
                        // ä¸ºç»æ–‡åŒ¹é…æ·»åŠ é¢å¤–ä¿¡æ¯
                        verseNumber: item.type === 'verse' ? item.verseNumber : undefined
                    });

                    matchCount++;
                    contentMatchIndex = contentLower.indexOf(searchTermLower, contentMatchIndex + searchTermLower.length);
                }

                // æ£€æŸ¥è„šæ³¨ä¸­çš„åŒ¹é…
                if (footnotes && Object.keys(footnotes).length > 0) {
                    Object.entries(footnotes).forEach(([footnoteKey, footnoteData]) => {
                        // å¤„ç†æ–°çš„è„šæ³¨æ•°æ®ç»“æ„
                        let footnoteContent, sectionNumber, originalKey;
                        if (typeof footnoteData === 'string') {
                            // å…¼å®¹æ—§æ ¼å¼
                            footnoteContent = footnoteData;
                            sectionNumber = '';
                            originalKey = footnoteKey;
                        } else {
                            // æ–°æ ¼å¼
                            footnoteContent = footnoteData.content;
                            sectionNumber = footnoteData.sectionNumber || '';
                            originalKey = footnoteData.originalKey || footnoteKey;
                        }

                        const footnoteContentLower = footnoteContent.toLowerCase();
                        if (footnoteContentLower.includes(searchTermLower)) {
                            const footnoteMatchIndex = footnoteContentLower.indexOf(searchTermLower);
                            allMatches.push({
                                type: 'footnote',
                                index: footnoteMatchIndex,
                                position: allMatches.length + 1,
                                footnoteKey: originalKey,  // ä½¿ç”¨åŸå§‹é”®åæ˜¾ç¤º
                                footnoteContent: footnoteContent,
                                sectionNumber: sectionNumber,
                                lineNumber: 0 // è„šæ³¨æ²¡æœ‰è¡Œå·æ¦‚å¿µ
                            });
                            console.log(`âœ… æ‰¾åˆ°è„šæ³¨åŒ¹é…: é”®="${originalKey}" (å”¯ä¸€é”®: ${footnoteKey}), èŠ‚å·="${sectionNumber}", å†…å®¹="${footnoteContent.substring(0, 30)}..."`);
                        }
                    });
                }

                // å¦‚æœæœ‰åŒ¹é…é¡¹ï¼Œå¤„ç†ç»“æœ
                if (allMatches.length > 0) {
                    addedChapters.add(itemKey);

                    const contexts = allMatches.slice(0, 5).map(match => {
                        let text, context;

                        if (match.type === 'title') {
                            text = title;
                            context = generateContext(text, match.index, searchTerm.length);
                        } else if (match.type === 'footnote') {
                            text = match.footnoteContent;
                            context = generateContext(text, match.index, searchTerm.length);
                        } else {
                            text = content;
                            context = generateContext(text, match.index, searchTerm.length);
                        }

                        const contextObj = {
                            context,
                            type: match.type,
                            position: match.position,
                            lineNumber: match.lineNumber || 0
                        };

                        // å¦‚æœæ˜¯è„šæ³¨åŒ¹é…ï¼Œæ·»åŠ è„šæ³¨ç›¸å…³ä¿¡æ¯
                        if (match.type === 'footnote') {
                            contextObj.footnoteKey = match.footnoteKey;
                            contextObj.footnoteContent = match.footnoteContent;
                            contextObj.sectionNumber = match.sectionNumber || '';
                        }
                        // å¦‚æœæ˜¯ç»æ–‡åŒ¹é…ï¼Œæ·»åŠ ç»æ–‡ç›¸å…³ä¿¡æ¯
                        else if (match.type === 'verse') {
                            contextObj.verseNumber = match.verseNumber;
                        }

                        return contextObj;
                    });

                    results.push({
                        title: title,
                        contexts: contexts,
                        bookName: bookName,
                        bookPath: bookPath,
                        chapterName: chapterName,
                        chapterPath: item.chapterPath || item.cp || '',
                        matchCount: allMatches.length
                    });
                }
            }

            console.log(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${results.length} ä¸ªç»“æœ`);
            return results;
        }


        // åˆ†ç±»ç­›é€‰åŠŸèƒ½
        function filterResultsByCategory(selectedCategory) {
            console.log('=== å¼€å§‹åˆ†ç±»ç­›é€‰ ===');
            console.log('ç­›é€‰åˆ†ç±»:', selectedCategory);
            console.log('window.allSearchResults æ˜¯å¦å­˜åœ¨:', !!window.allSearchResults);
            console.log('window.allSearchResults é•¿åº¦:', window.allSearchResults ? window.allSearchResults.length : 0);

            if (!window.allSearchResults) {
                console.error('æ²¡æœ‰å¯ç­›é€‰çš„æœç´¢ç»“æœ');
                return;
            }

            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            console.log('å‰5ä¸ªæœç´¢ç»“æœçš„bookName:');
            window.allSearchResults.slice(0, 5).forEach((result, index) => {
                console.log(`  ${index + 1}. "${result.bookName}"`);
            });

            let filteredResults;
            if (selectedCategory === 'all') {
                filteredResults = window.allSearchResults;
            } else {
                // ç­›é€‰ä¸€çº§åˆ†ç±»ï¼šæå–bookNameçš„ç¬¬ä¸€éƒ¨åˆ†
                console.log(`å¼€å§‹ç­›é€‰åˆ†ç±»"${selectedCategory}"ï¼Œæ€»æ•°æ®é‡: ${window.allSearchResults.length}`);

                // å…ˆç»Ÿè®¡æ‰€æœ‰åˆ†ç±»
                const allCategories = {};
                window.allSearchResults.forEach(result => {
                    let firstLevel = '';
                    if (result.bookName.includes(' > ')) {
                        firstLevel = result.bookName.split(' > ')[0];
                    } else if (result.bookName.includes('/')) {
                        firstLevel = result.bookName.split('/')[0];
                    } else {
                        firstLevel = result.bookName;
                    }
                    firstLevel = firstLevel.trim();
                    allCategories[firstLevel] = (allCategories[firstLevel] || 0) + 1;
                });
                console.log('å…¨éƒ¨æœç´¢ç»“æœä¸­çš„åˆ†ç±»ç»Ÿè®¡:', allCategories);

                filteredResults = window.allSearchResults.filter((result, index) => {
                    // å°è¯•å¤šç§æ–¹å¼æå–ä¸€çº§åˆ†ç±»
                    let firstLevelCategory = '';

                    if (result.bookName.includes(' > ')) {
                        // å¦‚æœåŒ…å« ' > 'ï¼Œå–ç¬¬ä¸€éƒ¨åˆ†
                        firstLevelCategory = result.bookName.split(' > ')[0];
                    } else if (result.bookName.includes('/')) {
                        // å¦‚æœåŒ…å« '/'ï¼Œå–ç¬¬ä¸€éƒ¨åˆ†
                        firstLevelCategory = result.bookName.split('/')[0];
                    } else {
                        // å¦åˆ™ç›´æ¥ä½¿ç”¨æ•´ä¸ªbookName
                        firstLevelCategory = result.bookName;
                    }

                    // å»é™¤å¯èƒ½çš„ç©ºæ ¼
                    firstLevelCategory = firstLevelCategory.trim();

                    const matches = firstLevelCategory === selectedCategory;

                    // è°ƒè¯•ï¼šè¾“å‡ºåŒ¹é…å’Œä¸åŒ¹é…çš„æ ·æœ¬
                    if (matches && index < 3) {
                        console.log(`âœ… åŒ¹é… ${index + 1}: bookName="${result.bookName}", æå–="${firstLevelCategory}", ç›®æ ‡="${selectedCategory}"`);
                    } else if (!matches && firstLevelCategory === selectedCategory && index < 3) {
                        console.log(`âŒ ä¸åŒ¹é… ${index + 1}: bookName="${result.bookName}", æå–="${firstLevelCategory}", ç›®æ ‡="${selectedCategory}"`);
                    }

                    return matches;
                });

                console.log(`ç­›é€‰å®Œæˆï¼ŒåŒ¹é…åˆ° ${filteredResults.length} ä¸ªç»“æœ`);
            }

            console.log(`ç­›é€‰åç»“æœæ•°é‡: ${filteredResults.length}`);

            // é‡æ–°æ˜¾ç¤ºç­›é€‰åçš„ç»“æœï¼Œé‡ç½®åˆ†é¡µçŠ¶æ€
            window.filteredResults = filteredResults;
            window.currentSearchTerm = window.currentSearchTerm || '';

            console.log(`åˆ‡æ¢åˆ°åˆ†ç±»"${selectedCategory}"ï¼Œå‡†å¤‡æ˜¾ç¤º ${filteredResults.length} ä¸ªç»“æœ`);

            // é‡æ–°è°ƒç”¨displaySearchResultsï¼Œå®Œå…¨é‡ç½®åˆ†é¡µçŠ¶æ€ï¼Œä¼ å…¥å½“å‰é€‰ä¸­çš„åˆ†ç±»
            displaySearchResults(filteredResults, window.currentSearchTerm, selectedCategory);
        }



        // ä»bob.mdæ–‡ä»¶è·å–åˆ†ç±»åç§°
        async function getCategoriesFromBob() {
            try {
                const response = await fetch('./books/bob.md');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const content = await response.text();

                // è§£æmarkdowné“¾æ¥ï¼Œæå–åˆ†ç±»åç§°
                const categories = [];
                const lines = content.split('\n');

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    // åŒ¹é…æ ¼å¼ï¼š- [åˆ†ç±»åç§°](./è·¯å¾„/toc.md)
                    const match = trimmedLine.match(/^-\s*\[([^\]]+)\]\(\.\/[^)]+\)$/);
                    if (match) {
                        categories.push(match[1]);
                    }
                }

                console.log('ä»bob.mdè·å–çš„åˆ†ç±»:', categories);
                return categories;
            } catch (error) {
                console.error('è·å–bob.mdåˆ†ç±»å¤±è´¥:', error);
                // è¿”å›é»˜è®¤åˆ†ç±»
                return ['åœ£ç»ç ”è¯»', 'ç”Ÿå‘½è¯»ç»', 'å±çµä¹¦æŠ¥', 'å€ªè‘—æ–‡é›†', 'æè‘—æ–‡é›†', 'ç‰¹ä¼šçº²ç›®', 'è¯—æ­Œåˆè¾‘'];
            }
        }

        // é«˜äº®æœç´¢è¯ï¼ˆé«˜äº®æ‰€æœ‰åŒ¹é…ï¼‰
        function highlightSearchTerm(text, searchTerm) {
            if (!text) return '';
            const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            return text.replace(regex, match => `<span class="search-highlight">${match}</span>`);
        }

        // é«˜äº®æœç´¢è¯ï¼ˆåªé«˜äº®æŒ‡å®šä½ç½®çš„åŒ¹é…ï¼‰
        function highlightSearchTermAtPosition(text, searchTerm, targetPosition) {
            if (!text || !searchTerm) return text;

            const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let matchCount = 0;
            let totalMatches = 0;

            // å…ˆè®¡ç®—æ€»åŒ¹é…æ•°
            const matches = text.match(regex);
            totalMatches = matches ? matches.length : 0;

            // å¦‚æœç›®æ ‡ä½ç½®è¶…è¿‡æ€»åŒ¹é…æ•°ï¼Œåˆ™é«˜äº®æœ€åä¸€ä¸ªåŒ¹é…
            const actualTargetPosition = targetPosition > totalMatches ? totalMatches : targetPosition;

            return text.replace(regex, (match, offset) => {
                matchCount++;
                // åªé«˜äº®ç›®æ ‡ä½ç½®çš„åŒ¹é…ï¼ˆæˆ–æœ€åä¸€ä¸ªåŒ¹é…ï¼‰
                if (matchCount === actualTargetPosition) {
                    return `<span class="search-highlight">${match}</span>`;
                }
                return match; // å…¶ä»–åŒ¹é…ä¸é«˜äº®
            });
        }

        // åˆ†é¡µ+æ‡’åŠ è½½æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, searchTerm, activeCategory = 'all') {
            const searchResults = document.getElementById('search-results');
            const floatingResultsContainer = document.getElementById('floating-results-container');

            // ç§»é™¤åŠ è½½çŠ¶æ€æ ·å¼
            searchResults.classList.remove('loading-state');

            // å§‹ç»ˆæ˜¾ç¤ºå¤´éƒ¨ï¼Œå³ä½¿æ²¡æœ‰ç»“æœ
            searchResults.innerHTML = generateHeaderHTML(activeCategory, results.length);

            if (results.length === 0) {
                console.log('æœªæ‰¾åˆ°åŒ¹é…ç»“æœ');
                const categoryText = activeCategory === 'all' ? '' : ` (åˆ†ç±»: ${activeCategory})`;

                // æ˜¾ç¤ºæ— ç»“æœä¿¡æ¯ï¼Œä½†ä¿ç•™å¤´éƒ¨
                const resultsContent = document.getElementById('results-content');
                resultsContent.innerHTML = `<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ${categoryText}</div>`;

                // éšè—åˆ†é¡µå¯¼èˆª
                const paginationContainer = document.getElementById('pagination-container');
                paginationContainer.innerHTML = '';

                // ç»‘å®šå¤´éƒ¨äº‹ä»¶
                bindHeaderEvents();
                return;
            }

            console.log(`å¼€å§‹åˆ†é¡µæ˜¾ç¤º ${results.length} ä¸ªæœç´¢ç»“æœï¼Œå½“å‰åˆ†ç±»: ${activeCategory}`);

            // è®¾ç½®å½“å‰æ˜¾ç¤ºçš„ç»“æœæ•°ç»„ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
            window.currentDisplayResults = results;
            // ä¿å­˜å½“å‰é€‰ä¸­çš„åˆ†ç±»
            window.currentActiveCategory = activeCategory;

            // åˆ†é¡µé…ç½®
            const RESULTS_PER_PAGE = 100;  // æ¯é¡µæ˜¾ç¤º15ä¸ªç»“æœ
            let currentPage = 0;
            let isLoading = false;

            // ç”Ÿæˆé¡µç å¯¼èˆªHTML
            function generatePaginationHTML(currentPage, totalPages, totalResults) {
                if (totalPages <= 1) return '';

                let paginationHTML = '<div class="pagination">';

                // æ˜¾ç¤ºç»“æœç»Ÿè®¡
                const startResult = currentPage * RESULTS_PER_PAGE + 1;
                const endResult = Math.min((currentPage + 1) * RESULTS_PER_PAGE, totalResults);
                paginationHTML += `<div class="pagination-info">æ˜¾ç¤º ${startResult}-${endResult} / å…± ${totalResults} ä¸ªç»“æœ</div>`;

                paginationHTML += '<div class="pagination-buttons">';

                // ä¸Šä¸€é¡µæŒ‰é’®
                if (currentPage > 0) {
                    paginationHTML += `<button class="pagination-btn" data-page="${currentPage - 1}">â€¹â€¹</button>`;
                }

                // é¡µç æŒ‰é’® - æ ¹æ®å±å¹•å¤§å°è°ƒæ•´æ˜¾ç¤ºæ•°é‡
                const isMobile = window.innerWidth <= 768;
                const maxVisiblePages = isMobile ? 3 : 5;
                let startPage = Math.max(0, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages - 1, startPage + maxVisiblePages - 1);

                // è°ƒæ•´èµ·å§‹é¡µï¼Œç¡®ä¿æ˜¾ç¤ºè¶³å¤Ÿçš„é¡µç 
                if (endPage - startPage < maxVisiblePages - 1) {
                    startPage = Math.max(0, endPage - maxVisiblePages + 1);
                }

                // ç¬¬ä¸€é¡µ
                if (startPage > 0) {
                    paginationHTML += `<button class="pagination-btn" data-page="0">1</button>`;
                    if (startPage > 1) {
                        paginationHTML += '<span class="pagination-ellipsis">...</span>';
                    }
                }

                // ä¸­é—´é¡µç 
                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage ? 'active' : '';
                    paginationHTML += `<button class="pagination-btn ${isActive}" data-page="${i}">${i + 1}</button>`;
                }

                // æœ€åä¸€é¡µ
                if (endPage < totalPages - 1) {
                    if (endPage < totalPages - 2) {
                        paginationHTML += '<span class="pagination-ellipsis">...</span>';
                    }
                    paginationHTML += `<button class="pagination-btn" data-page="${totalPages - 1}">${totalPages}</button>`;
                }

                // ä¸‹ä¸€é¡µæŒ‰é’®
                if (currentPage < totalPages - 1) {
                    paginationHTML += `<button class="pagination-btn" data-page="${currentPage + 1}">â€ºâ€º</button>`;
                }

                paginationHTML += '</div></div>';
                return paginationHTML;
            }

            // ç”Ÿæˆå¤´éƒ¨HTML
            function generateHeaderHTML(activeCategory = 'all', resultsCount = 0) {
                // å§‹ç»ˆä½¿ç”¨bob.mdä¸­çš„åˆ†ç±»
                const firstLevelCategories = window.bobCategories || ['åœ£ç»ç ”è¯»', 'ç”Ÿå‘½è¯»ç»', 'å±çµä¹¦æŠ¥', 'å€ªè‘—æ–‡é›†', 'æè‘—æ–‡é›†', 'ç‰¹ä¼šçº²ç›®', 'è¯—æ­Œåˆè¾‘'];
                console.log('ä½¿ç”¨bob.mdåˆ†ç±»:', firstLevelCategories);

                return `
          <div class="search-results-header">
            <div class="results-tabs">
              <div class="tab-item ${activeCategory === 'all' ? 'active' : ''}" data-category="all">å…¨éƒ¨</div>
              ${firstLevelCategories.map(cat => `<div class="tab-item ${activeCategory === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>`).join('')}
            </div>
            <div class="results-info-line">
              <div class="results-count">å…± ${resultsCount} ä¸ª</div>
              <div class="results-controls">
                <button class="sort-by-matches-btn" id="sort-by-matches-btn" title="æŒ‰åŒ¹é…æ•°æ’åº">ğŸ“Š</button>
                <button class="toggle-all-btn" id="toggle-all-btn" title="å±•å¼€å…¨éƒ¨">ğŸ“‚</button>
                <button class="close-results-btn" id="close-results-btn">Ã—</button>
              </div>
            </div>
          </div>
          <div class="results-content" id="results-content"></div>
          <div class="pagination-container" id="pagination-container"></div>
          <style>
            @keyframes loading {
              0%, 100% { transform: translateX(-100%); }
              50% { transform: translateX(100%); }
            }
            .results-filter {
              margin: 10px 0;
            }
            .results-filter label {
              margin-right: 8px;
              font-weight: bold;
            }
            .results-filter select {
              padding: 4px 8px;
              border: 1px solid #ddd;
              border-radius: 4px;
              background: white;
            }
            .sort-by-matches-btn {
              background: #f0f0f0;
              border: 1px solid #ddd;
              border-radius: 4px;
              padding: 6px 8px;
              cursor: pointer;
              font-size: 14px;
              margin-right: 5px;
              transition: all 0.2s ease;
            }
            .sort-by-matches-btn:hover {
              background: #e0e0e0;
              border-color: #bbb;
            }
            .sort-by-matches-btn.active {
              color: white;
              border-color: #0056b3;
            }
            .sort-by-matches-btn.desc {
              background: #007bff; /* è“è‰²è¡¨ç¤ºé™åº */
            }
            .sort-by-matches-btn.asc {
              background: #28a745; /* ç»¿è‰²è¡¨ç¤ºå‡åº */
            }
            .toggle-all-btn {
              background: #f0f0f0;
              border: 1px solid #ddd;
              border-radius: 4px;
              padding: 6px 8px;
              cursor: pointer;
              font-size: 14px;
              margin-right: 5px;
              transition: all 0.2s ease;
            }
            .toggle-all-btn:hover {
              background: #e0e0e0;
              border-color: #bbb;
            }
            .toggle-all-btn.expanded {
              background: #17a2b8; /* é’è‰²è¡¨ç¤ºå·²å±•å¼€çŠ¶æ€ */
              color: white;
              border-color: #138496;
            }
          </style>
        `;
            }

            // ç”Ÿæˆå•é¡µç»“æœHTML
            function generatePageHTML(pageResults, startIndex) {
                let html = '';

                pageResults.forEach((result, index) => {
                    const globalIndex = startIndex + index;
                    const documentId = `doc-${globalIndex}`;

                    html += `
            <div class="search-result-item" data-book-path="${result.bookPath}" data-chapter-name="${result.chapterName}">
              <div class="search-result-header">
                <div class="search-result-title" data-document-id="${documentId}">
                  ${result.bookName} - ${result.title}
                  <span class="match-count">(${result.matchCount}å¤„åŒ¹é…)</span>
                  <span class="toggle-icon collapsed">â–¶</span>
                </div>
              </div>
              <div class="search-result-contexts" id="${documentId}" style="display: none;">`;

                    // æ·»åŠ åŒ¹é…çš„ä¸Šä¸‹æ–‡
                    result.contexts.forEach((ctx, j) => {
                        const matchPosition = ctx.position;
                        const lineNumber = ctx.lineNumber || 0;
                        const matchTypeClass = ctx.type === 'title' ? 'title-match' :
                            ctx.type === 'footnote' ? 'footnote-match' :
                                ctx.type === 'verse' ? 'verse-match' : 'content-match';

                        // ä¸ºè„šæ³¨åŒ¹é…æ·»åŠ é¢å¤–çš„æ•°æ®å±æ€§
                        const footnoteAttributes = ctx.type === 'footnote' ?
                            `data-footnote-key="${ctx.footnoteKey || ''}" data-section-number="${ctx.sectionNumber || ''}"` : '';

                        // ä¸ºç»æ–‡åŒ¹é…æ·»åŠ é¢å¤–çš„æ•°æ®å±æ€§
                        const verseAttributes = ctx.type === 'verse' ?
                            `data-section-number="${ctx.verseNumber || ''}"` : '';

                        // ä½¿ç”¨æ–°çš„é«˜äº®å‡½æ•°ï¼Œåªé«˜äº®å½“å‰åŒ¹é…ä½ç½®çš„æœç´¢è¯
                        const highlightedText = highlightSearchTermAtPosition(ctx.context, searchTerm, matchPosition);

                        html += `
              <div class="context-item ${matchTypeClass}"
                   data-book-path="${result.bookPath}"
                   data-chapter-name="${result.chapterName}"
                   data-match-position="${matchPosition}"
                   data-line-number="${lineNumber}"
                   data-match-type="${ctx.type}"
                   ${footnoteAttributes}
                   ${verseAttributes}>
                <div class="context-number">${j + 1}.</div>
                <div class="context-text">${highlightedText}</div>
              </div>`;
                    });

                    // å¦‚æœæœ‰æ›´å¤šåŒ¹é…æœªæ˜¾ç¤ºï¼Œæ·»åŠ æç¤º
                    if (result.matchCount > result.contexts.length) {
                        html += `<div class="more-matches">è¿˜æœ‰ ${result.matchCount - result.contexts.length} å¤„åŒ¹é…...</div>`;
                    }

                    html += `</div></div>`;
                });

                return html;
            }

            // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
            function showPage(pageNumber) {
                // ä½¿ç”¨å½“å‰æ˜¾ç¤ºçš„ç»“æœæ•°ç»„
                const currentResults = window.currentDisplayResults || results;
                const totalPages = Math.ceil(currentResults.length / RESULTS_PER_PAGE);

                // éªŒè¯é¡µç 
                if (pageNumber < 0 || pageNumber >= totalPages) return;

                const start = pageNumber * RESULTS_PER_PAGE;
                const end = Math.min(start + RESULTS_PER_PAGE, currentResults.length);

                // ç”Ÿæˆå½“å‰é¡µçš„ç»“æœ
                const pageResults = currentResults.slice(start, end);
                const pageHTML = generatePageHTML(pageResults, start);

                // æ›´æ–°é¡µé¢å†…å®¹
                const resultsContent = document.getElementById('results-content');
                resultsContent.innerHTML = pageHTML;

                // æ›´æ–°é¡µç å¯¼èˆª
                const paginationContainer = document.getElementById('pagination-container');
                paginationContainer.innerHTML = generatePaginationHTML(pageNumber, totalPages, currentResults.length);

                // æ›´æ–°å½“å‰é¡µç 
                currentPage = pageNumber;

                console.log(`æ˜¾ç¤ºç¬¬ ${pageNumber + 1} é¡µï¼Œç»“æœ ${start + 1}-${end} / å…± ${currentResults.length} ä¸ª`);

                // ç»‘å®šäº‹ä»¶
                bindPageEvents();
                bindPaginationEvents();

                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                const searchResults = document.getElementById('search-results');
                if (searchResults) {
                    searchResults.scrollTop = 0;
                }
            }

            // ç»‘å®šé¡µç å¯¼èˆªäº‹ä»¶
            function bindPaginationEvents() {
                const paginationBtns = document.querySelectorAll('.pagination-btn');
                paginationBtns.forEach(btn => {
                    if (!btn.hasAttribute('data-bound')) {
                        btn.setAttribute('data-bound', 'true');
                        btn.addEventListener('click', function () {
                            const targetPage = parseInt(this.getAttribute('data-page'));
                            showPage(targetPage);
                        });
                    }
                });
            }

            // ç§»é™¤åŠ è½½çŠ¶æ€æ ·å¼
            searchResults.classList.remove('loading-state');

            // åˆå§‹åŒ–æ˜¾ç¤º
            searchResults.innerHTML = generateHeaderHTML(activeCategory, results.length);

            // è®¾ç½®å½“å‰æ˜¾ç¤ºçš„ç»“æœ
            window.currentDisplayResults = results;

            // æ˜¾ç¤ºç¬¬ä¸€é¡µ
            showPage(0);

            // å…¨å±€å˜é‡ï¼Œç”¨äºåˆ†ç±»ç­›é€‰
            // åªåœ¨åˆå§‹æœç´¢æ—¶è®¾ç½® allSearchResultsï¼Œç­›é€‰æ—¶ä¸è¦ä¿®æ”¹
            if (activeCategory === 'all') {
                window.allSearchResults = results;
                console.log('è®¾ç½® window.allSearchResultsï¼Œé•¿åº¦:', results.length);
            } else {
                console.log('ç­›é€‰æ“ä½œï¼Œä¿æŒ window.allSearchResults ä¸å˜ï¼Œé•¿åº¦:', window.allSearchResults ? window.allSearchResults.length : 0);
            }
            window.currentSearchTerm = searchTerm;
            window.filteredResults = results;

            // ç»‘å®šå¤´éƒ¨äº‹ä»¶çš„å‡½æ•°ï¼ˆåˆ†ç±»æ ‡ç­¾å’Œå…³é—­æŒ‰é’®ï¼‰
            function bindHeaderEvents() {
                // ç»‘å®štabåˆ‡æ¢äº‹ä»¶
                const resultTabItems = document.querySelectorAll('.results-tabs .tab-item');
                resultTabItems.forEach(tab => {
                    if (!tab.hasAttribute('data-bound')) {
                        tab.setAttribute('data-bound', 'true');
                        tab.addEventListener('click', function () {
                            // è·å–é€‰ä¸­çš„åˆ†ç±»
                            const selectedCategory = this.getAttribute('data-category');
                            console.log('åˆ‡æ¢åˆ°åˆ†ç±»:', selectedCategory);

                            // æ‰§è¡Œåˆ†ç±»ç­›é€‰ï¼ˆè¿™ä¼šé‡æ–°ç”Ÿæˆæ•´ä¸ªç•Œé¢ï¼ŒåŒ…æ‹¬æ­£ç¡®çš„activeçŠ¶æ€ï¼‰
                            filterResultsByCategory(selectedCategory);
                        });
                    }
                });

                // ä¸ºå…³é—­æŒ‰é’®æ·»åŠ äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
                const closeResultsBtn = document.getElementById('close-results-btn');
                if (closeResultsBtn && !closeResultsBtn.hasAttribute('data-bound')) {
                    closeResultsBtn.setAttribute('data-bound', 'true');
                    closeResultsBtn.addEventListener('click', function () {
                        floatingResultsContainer.classList.remove('active');
                        const floatingSearchContainer = document.getElementById('floating-search-container');
                        if (!floatingSearchContainer || !floatingSearchContainer.classList.contains('active')) {
                            document.documentElement.classList.remove('modal-open');
                        }
                    });
                }

                // ä¸ºæŒ‰åŒ¹é…æ•°æ’åºæŒ‰é’®æ·»åŠ äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
                const sortByMatchesBtn = document.getElementById('sort-by-matches-btn');
                if (sortByMatchesBtn && !sortByMatchesBtn.hasAttribute('data-bound')) {
                    sortByMatchesBtn.setAttribute('data-bound', 'true');

                    // åˆå§‹åŒ–æ’åºçŠ¶æ€ï¼ˆå¦‚æœæ²¡æœ‰è®¾ç½®ï¼‰
                    if (window.sortState === undefined) {
                        window.sortState = 'original'; // 'original', 'desc', 'asc'
                    }

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    updateSortButtonState(sortByMatchesBtn, window.sortState);

                    sortByMatchesBtn.addEventListener('click', function () {
                        console.log('ğŸ”„ åˆ‡æ¢æ’åºçŠ¶æ€');

                        // å¾ªç¯åˆ‡æ¢æ’åºçŠ¶æ€ï¼šåŸå§‹ â†’ é™åº â†’ å‡åº â†’ åŸå§‹
                        switch (window.sortState) {
                            case 'original':
                                window.sortState = 'desc';
                                break;
                            case 'desc':
                                window.sortState = 'asc';
                                break;
                            case 'asc':
                                window.sortState = 'original';
                                break;
                            default:
                                window.sortState = 'desc';
                        }

                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        updateSortButtonState(this, window.sortState);

                        // æ‰§è¡Œæ’åº
                        applySorting(window.sortState);
                    });
                }

                // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
                function updateSortButtonState(button, state) {
                    button.classList.remove('active', 'desc', 'asc');

                    switch (state) {
                        case 'original':
                            button.title = 'æŒ‰åŒ¹é…æ•°æ’åºï¼ˆé™åºï¼‰';
                            button.textContent = 'ğŸ“Š';
                            break;
                        case 'desc':
                            button.classList.add('active', 'desc');
                            button.title = 'æŒ‰åŒ¹é…æ•°æ’åºï¼ˆå‡åºï¼‰';
                            button.textContent = 'ğŸ“Šâ†“';
                            break;
                        case 'asc':
                            button.classList.add('active', 'asc');
                            button.title = 'æ¢å¤åŸå§‹é¡ºåº';
                            button.textContent = 'ğŸ“Šâ†‘';
                            break;
                    }
                }

                // åº”ç”¨æ’åºçš„å‡½æ•°
                function applySorting(state) {
                    const currentResults = window.currentDisplayResults || [];

                    // åœ¨ç¬¬ä¸€æ¬¡æ’åºæ—¶ä¿å­˜åŸå§‹é¡ºåº
                    if (!window.originalSearchResults) {
                        window.originalSearchResults = [...currentResults];
                        console.log('ğŸ’¾ ä¿å­˜åŸå§‹æœç´¢ç»“æœé¡ºåºï¼Œé•¿åº¦:', window.originalSearchResults.length);
                    }

                    let sortedResults;

                    switch (state) {
                        case 'original':
                            console.log('ğŸ“‹ æ¢å¤åŸå§‹é¡ºåº');
                            sortedResults = window.originalSearchResults || currentResults;
                            break;
                        case 'desc':
                            console.log('ğŸ“Šâ†“ æŒ‰åŒ¹é…æ•°é™åºæ’åº');
                            sortedResults = [...currentResults].sort((a, b) => {
                                const matchCountA = a.matchCount || a.contexts?.length || 0;
                                const matchCountB = b.matchCount || b.contexts?.length || 0;
                                return matchCountB - matchCountA; // é™åºï¼šå¤šåˆ°å°‘
                            });
                            break;
                        case 'asc':
                            console.log('ğŸ“Šâ†‘ æŒ‰åŒ¹é…æ•°å‡åºæ’åº');
                            sortedResults = [...currentResults].sort((a, b) => {
                                const matchCountA = a.matchCount || a.contexts?.length || 0;
                                const matchCountB = b.matchCount || b.contexts?.length || 0;
                                return matchCountA - matchCountB; // å‡åºï¼šå°‘åˆ°å¤š
                            });
                            break;
                        default:
                            sortedResults = currentResults;
                    }

                    console.log(`ğŸ“Š æ’åºå®Œæˆï¼š${sortedResults.length} ä¸ªç»“æœï¼ŒçŠ¶æ€ï¼š${state}`);
                    displaySearchResults(sortedResults, window.currentSearchTerm, window.currentActiveCategory);
                }
            }

            // ç»‘å®šé¡µé¢äº‹ä»¶çš„å‡½æ•°
            function bindPageEvents() {
                // å…ˆç»‘å®šå¤´éƒ¨äº‹ä»¶
                bindHeaderEvents();

                // ä¸ºå…¨å±€å±•å¼€/æŠ˜å åˆ‡æ¢æŒ‰é’®æ·»åŠ äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
                const toggleAllBtn = document.getElementById('toggle-all-btn');

                if (toggleAllBtn && !toggleAllBtn.hasAttribute('data-bound')) {
                    toggleAllBtn.setAttribute('data-bound', 'true');

                    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€ï¼ˆé»˜è®¤ä¸ºæŠ˜å çŠ¶æ€ï¼‰
                    window.allExpanded = false;
                    updateToggleAllButtonState(toggleAllBtn, window.allExpanded);

                    toggleAllBtn.addEventListener('click', function () {
                        const allContexts = document.querySelectorAll('.search-result-contexts');

                        // åˆ‡æ¢çŠ¶æ€
                        window.allExpanded = !window.allExpanded;

                        if (window.allExpanded) {
                            // å±•å¼€å…¨éƒ¨
                            console.log('ğŸ“‚ å±•å¼€å…¨éƒ¨æœç´¢ç»“æœ');
                            allContexts.forEach(context => {
                                context.style.display = 'block';
                                const titleElement = document.querySelector(`.search-result-title[data-document-id="${context.id}"]`);
                                if (titleElement) {
                                    const toggleIcon = titleElement.querySelector('.toggle-icon');
                                    if (toggleIcon) {
                                        toggleIcon.textContent = 'â–¼';
                                        toggleIcon.classList.add('expanded');
                                        toggleIcon.classList.remove('collapsed');
                                    }
                                }
                            });
                        } else {
                            // æŠ˜å å…¨éƒ¨
                            console.log('ğŸ“ æŠ˜å å…¨éƒ¨æœç´¢ç»“æœ');
                            allContexts.forEach(context => {
                                context.style.display = 'none';
                                const titleElement = document.querySelector(`.search-result-title[data-document-id="${context.id}"]`);
                                if (titleElement) {
                                    const toggleIcon = titleElement.querySelector('.toggle-icon');
                                    if (toggleIcon) {
                                        toggleIcon.textContent = 'â–¶';
                                        toggleIcon.classList.add('collapsed');
                                        toggleIcon.classList.remove('expanded');
                                    }
                                }
                            });
                        }

                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        updateToggleAllButtonState(this, window.allExpanded);
                    });
                }

                // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
                function updateToggleAllButtonState(button, isExpanded) {
                    if (isExpanded) {
                        button.classList.add('expanded');
                        button.textContent = 'ğŸ“';
                        button.title = 'æŠ˜å å…¨éƒ¨';
                    } else {
                        button.classList.remove('expanded');
                        button.textContent = 'ğŸ“‚';
                        button.title = 'å±•å¼€å…¨éƒ¨';
                    }
                }

                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¸ºç»“æœé¡¹ç»‘å®šäº‹ä»¶
                const resultsContent = document.getElementById('results-content');
                if (resultsContent && !resultsContent.hasAttribute('data-bound')) {
                    resultsContent.setAttribute('data-bound', 'true');

                    resultsContent.addEventListener('click', function (e) {
                        const target = e.target;

                        // å¤„ç†æ ‡é¢˜ç‚¹å‡» - å±•å¼€/æŠ˜å 
                        if (target.classList.contains('search-result-title') || target.closest('.search-result-title')) {
                            const titleElement = target.classList.contains('search-result-title') ? target : target.closest('.search-result-title');
                            const documentId = titleElement.getAttribute('data-document-id');
                            const contextContainer = document.getElementById(documentId);
                            const toggleIcon = titleElement.querySelector('.toggle-icon');

                            if (contextContainer) {
                                if (contextContainer.style.display === 'none') {
                                    contextContainer.style.display = 'block';
                                    if (toggleIcon) {
                                        toggleIcon.textContent = 'â–¼';
                                        toggleIcon.classList.add('expanded');
                                        toggleIcon.classList.remove('collapsed');
                                    }
                                } else {
                                    contextContainer.style.display = 'none';
                                    if (toggleIcon) {
                                        toggleIcon.textContent = 'â–¶';
                                        toggleIcon.classList.add('collapsed');
                                        toggleIcon.classList.remove('expanded');
                                    }
                                }
                            }
                            e.stopPropagation();
                        }

                        // å¤„ç†ä¸Šä¸‹æ–‡é¡¹ç‚¹å‡» - è·³è½¬åˆ°ç« èŠ‚
                        else if (target.classList.contains('context-item') || target.closest('.context-item')) {
                            const contextItem = target.classList.contains('context-item') ? target : target.closest('.context-item');
                            const bookPath = contextItem.getAttribute('data-book-path');
                            const chapterName = contextItem.getAttribute('data-chapter-name');
                            const matchPosition = contextItem.getAttribute('data-match-position');
                            const lineNumber = contextItem.getAttribute('data-line-number');
                            const matchType = contextItem.getAttribute('data-match-type');
                            const footnoteKey = contextItem.getAttribute('data-footnote-key');
                            const sectionNumber = contextItem.getAttribute('data-section-number');

                            console.log(`ç‚¹å‡»åŒ¹é…é¡¹: ${chapterName}, è·¯å¾„: ${bookPath}, ä½ç½®: ${matchPosition}, è¡Œå·: ${lineNumber}, ç±»å‹: ${matchType}, è„šæ³¨é”®: ${footnoteKey}, èŠ‚å·: ${sectionNumber}`);

                            // ç”Ÿæˆå”¯ä¸€çš„é”šç‚¹ID
                            const anchorId = `match-${matchPosition}`;

                            // å¦‚æœæ˜¯è„šæ³¨åŒ¹é…ï¼Œç›´æ¥å¼¹å‡ºè„šæ³¨çª—å£ï¼Œä¸å…³é—­æœç´¢ç»“æœ
                            if (matchType === 'footnote' && footnoteKey) {
                                console.log(`è„šæ³¨åŒ¹é…ï¼Œç›´æ¥å¼¹å‡ºè„šæ³¨çª—å£: è„šæ³¨é”®="${footnoteKey}"`);

                                // ä»æœç´¢ç´¢å¼•ä¸­è·å–å®Œæ•´çš„è„šæ³¨å†…å®¹
                                let footnoteContent = '';
                                let foundFootnote = false;

                                console.log(`æŸ¥æ‰¾è„šæ³¨: é”®="${footnoteKey}", èŠ‚å·="${sectionNumber}", è·¯å¾„="${bookPath}/${chapterName}"`);

                                // é¦–å…ˆå°è¯•æ ¹æ®èŠ‚å·ç²¾ç¡®æŸ¥æ‰¾è„šæ³¨
                                for (const indexItem of searchIndex) {
                                    const itemBookPath = indexItem.bookPath || indexItem.bp || '';
                                    const itemChapterName = indexItem.chapterName || indexItem.cn || '';
                                    const itemFootnotes = indexItem.footnotes || indexItem.f || {};

                                    if (itemBookPath === bookPath &&
                                        itemChapterName === chapterName &&
                                        itemFootnotes && Object.keys(itemFootnotes).length > 0) {

                                        // æŸ¥æ‰¾åŒ¹é…èŠ‚å·çš„è„šæ³¨
                                        for (const [key, data] of Object.entries(itemFootnotes)) {
                                            let footnoteData = data;
                                            let originalKey = key;
                                            let footnoteSectionNumber = '';

                                            // å¤„ç†è„šæ³¨æ•°æ®ç»“æ„
                                            if (typeof data === 'object' && data.content) {
                                                footnoteData = data;
                                                originalKey = data.originalKey || key;
                                                footnoteSectionNumber = data.sectionNumber || '';
                                            }

                                            // æ£€æŸ¥è„šæ³¨é”®å’ŒèŠ‚å·æ˜¯å¦åŒ¹é…
                                            if (originalKey === footnoteKey && footnoteSectionNumber === sectionNumber) {
                                                if (typeof footnoteData === 'string') {
                                                    footnoteContent = footnoteData;
                                                } else {
                                                    footnoteContent = footnoteData.content;
                                                }
                                                foundFootnote = true;
                                                console.log(`âœ… æ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„è„šæ³¨: é”®="${originalKey}", èŠ‚å·="${footnoteSectionNumber}"`);
                                                break;
                                            }
                                        }
                                        if (foundFootnote) break;
                                    }
                                }

                                // å¦‚æœæ²¡æ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•åªåŒ¹é…è„šæ³¨é”®ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                                if (!foundFootnote) {
                                    console.log('âš ï¸ æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•åªåŒ¹é…è„šæ³¨é”®');
                                    for (const indexItem of searchIndex) {
                                        const itemBookPath = indexItem.bookPath || indexItem.bp || '';
                                        const itemChapterName = indexItem.chapterName || indexItem.cn || '';
                                        const itemFootnotes = indexItem.footnotes || indexItem.f || {};

                                        if (itemBookPath === bookPath &&
                                            itemChapterName === chapterName &&
                                            itemFootnotes && Object.keys(itemFootnotes).length > 0) {

                                            for (const [key, data] of Object.entries(itemFootnotes)) {
                                                const originalKey = (typeof data === 'object' && data.originalKey) ? data.originalKey : key;
                                                if (originalKey === footnoteKey) {
                                                    if (typeof data === 'string') {
                                                        footnoteContent = data;
                                                    } else {
                                                        footnoteContent = data.content;
                                                    }
                                                    foundFootnote = true;
                                                    console.log(`âš ï¸ æ‰¾åˆ°è„šæ³¨é”®åŒ¹é…: é”®="${originalKey}"`);
                                                    break;
                                                }
                                            }
                                            if (foundFootnote) break;
                                        }
                                    }
                                }

                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®Œæ•´å†…å®¹ï¼Œä½¿ç”¨æ˜¾ç¤ºçš„ä¸Šä¸‹æ–‡å†…å®¹
                                if (!footnoteContent) {
                                    footnoteContent = contextItem.querySelector('.context-text').textContent;
                                }

                                // ä»æœç´¢ç»“æœä¸­è·å–ä¹¦ç±ä¿¡æ¯
                                let bookName = '';
                                const bookPathParts = bookPath.split('/');
                                if (bookPathParts.length >= 2) {
                                    bookName = bookPathParts[bookPathParts.length - 2]; // è·å–ä¹¦ç±åï¼ˆå€’æ•°ç¬¬äºŒä¸ªéƒ¨åˆ†ï¼‰
                                }

                                // åˆ›å»ºè„šæ³¨å¼¹çª—
                                showDirectFootnotePopup(footnoteKey, footnoteContent, searchTerm, bookName, chapterName, sectionNumber);
                            }
                            // å¦‚æœæ˜¯ç»æ–‡åŒ¹é…ï¼Œç›´æ¥å¼¹å‡ºç»æ–‡çª—å£
                            else if (matchType === 'verse') {
                                console.log(`ç»æ–‡åŒ¹é…ï¼Œç›´æ¥å¼¹å‡ºç»æ–‡çª—å£: ç« èŠ‚="${chapterName}"`);

                                // ä»æœç´¢ç´¢å¼•ä¸­è·å–ç»æ–‡æ•°æ®
                                let verseData = null;
                                for (const indexItem of searchIndex) {
                                    const itemBookPath = indexItem.bookPath || indexItem.bp || '';
                                    const itemChapterName = indexItem.chapterName || indexItem.cn || '';

                                    if (indexItem.type === 'verse' &&
                                        itemBookPath === bookPath &&
                                        itemChapterName === chapterName &&
                                        indexItem.verseNumber === sectionNumber) {
                                        verseData = indexItem;
                                        break;
                                    }
                                }

                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»æ–‡æ•°æ®ï¼Œä»ä¸Šä¸‹æ–‡ä¸­æ„å»º
                                if (!verseData) {
                                    const contextText = contextItem.querySelector('.context-text').textContent;
                                    const bookPathParts = bookPath.split('/');
                                    const actualBookName = bookPathParts.length >= 2 ? bookPathParts[bookPathParts.length - 2] : '';

                                    verseData = {
                                        title: `${actualBookName}${chapterName}:${sectionNumber}`,
                                        content: contextText,
                                        verseNumber: sectionNumber,
                                        bookName: "åœ£ç»ç ”è¯»",
                                        actualBookName: actualBookName,
                                        chapterName: chapterName,
                                        type: 'verse'
                                    };
                                }

                                // åˆ›å»ºç»æ–‡å¼¹çª—
                                showVersePopup(verseData, searchTerm);
                            }
                            // å¦‚æœæ˜¯åœ£ç»ç ”è¯»çš„å†…å®¹åŒ¹é…ï¼Œä¹Ÿæ˜¾ç¤ºå¼¹çª—è€Œä¸æ˜¯è·³è½¬
                            else if (bookPath && bookPath.includes('åœ£ç»ç ”è¯»') && matchType === 'content') {
                                console.log(`ğŸ¯ åœ£ç»ç ”è¯»å†…å®¹åŒ¹é…ï¼Œæ˜¾ç¤ºå¼¹çª—: ç« èŠ‚="${chapterName}"`);

                                // ä»ä¸Šä¸‹æ–‡ä¸­è·å–æ–‡æœ¬å†…å®¹
                                const contextText = contextItem.querySelector('.context-text').textContent;
                                const bookPathParts = bookPath.split('/');
                                const actualBookName = bookPathParts.length >= 2 ? bookPathParts[bookPathParts.length - 2] : '';

                                // åˆ›å»ºä¸´æ—¶çš„ç»æ–‡æ•°æ®
                                const verseData = {
                                    title: `${actualBookName}${chapterName}`,
                                    content: contextText,
                                    verseNumber: sectionNumber || '1', // å¦‚æœæ²¡æœ‰èŠ‚å·ï¼Œé»˜è®¤ä¸º1
                                    bookName: "åœ£ç»ç ”è¯»",
                                    actualBookName: actualBookName,
                                    chapterName: chapterName,
                                    type: 'verse'
                                };

                                // åˆ›å»ºç»æ–‡å¼¹çª—
                                showVersePopup(verseData, searchTerm);
                            }
                            // ç»Ÿä¸€ä½¿ç”¨å…¨å±å¼¹çª—å¤„ç†æ‰€æœ‰å…¶ä»–ç±»å‹çš„åŒ¹é…
                            else {
                                console.log(`ğŸ¯ ä½¿ç”¨å…¨å±å¼¹çª—æ˜¾ç¤º: bookPath="${bookPath}", matchType="${matchType}", matchPosition="${matchPosition}"`);

                                // ä½¿ç”¨å…¨å±å¼¹çª—åŠ è½½ç« èŠ‚ï¼Œä¼ é€’ç‚¹å‡»çš„å…ƒç´ ç”¨äºæå–æ ‡é¢˜å’ŒåŒ¹é…ä½ç½®
                                loadChapterInModal(bookPath, chapterName, searchTerm, '', contextItem, parseInt(matchPosition) || 1);
                            }
                            e.stopPropagation();
                        }
                    });
                }
            }

            console.log('åˆ†é¡µæœç´¢ç»“æœæ˜¾ç¤ºå®Œæˆ');
        }



        // åœ¨ç« èŠ‚å†…å®¹ä¸­é«˜äº®æœç´¢è¯ï¼ˆæ™ºèƒ½å¤„ç†è„šæ³¨æ ‡è®°ï¼‰
        function highlightContentSearchTerm(searchTerm, anchorId = '', lineNumber = 0) {
            if (!searchTerm) return;

            console.log(`å¯¹ç« èŠ‚å†…å®¹ä¸­çš„æœç´¢è¯ "${searchTerm}" è¿›è¡Œé«˜äº®å¤„ç†ï¼Œé”šç‚¹: ${anchorId}, è¡Œå·: ${lineNumber}`);

            // è·å–å†…å®¹å…ƒç´ 
            const contentDiv = document.getElementById("content");
            if (!contentDiv) return;

            // åˆ›å»ºTreeWalkeræ¥éå†æ–‡æœ¬èŠ‚ç‚¹
            const walker = document.createTreeWalker(
                contentDiv,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function (node) {
                        // è·³è¿‡scriptæ ‡ç­¾ä¸­çš„å†…å®¹
                        if (node.parentNode.tagName === 'SCRIPT') {
                            return NodeFilter.FILTER_REJECT;
                        }

                        // æ™ºèƒ½åŒ¹é…ï¼šæ£€æŸ¥åŸæ–‡æœ¬æˆ–å»é™¤è„šæ³¨æ ‡è®°åçš„æ–‡æœ¬æ˜¯å¦åŒ…å«æœç´¢è¯
                        const originalText = node.textContent.toLowerCase();
                        const cleanText = originalText.replace(/\[\^[^\]]+\]/g, ''); // å»é™¤è„šæ³¨æ ‡è®°

                        if (originalText.includes(searchTerm.toLowerCase()) ||
                            cleanText.includes(searchTerm.toLowerCase())) {
                            return NodeFilter.FILTER_ACCEPT;
                        }
                        return NodeFilter.FILTER_SKIP;
                    }
                }
            );

            // æ”¶é›†éœ€è¦æ›¿æ¢çš„èŠ‚ç‚¹
            const nodesToReplace = [];
            let currentNode;
            let currentHighlightId = 0;

            while (currentNode = walker.nextNode()) {
                nodesToReplace.push({
                    node: currentNode,
                    highlightId: ++currentHighlightId  // ä¸ºæ¯ä¸ªåŒ¹é…åˆ†é…å”¯ä¸€ID
                });
            }

            // æ™ºèƒ½æ›¿æ¢èŠ‚ç‚¹å†…å®¹ï¼Œå¤„ç†è„šæ³¨æ ‡è®°
            nodesToReplace.forEach(nodeInfo => {
                const node = nodeInfo.node;
                const highlightId = nodeInfo.highlightId;

                // ä¸ºæ¯ä¸ªåŒ¹é…ç”Ÿæˆå”¯ä¸€ID
                const matchId = `match-${highlightId}`;

                const originalText = node.textContent;
                let newContent = originalText;

                // æ™ºèƒ½é«˜äº®ï¼šä½¿ç”¨æ›´ç®€å•å¯é çš„æ–¹æ³•
                const searchTermLower = searchTerm.toLowerCase();
                const originalTextLower = originalText.toLowerCase();

                // 1. é¦–å…ˆå°è¯•ç›´æ¥åŒ¹é…
                if (originalTextLower.includes(searchTermLower)) {
                    const directRegex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    newContent = originalText.replace(directRegex, `<span id="${matchId}" class="search-highlight" data-match-id="${highlightId}">$1</span>`);
                } else {
                    // 2. å¦‚æœç›´æ¥åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ™ºèƒ½åŒ¹é…ï¼ˆå¤„ç†è„šæ³¨æ ‡è®°ï¼‰
                    // åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œè®°å½•åŸæ–‡ä¸­æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„æ¸…ç†åæ–‡æœ¬çš„ä½ç½®
                    const cleanText = originalText.replace(/\[\^[^\]]+\]/g, '');
                    const cleanTextLower = cleanText.toLowerCase();

                    if (cleanTextLower.includes(searchTermLower)) {
                        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²åŸæ–‡ï¼Œä¿ç•™è„šæ³¨æ ‡è®°
                        const parts = originalText.split(/(\[\^[^\]]+\])/);
                        let reconstructed = '';
                        let cleanPosition = 0;
                        let found = false;

                        for (let i = 0; i < parts.length; i++) {
                            const part = parts[i];

                            if (part.match(/^\[\^[^\]]+\]$/)) {
                                // è¿™æ˜¯è„šæ³¨æ ‡è®°ï¼Œç›´æ¥æ·»åŠ 
                                reconstructed += part;
                            } else {
                                // è¿™æ˜¯æ™®é€šæ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æœç´¢è¯
                                const partLower = part.toLowerCase();
                                const searchIndex = partLower.indexOf(searchTermLower);

                                if (searchIndex !== -1 && !found) {
                                    // åœ¨è¿™éƒ¨åˆ†æ‰¾åˆ°äº†æœç´¢è¯
                                    const before = part.substring(0, searchIndex);
                                    const match = part.substring(searchIndex, searchIndex + searchTerm.length);
                                    const after = part.substring(searchIndex + searchTerm.length);

                                    reconstructed += before + `<span id="${matchId}" class="search-highlight" data-match-id="${highlightId}">${match}</span>` + after;
                                    found = true;
                                } else {
                                    reconstructed += part;
                                }
                                cleanPosition += part.length;
                            }
                        }

                        if (found) {
                            newContent = reconstructed;
                        }
                    }
                }

                // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥åŒ…å«æ›¿æ¢åçš„HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newContent;

                // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µæ¥æ›¿æ¢åŸèŠ‚ç‚¹
                const fragment = document.createDocumentFragment();
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }

                // æ›¿æ¢åŸèŠ‚ç‚¹
                node.parentNode.replaceChild(fragment, node);
            });

            // å¦‚æœæ‰¾åˆ°äº†åŒ¹é…é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªæ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé«˜äº®çš„åŠŸèƒ½
            const highlights = contentDiv.querySelectorAll('.search-highlight');
            if (highlights.length > 0) {
                console.log(`åœ¨ç« èŠ‚å†…å®¹ä¸­æ‰¾åˆ° ${highlights.length} ä¸ªåŒ¹é…é¡¹`);

                // ç§»é™¤ä»»ä½•å·²å­˜åœ¨çš„æœç´¢å¯¼èˆªæ 
                const existingSearchInfo = document.getElementById('search-nav-floating');
                if (existingSearchInfo) {
                    existingSearchInfo.remove();
                }

                // åˆ›å»ºæ‚¬æµ®çš„å¯¼èˆªé¢æ¿
                const searchInfo = document.createElement('div');
                searchInfo.className = 'search-info floating';
                searchInfo.id = 'search-nav-floating';
                searchInfo.innerHTML = `
            <div class="highlight-navigation">
              <span class="current-highlight">1</span>/<span class="total-highlights">${highlights.length}</span>
              <button class="nav-highlight-btn prev-btn" id="prev-highlight-btn">ä¸Šä¸€ä¸ª</button>
              <button class="nav-highlight-btn next-btn" id="next-highlight-btn">ä¸‹ä¸€ä¸ª</button>
              <button class="clear-highlight-btn" id="clear-highlight-btn">æ¸…é™¤é«˜äº®</button>
            </div>
          </div>
        `;

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(searchInfo);

                // ç¡®å®šè¦æ»šåŠ¨åˆ°å“ªä¸ªåŒ¹é…é¡¹
                let targetHighlight = null;

                if (anchorId) {
                    // å¦‚æœæŒ‡å®šäº†é”šç‚¹IDï¼Œåˆ™æ»šåŠ¨åˆ°å¯¹åº”çš„åŒ¹é…é¡¹
                    targetHighlight = document.getElementById(anchorId);
                }

                if (!targetHighlight && lineNumber > 0) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é”šç‚¹ä½†æœ‰è¡Œå·ï¼Œåˆ™å°è¯•æ‰¾åˆ°æœ€æ¥è¿‘è¡Œå·çš„åŒ¹é…é¡¹
                    // è¿™é‡Œä½¿ç”¨ç®€å•ä¼°ç®—ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç²¾ç¡®çš„è¡Œå·ä¿¡æ¯
                    const contentText = contentDiv.textContent;
                    const contentLines = contentText.split('\n');

                    let currentLine = 0;
                    let bestMatchDistance = Number.MAX_VALUE;
                    let bestMatchElement = null;

                    // æ£€æŸ¥æ¯ä¸ªé«˜äº®å…ƒç´ ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘æŒ‡å®šè¡Œå·çš„å…ƒç´ 
                    highlights.forEach(highlight => {
                        // è®¡ç®—é«˜äº®å…ƒç´ åˆ°æ–‡æ¡£å¼€å¤´çš„æ–‡æœ¬é‡
                        const range = document.createRange();
                        range.setStart(contentDiv, 0);
                        range.setEnd(highlight, 0);
                        const textBefore = range.toString();

                        // æ ¹æ®æ–‡æœ¬è®¡ç®—è¡Œå·
                        const linesBefore = textBefore.split('\n').length;
                        const distance = Math.abs(linesBefore - lineNumber);

                        if (distance < bestMatchDistance) {
                            bestMatchDistance = distance;
                            bestMatchElement = highlight;
                        }
                    });

                    targetHighlight = bestMatchElement;
                }

                // å¦‚æœæ²¡æœ‰ç‰¹å®šç›®æ ‡ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                if (!targetHighlight) {
                    targetHighlight = highlights[0];
                }

                // è®°å½•å½“å‰æ¿€æ´»çš„é«˜äº®ç´¢å¼•
                window.currentHighlightIndex = Array.from(highlights).indexOf(targetHighlight);

                // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (window.currentHighlightIndex < 0 || window.currentHighlightIndex >= highlights.length) {
                    window.currentHighlightIndex = 0;
                    // å¦‚æœç´¢å¼•æ— æ•ˆï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé«˜äº®ä½œä¸ºç›®æ ‡
                    targetHighlight = highlights[0];
                }

                // æ›´æ–°å½“å‰é«˜äº®è®¡æ•°å™¨
                const currentHighlightElement = document.querySelector('.current-highlight');
                if (currentHighlightElement) {
                    currentHighlightElement.textContent = window.currentHighlightIndex + 1;
                }

                console.log(`åˆå§‹åŒ–é«˜äº®ç´¢å¼•: ${window.currentHighlightIndex}, æ€»æ•°: ${highlights.length}`);

                // æ·»åŠ æ¿€æ´»ç±»åˆ°å½“å‰é«˜äº®
                if (targetHighlight) {
                    targetHighlight.classList.add('active-highlight');
                }

                // æ»šåŠ¨åˆ°ç›®æ ‡åŒ¹é…é¡¹
                setTimeout(() => {
                    if (targetHighlight) {
                        targetHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);

                // æ·»åŠ å¯¼èˆªæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
                setTimeout(() => {
                    const prevBtn = document.getElementById('prev-highlight-btn');
                    const nextBtn = document.getElementById('next-highlight-btn');
                    const clearBtn = document.getElementById('clear-highlight-btn');

                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                    if (prevBtn) {
                        prevBtn.replaceWith(prevBtn.cloneNode(true));
                        const newPrevBtn = document.getElementById('prev-highlight-btn');
                        newPrevBtn.addEventListener('click', function () {
                            navigateHighlight(-1);
                        });
                    }

                    if (nextBtn) {
                        nextBtn.replaceWith(nextBtn.cloneNode(true));
                        const newNextBtn = document.getElementById('next-highlight-btn');
                        newNextBtn.addEventListener('click', function () {
                            navigateHighlight(1);
                        });
                    }

                    if (clearBtn) {
                        clearBtn.replaceWith(clearBtn.cloneNode(true));
                        const newClearBtn = document.getElementById('clear-highlight-btn');
                        newClearBtn.addEventListener('click', clearContentHighlight);
                    }
                }, 500);
            } else {
                console.log('åœ¨ç« èŠ‚å†…å®¹ä¸­æœªæ‰¾åˆ°åŒ¹é…é¡¹');
            }
        }

        // æ·»åŠ å¯¼èˆªé«˜äº®é¡¹çš„å‡½æ•°
        function navigateHighlight(direction) {
            // åªæŸ¥è¯¢ç« èŠ‚å†…å®¹åŒºåŸŸçš„é«˜äº®ï¼Œä¸åŒ…æ‹¬æœç´¢ç»“æœåˆ—è¡¨ä¸­çš„é«˜äº®
            const contentDiv = document.getElementById('content');
            const highlights = contentDiv ? contentDiv.querySelectorAll('.search-highlight') : [];
            if (!highlights.length) return;

            console.log(`å¯¼èˆªé«˜äº®ï¼šæ–¹å‘=${direction}, é«˜äº®æ•°é‡=${highlights.length}`);

            // ç¡®ä¿å½“å‰ç´¢å¼•å·²åˆå§‹åŒ–ä¸”åœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (typeof window.currentHighlightIndex === 'undefined' ||
                window.currentHighlightIndex < 0 ||
                window.currentHighlightIndex >= highlights.length) {
                window.currentHighlightIndex = 0;
            }

            console.log(`å½“å‰é«˜äº®ç´¢å¼•: ${window.currentHighlightIndex}`);

            // ç§»é™¤å½“å‰é«˜äº®çš„æ¿€æ´»çŠ¶æ€ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
            if (highlights[window.currentHighlightIndex]) {
                highlights[window.currentHighlightIndex].classList.remove('active-highlight');
            }

            // è®¡ç®—æ–°çš„ç´¢å¼•
            window.currentHighlightIndex = (window.currentHighlightIndex + direction + highlights.length) % highlights.length;

            console.log(`æ–°çš„é«˜äº®ç´¢å¼•: ${window.currentHighlightIndex}`);

            // æ·»åŠ æ¿€æ´»ç±»åˆ°æ–°çš„å½“å‰é«˜äº®
            const newActiveHighlight = highlights[window.currentHighlightIndex];
            if (newActiveHighlight) {
                newActiveHighlight.classList.add('active-highlight');
            }

            // æ›´æ–°å½“å‰é«˜äº®è®¡æ•°å™¨
            const currentHighlightElement = document.querySelector('.current-highlight');
            if (currentHighlightElement) {
                currentHighlightElement.textContent = window.currentHighlightIndex + 1;
            }

            // ç¡®ä¿å…ƒç´ å¯è§
            console.log(`æ»šåŠ¨åˆ°å…ƒç´ : `, newActiveHighlight);

            // ä½¿ç”¨æ›´å¯é çš„æ»šåŠ¨æ–¹æ³•
            try {
                // é¦–å…ˆå°è¯•ä½¿ç”¨scrollIntoView
                newActiveHighlight.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // æ·»åŠ é¢å¤–çš„æ»šåŠ¨é€»è¾‘ä½œä¸ºå¤‡ä»½
                setTimeout(() => {
                    const rect = newActiveHighlight.getBoundingClientRect();
                    const isInViewport = (
                        rect.top >= 0 &&
                        rect.left >= 0 &&
                        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                    );

                    if (!isInViewport) {
                        console.log('å…ƒç´ ä¸åœ¨è§†å£ä¸­ï¼Œä½¿ç”¨å¤‡ç”¨æ»šåŠ¨æ–¹æ³•');
                        const offsetTop = newActiveHighlight.offsetTop;
                        window.scrollTo({
                            top: offsetTop - (window.innerHeight / 2),
                            behavior: 'smooth'
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('æ»šåŠ¨å¤±è´¥:', error);
                // æœ€åçš„å¤‡ç”¨æ–¹æ³•
                try {
                    window.scrollTo({
                        top: newActiveHighlight.offsetTop - 100,
                        behavior: 'smooth'
                    });
                } catch (e) {
                    console.error('å¤‡ç”¨æ»šåŠ¨ä¹Ÿå¤±è´¥:', e);
                }
            }
        }

        // æ¸…é™¤å†…å®¹é«˜äº®
        function clearContentHighlight() {
            console.log('æ¸…é™¤ç« èŠ‚å†…å®¹ä¸­çš„é«˜äº®');

            // ç§»é™¤æœç´¢ä¿¡æ¯æç¤ºï¼ˆåŒ…æ‹¬æ‚¬æµ®é¢æ¿ï¼‰
            const searchInfo = document.querySelector('.search-info');
            if (searchInfo) {
                searchInfo.parentNode.removeChild(searchInfo);
            }

            // ç§»é™¤æ‚¬æµ®çš„å¯¼èˆªé¢æ¿
            const floatingNav = document.getElementById('search-nav-floating');
            if (floatingNav) {
                floatingNav.remove();
            }

            // ç§»é™¤URLä¸­çš„searchå‚æ•°
            const params = new URLSearchParams(window.location.search);
            params.delete('search');
            params.delete('anchor');
            params.delete('line');
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState(window.history.state, '', newUrl);

            // é‡æ–°åŠ è½½å½“å‰ç« èŠ‚ï¼Œä½†ä¸å¸¦æœç´¢è¯
            const chapter = params.get('chapter') || 'bob';
            const dir = params.get('dir') || '';
            loadChapter(chapter, dir);
        }

        // ===== é˜…è¯»è®¾ç½®åŠŸèƒ½ =====

        // åˆ‡æ¢è®¾ç½®é¢æ¿æ˜¾ç¤º/éšè—
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            settingsVisible = !settingsVisible;

            if (settingsVisible) {
                // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                document.documentElement.classList.add('modal-open');
                document.body.style.overflow = 'hidden';

                panel.style.display = 'flex';
                loadSettings();
                initSettingsEvents();

                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
                panel.addEventListener('click', handleSettingsPanelClick);
            } else {
                // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                document.documentElement.classList.remove('modal-open');
                document.body.style.overflow = '';

                panel.style.display = 'none';

                // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                panel.removeEventListener('click', handleSettingsPanelClick);
            }
        }

        // å¤„ç†è®¾ç½®é¢æ¿ç‚¹å‡»äº‹ä»¶
        function handleSettingsPanelClick(event) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯é¢æ¿èƒŒæ™¯ï¼ˆä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰ï¼Œåˆ™å…³é—­é¢æ¿
            if (event.target === event.currentTarget) {
                toggleSettings();
            }
        }

        // åˆå§‹åŒ–è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function initSettingsEvents() {
            // èƒŒæ™¯é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function () {
                    const bgType = this.dataset.bg;
                    setBackgroundColor(bgType);
                    updateColorSelection(bgType);
                });
            });

            // å­—ä½“å¤§å°æ»‘å—
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            fontSizeSlider.addEventListener('input', function () {
                const size = parseInt(this.value);
                setFontSize(size);
                fontSizeValue.textContent = size + 'px';
            });

            // å­—ä½“ç±»å‹é€‰æ‹©
            const fontFamilySelect = document.getElementById('font-family-select');
            fontFamilySelect.addEventListener('change', function () {
                setFontFamily(this.value);
            });

            // è¡Œé—´è·æ»‘å—
            const lineHeightSlider = document.getElementById('line-height-slider');
            const lineHeightValue = document.getElementById('line-height-value');
            lineHeightSlider.addEventListener('input', function () {
                const height = parseFloat(this.value);
                setLineHeight(height);
                lineHeightValue.textContent = height.toString();
            });

            // å†…å®¹å®½åº¦æ»‘å—
            const contentWidthSlider = document.getElementById('content-width-slider');
            const contentWidthValue = document.getElementById('content-width-value');
            contentWidthSlider.addEventListener('input', function () {
                const width = parseInt(this.value);
                setContentWidth(width);
                contentWidthValue.textContent = width + 'px';
            });
        }

        // è®¾ç½®èƒŒæ™¯é¢œè‰²
        function setBackgroundColor(type) {
            const body = document.body;
            const content = document.getElementById('content');

            // ç§»é™¤æ‰€æœ‰èƒŒæ™¯ç±»
            body.classList.remove('bg-default', 'bg-warm', 'bg-dark', 'bg-green');

            // æ·»åŠ æ–°çš„èƒŒæ™¯ç±»
            body.classList.add('bg-' + type);

            currentSettings.backgroundColor = type;
            saveSettings();
        }

        // æ›´æ–°é¢œè‰²é€‰æ‹©çŠ¶æ€
        function updateColorSelection(selectedType) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.bg === selectedType) {
                    option.classList.add('selected');
                }
            });
        }

        // è®¾ç½®å­—ä½“å¤§å°
        function setFontSize(size) {
            document.documentElement.style.setProperty('--content-font-size', size + 'px');
            currentSettings.fontSize = size;
            saveSettings();
        }

        // è®¾ç½®å­—ä½“ç±»å‹
        function setFontFamily(family) {
            let fontFamily;
            switch (family) {
                case 'wenkai':
                    fontFamily = '"éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                case 'huohei':
                    fontFamily = '"å¯’è‰æ´»é»‘ä½“ Bold", sans-serif';
                    break;
                case 'huaxin':
                    fontFamily = '"ä»“è€³åæ–°ä½“", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                case 'jinkai':
                    fontFamily = '"ä»“è€³ä»Šæ¥·03-W03", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                    break;
                case 'pingyindingkai':
                    fontFamily = '"æ¾³å£°é€šæ‹¼éŸ³é¼æ¥·-ç®€", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                case 'pingxianzhensong':
                    fontFamily = '"å±æ˜¾è‡»å®‹", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                case 'xiaobiaosong':
                    fontFamily = '"æ–¹æ­£å°æ ‡å®‹_GBK", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                case 'huosong':
                    fontFamily = '"ChillHuoSong_F", sans-serif';
                    break;
                case 'fangzhengkaiti':
                    fontFamily = '"FZKaiS-Extended", "éœé¹œæ–‡æ¥·", sans-serif';
                    break;
                default:
                    fontFamily = '"éœé¹œæ–‡æ¥·", sans-serif';
            }

            document.documentElement.style.setProperty('--content-font-family', fontFamily);
            currentSettings.fontFamily = family;
            saveSettings();
        }

        // è®¾ç½®è¡Œé—´è·
        function setLineHeight(height) {
            document.documentElement.style.setProperty('--content-line-height', height.toString());
            currentSettings.lineHeight = height;
            saveSettings();
        }

        // è®¾ç½®å†…å®¹å®½åº¦
        function setContentWidth(width) {
            document.documentElement.style.setProperty('--content-max-width', width + 'px');
            currentSettings.contentWidth = width;
            saveSettings();
        }

        // ä¿å­˜è®¾ç½®åˆ°localStorage
        function saveSettings() {
            localStorage.setItem('readingSettings', JSON.stringify(currentSettings));
        }

        // ä»localStorageåŠ è½½è®¾ç½®
        function loadSettings() {
            const saved = localStorage.getItem('readingSettings');
            if (saved) {
                try {
                    const savedSettings = JSON.parse(saved);
                    currentSettings = { ...defaultSettings, ...savedSettings };
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„è®¾ç½®å¤±è´¥:', error);
                    currentSettings = { ...defaultSettings };
                }
            } else {
                currentSettings = { ...defaultSettings };
            }

            console.log('åŠ è½½çš„è®¾ç½®:', currentSettings);

            // åº”ç”¨è®¾ç½®
            applySettings();

            // æ›´æ–°UI
            updateSettingsUI();
        }

        // åº”ç”¨æ‰€æœ‰è®¾ç½®
        function applySettings() {
            setBackgroundColor(currentSettings.backgroundColor);
            setFontSize(currentSettings.fontSize);
            setFontFamily(currentSettings.fontFamily);
            setLineHeight(currentSettings.lineHeight);
            setContentWidth(currentSettings.contentWidth);
        }

        // æ›´æ–°è®¾ç½®UI
        function updateSettingsUI() {
            // æ›´æ–°é¢œè‰²é€‰æ‹©
            updateColorSelection(currentSettings.backgroundColor);

            // æ›´æ–°æ»‘å—å€¼
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            if (fontSizeSlider && fontSizeValue) {
                fontSizeSlider.value = currentSettings.fontSize;
                fontSizeValue.textContent = currentSettings.fontSize + 'px';
            }

            // æ›´æ–°å­—ä½“é€‰æ‹©
            const fontFamilySelect = document.getElementById('font-family-select');
            if (fontFamilySelect) {
                console.log('å½“å‰å­—ä½“è®¾ç½®:', currentSettings.fontFamily);
                fontFamilySelect.value = currentSettings.fontFamily || 'wenkai';
                console.log('è®¾ç½®åçš„é€‰æ‹©å€¼:', fontFamilySelect.value);
            }

            // æ›´æ–°è¡Œé—´è·
            const lineHeightSlider = document.getElementById('line-height-slider');
            const lineHeightValue = document.getElementById('line-height-value');
            if (lineHeightSlider && lineHeightValue) {
                lineHeightSlider.value = currentSettings.lineHeight;
                lineHeightValue.textContent = currentSettings.lineHeight.toString();
            }

            // æ›´æ–°å†…å®¹å®½åº¦
            const contentWidthSlider = document.getElementById('content-width-slider');
            const contentWidthValue = document.getElementById('content-width-value');
            if (contentWidthSlider && contentWidthValue) {
                contentWidthSlider.value = currentSettings.contentWidth;
                contentWidthValue.textContent = currentSettings.contentWidth + 'px';
            }
        }

        // é‡ç½®è®¾ç½®
        function resetSettings() {
            if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
                currentSettings = { ...defaultSettings };
                applySettings();
                updateSettingsUI();
                saveSettings();
            }
        }

        // ===== å…¶ä»–åŠŸèƒ½ =====

        document.addEventListener("DOMContentLoaded", function () {
            init();
            loadSettings(); // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„è®¾ç½®
        });
    </script>
</body>

</html>